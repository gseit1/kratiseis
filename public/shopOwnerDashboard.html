<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shop Owner Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- Optional: add your Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital@0;1&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #8e44ad, #3498db);
      color: #fff;
      padding-top: 80px; /* to account for fixed navbar */
      margin: 0;
    }
    .navbar-custom {
      background: rgba(0, 0, 0, 0.85);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    }
    .navbar-brand {
      font-family: 'Lora', serif;
      font-size: 1.8rem;
      font-weight: 600;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.7s ease-in-out;
      margin-bottom: 40px;
    }
    .btn {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-radius: 30px;
      font-weight: 500;
    }
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
    }
    .list-group-item {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      transition: background 0.4s ease;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .list-group-item:hover {
      background: rgba(255, 255, 255, 0.4);
    }
    .card {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
    }
    .card-header {
      font-family: 'Lora', serif;
      font-size: 1.3rem;
      border-bottom: 2px dashed rgba(255, 255, 255, 0.4);
      background: transparent;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0px); }
    }
    /* Anchor sections styling */
    section {
      padding-top: 60px;
      margin-top: -60px;
    }
    /* Ensure canvas container has fixed height */
    #reservationChart {
      height: 300px !important;
    }
  </style>
</head>
<body>
  <!-- Fixed NavBar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#tableOptions">Table Options</a></li>
          <li class="nav-item"><a class="nav-link" href="#generalShopDetails">General Shop Details</a></li>
          <li class="nav-item"><a class="nav-link" href="#bookingHours">Booking Hours</a></li>
          <li class="nav-item"><a class="nav-link" href="#reservations">Reservations</a></li>
          <li class="nav-item"><a class="nav-link" href="#availability">Availability</a></li>
          <li class="nav-item"><a class="nav-link" href="#charts">Reservations Chart</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Table Options Section -->
  <section id="tableOptions">
    <div class="container mt-5">
      <h1>Shop Owner Dashboard</h1>
      <p id="shopIdDisplay"></p>
      <div class="mb-4">
        <button id="addTableBtn" class="btn btn-primary me-2">Add Table</button>
        <button id="editTableBtn" class="btn btn-secondary me-2">Edit Table</button>
        <button id="deleteTableBtn" class="btn btn-danger">Delete Table</button>
      </div>
      <h3>Your Tables</h3>
      <div id="tableList" class="list-group"></div>
    </div>
  </section>

  <!-- Section: My Profile -->
<section id="myProfile">
  <div class="container mt-5">
    <h2>My Profile</h2>
    <form id="profileForm">
      <div class="mb-3">
        <label class="form-label">Name</label>
        <input type="text" id="userName" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label class="form-label">Surname</label>
        <input type="text" id="userSurname" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" id="userEmail" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label class="form-label">Role</label>
        <input type="text" id="userRole" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label class="form-label">Shop ID</label>
        <input type="text" id="userShopId" class="form-control" disabled>
      </div>
    </form>
  </div>
</section>

 <!-- Section A: General Shop Details Form -->
<section id="generalShopDetails">
  <div class="container mt-5">
    <h2>General Shop Details</h2>
    <form id="generalShopForm">
      <div class="mb-3">
        <label class="form-label">Shop Name</label>
        <input type="text" id="shopName" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label class="form-label">Description</label>
        <textarea id="shopDescription" class="form-control" rows="3" disabled></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Phone</label>
        <input type="text" id="shopPhone" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label class="form-label">City</label>
        <input type="text" id="shopCity" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label class="form-label">Region</label>
        <input type="text" id="shopRegion" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label class="form-label">Category</label>
        <input type="text" id="shopCategory" class="form-control" disabled>
      </div>
      <div class="mb-3">
        <label class="form-label">Opening Hours</label>
        <div id="shopOpeningHours" class="border p-3 rounded bg-light text-dark"></div>
      </div>
      <button type="button" id="editGeneralBtn" class="btn btn-warning">Edit General Details</button>
      <button type="button" id="saveGeneralBtn" class="btn btn-success" style="display:none;">Save General Details</button>
    </form>
  </div>
</section>





<!-- Section: Photo Management -->
<section id="photoManagement" class="mt-5">
  <div class="container">
    <h2>Photo Management</h2>
    <div class="mb-3">
      <button id="addPhotoBtn" class="btn btn-primary">Add Photo</button>
    </div>
    <div id="photoGallery" class="d-flex flex-wrap gap-3"></div>
  </div>

  <!-- Modal for Viewing Photos -->
  <div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="photoModalLabel">Photo Viewer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="modalPhoto" src="" alt="Photo" class="img-fluid">
        </div>
        <div class="modal-footer">
          <button id="prevPhotoBtn" class="btn btn-secondary">Previous</button>
          <button id="nextPhotoBtn" class="btn btn-secondary">Next</button>
          <button id="deletePhotoBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>
</section>












  <!-- Section B: Booking Hours Form -->
  <section id="bookingHours">
    <div class="container mt-5">
      <h2>Booking Hours</h2>
      <div id="bookingHoursSection"></div>
      <button type="button" id="editBookingBtn" class="btn btn-warning">Edit Booking Hours</button>
      <button type="button" id="saveBookingBtn" class="btn btn-success" style="display:none;">Save Booking Hours</button>
    </div>
  </section>

  <!-- Updated Reservations Section -->
  <section id="reservations">
    <div class="container mt-5">
      <h2>Reservations</h2>
      <!-- Scrollable list of days -->
      <div id="reservationsDaysList" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;"></div>
      <!-- Container for reservations for the selected day -->
      <div id="reservationsList" class="row gy-3"></div>
    </div>
  </section>

  <!-- New Section: Availability with calendar -->
  <section id="availability">
    <div class="container mt-5">
      <h2>Availability</h2>
      <form id="availabilityForm" class="row">
        <div class="col-md-4 mb-3">
           <label for="dateString" class="form-label">Date</label>
           <input type="date" id="dateString" class="form-control">
        </div>
        <div class="col-md-4 mb-3">
           <label for="seatsRequired" class="form-label">Seats Required</label>
           <input type="number" id="seatsRequired" class="form-control" min="1">
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
           <button type="button" id="checkAvailabilityBtn" class="btn btn-primary">Check Availability</button>
        </div>
      </form>
      <div id="availabilitySection" class="mt-3"></div>
    </div>
  </section>

  <!-- New Section: Reservations Chart -->
  <section id="charts">
    <div class="container mt-5">
      <h2>Reservations Chart</h2>
      <canvas id="reservationChart" width="400" height="200"></canvas>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
   // Get shopId from URL parameters or localStorage
const urlParams = new URLSearchParams(window.location.search);
let shopId = urlParams.get('shop_id') || localStorage.getItem('shopId');

// Έλεγχος αν το shopId είναι null ή undefined
if (!shopId || shopId === 'null' || shopId === 'undefined') {
  alert("Shop ID is missing. Redirecting to create shop page.");
  window.location.href = 'createShop.html';
} else {
  // Αποθήκευση του shopId στο localStorage για μελλοντική χρήση
  localStorage.setItem('shopId', shopId);
}
     
    const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];

    // ------------------------------
    // Table Options Section (Fetching Tables)
    // ------------------------------
    async function fetchTables() {
      try {
        const response = await fetch(`/api/shop/${shopId}/tables`);
        if (!response.ok) throw new Error("Failed to fetch tables");
        const tables = await response.json();
        displayTables(tables);
      } catch (error) {
        console.error("Error fetching tables:", error);
      }
    }
    function displayTables(tables) {
      const tableList = document.getElementById("tableList");
      tableList.innerHTML = "";
      tables.forEach(table => {
        const item = document.createElement("div");
        item.className = "list-group-item d-flex justify-content-between align-items-center";
        item.innerHTML = `
          <div><strong>Table:</strong> ${table.tableNumber} | <strong>Seats:</strong> ${table.seats}</div>
          <div>
            <button class="btn btn-sm btn-secondary me-2" onclick="editTable('${table._id}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteTable('${table._id}')">Delete</button>
          </div>
        `;
        tableList.appendChild(item);
      });
    }
    document.getElementById("addTableBtn").addEventListener("click", () => {
      window.location.href = `createTable.html?shop_id=${shopId}`;
    });
    window.editTable = function(tableId) {
      window.location.href = `editTable.html?shop_id=${shopId}&table_id=${tableId}`;
    };
    window.deleteTable = async function(tableId) {
      if (confirm("Are you sure you want to delete this table?")) {
        try {
          const response = await fetch(`/api/table/${tableId}`, { method: "DELETE" });
          const result = await response.json();
          if (response.ok) {
            alert("Table deleted successfully");
            fetchTables();
          } else {
            alert("Error deleting table: " + result.message);
          }
        } catch (error) {
          console.error("Error deleting table:", error);
        }
      }
    };
    fetchTables();

    // ------------------------------
    // Section A: General Shop Details
    // ------------------------------
    async function fetchGeneralDetails() {
  try {
    const response = await fetch(`/api/shop/${shopId}`);
    if (!response.ok) throw new Error("Failed to fetch shop details");
    const shop = await response.json();

    // Update the fields with the populated data
    document.getElementById("shopName").value = shop.shopName || 'N/A';
    document.getElementById("shopDescription").value = shop.shopDescription || 'N/A';
    document.getElementById("shopPhone").value = shop.phone || 'N/A';
    document.getElementById("shopCity").value = shop.city?.name || 'N/A'; // Use the populated city name
    document.getElementById("shopRegion").value = shop.region?.name || 'N/A'; // Use the populated region name
    document.getElementById("shopCategory").value = shop.category?.name || 'N/A'; // Use the populated category name

    // Display opening hours
    const openingHoursDiv = document.getElementById("shopOpeningHours");
    openingHoursDiv.innerHTML = Object.entries(shop.openingHours || {})
      .map(([day, hours]) => `
        <p>
          <strong>${day.charAt(0).toUpperCase() + day.slice(1)}:</strong> 
          ${hours.isOpen ? `${hours.open}:00 - ${hours.close}:00` : 'Closed'}
        </p>
      `)
      .join('');
  } catch (error) {
    console.error("Error fetching general shop details:", error);
  }
}
    fetchGeneralDetails();




    
    document.getElementById("editGeneralBtn").addEventListener("click", () => {
      ["shopName","shopDescription","shopPhone","shopCity","shopRegion","shopCategory"].forEach(id => {
        document.getElementById(id).disabled = false;
      });
      document.getElementById("saveGeneralBtn").style.display = "inline-block";
      document.getElementById("editGeneralBtn").style.display = "none";
    });
    document.getElementById("saveGeneralBtn").addEventListener("click", async () => {
      const updatedGeneral = {
        shopName: document.getElementById("shopName").value,
        shopDescription: document.getElementById("shopDescription").value,
        phone: document.getElementById("shopPhone").value,
        city: document.getElementById("shopCity").value,
        region: document.getElementById("shopRegion").value,
        category: document.getElementById("shopCategory").value,
      };
      try {
        const response = await fetch(`/api/shop/${shopId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedGeneral)
        });
        if (!response.ok) {
          const err = await response.json();
          alert("Error updating shop: " + err.message);
          return;
        }
        alert("General shop details updated successfully!");
        ["shopName","shopDescription","shopPhone","shopCity","shopRegion","shopCategory"].forEach(id => {
          document.getElementById(id).disabled = true;
        });
        document.getElementById("saveGeneralBtn").style.display = "none";
        document.getElementById("editGeneralBtn").style.display = "inline-block";
      } catch (error) {
        console.error("Error updating general shop details:", error);
      }
    });









    let photos = []; // Array to store photo URLs
let currentPhotoIndex = 0;

async function fetchPhotos() {
  try {
    const response = await fetch(`/api/shop/${shopId}/photos`);
    if (!response.ok) throw new Error('Failed to fetch images');
    photos = await response.json(); // `photos` now contains the `images` array
    displayPhotos();
  } catch (error) {
    console.error('Error fetching images:', error);
  }
}

// Display photos in the gallery
function displayPhotos() {
  const photoGallery = document.getElementById('photoGallery');
  photoGallery.innerHTML = '';
  photos.forEach((photo, index) => {
    const img = document.createElement('img');
    img.src = photo;
    img.alt = `Photo ${index + 1}`;
    img.className = 'img-thumbnail';
    img.style.width = '150px';
    img.style.cursor = 'pointer';
    img.addEventListener('click', () => openPhotoModal(index));
    photoGallery.appendChild(img);
  });
}

// Open the photo modal
function openPhotoModal(index) {
  currentPhotoIndex = index;
  document.getElementById('modalPhoto').src = photos[currentPhotoIndex];
  const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));
  photoModal.show();
}

// Handle next photo
document.getElementById('nextPhotoBtn').addEventListener('click', () => {
  currentPhotoIndex = (currentPhotoIndex + 1) % photos.length;
  document.getElementById('modalPhoto').src = photos[currentPhotoIndex];
});

// Handle previous photo
document.getElementById('prevPhotoBtn').addEventListener('click', () => {
  currentPhotoIndex = (currentPhotoIndex - 1 + photos.length) % photos.length;
  document.getElementById('modalPhoto').src = photos[currentPhotoIndex];
});

// Handle delete photo
document.getElementById('deletePhotoBtn').addEventListener('click', async () => {
  const photoToDelete = photos[currentPhotoIndex];
  try {
    const response = await fetch(`/api/shop/${shopId}/photos`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ photo: photoToDelete }),
    });
    if (!response.ok) throw new Error('Failed to delete photo');
    alert('Photo deleted successfully!');
    photos.splice(currentPhotoIndex, 1);
    displayPhotos();
    const photoModal = bootstrap.Modal.getInstance(document.getElementById('photoModal'));
    photoModal.hide();
  } catch (error) {
    console.error('Error deleting photo:', error);
  }
});

// Handle add photo
document.getElementById('addPhotoBtn').addEventListener('click', async () => {
  const photoInput = document.createElement('input');
  photoInput.type = 'file';
  photoInput.accept = 'image/*';
  photoInput.addEventListener('change', async () => {
    const file = photoInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('photo', file);

    try {
      const response = await fetch(`/api/shop/${shopId}/photos`, {
        method: 'POST',
        body: formData,
      });
      if (!response.ok) throw new Error('Failed to upload photo');
      const newPhoto = await response.json();
      photos.push(newPhoto.url);
      displayPhotos();
    } catch (error) {
      console.error('Error uploading photo:', error);
    }
  });
  photoInput.click();
});

// Fetch photos on page load
fetchPhotos();











    

    // ------------------------------
    // Section B: Booking Hours
    // ------------------------------
    async function fetchBookingHours() {
      try {
        const response = await fetch(`/api/shop/${shopId}`);
        if (!response.ok) throw new Error("Failed to fetch shop details");
        const shop = await response.json();
        const bookingSection = document.getElementById("bookingHoursSection");
        bookingSection.innerHTML = "";
        days.forEach(day => {
          const dayData = shop.openingHours && shop.openingHours[day] ? shop.openingHours[day] : { bookingStart: 0, bookingEnd: 0 };
          bookingSection.innerHTML += `
            <div class="card mb-3">
              <div class="card-header text-capitalize">${day}</div>
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <label class="form-label">Booking Start</label>
                    <input type="number" id="bookingStart_${day}" class="form-control" value="${dayData.bookingStart}" disabled>
                  </div>
                  <div class="col">
                    <label class="form-label">Booking End</label>
                    <input type="number" id="bookingEnd_${day}" class="form-control" value="${dayData.bookingEnd}" disabled>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
      } catch (error) {
        console.error("Error fetching booking hours:", error);
      }
    }
    fetchBookingHours();

    document.getElementById("editBookingBtn").addEventListener("click", () => {
      days.forEach(day => {
        const startInput = document.getElementById(`bookingStart_${day}`);
        const endInput = document.getElementById(`bookingEnd_${day}`);
        if(startInput) startInput.disabled = false;
        if(endInput) endInput.disabled = false;
      });
      document.getElementById("saveBookingBtn").style.display = "inline-block";
      document.getElementById("editBookingBtn").style.display = "none";
    });
    document.getElementById("saveBookingBtn").addEventListener("click", async () => {
      for (const day of days) {
        const newBookingStart = parseFloat(document.getElementById(`bookingStart_${day}`).value) || 0;
        const newBookingEnd = parseFloat(document.getElementById(`bookingEnd_${day}`).value) || 0;
        const bookingBody = { day, newBookingStart, newBookingEnd };
        try {
          const bkResponse = await fetch(`/api/shop/${shopId}/booking-hours`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(bookingBody)
          });
          if (!bkResponse.ok) {
            const bkErr = await bkResponse.json();
            alert(`Error updating booking hours for ${day}: ${bkErr.message}`);
          }
        } catch (error) {
          console.error(`Error updating booking hours for ${day}:`, error);
        }
      }
      alert("Booking hours updated successfully!");
      days.forEach(day => {
        const startInput = document.getElementById(`bookingStart_${day}`);
        const endInput = document.getElementById(`bookingEnd_${day}`);
        if(startInput) startInput.disabled = true;
        if(endInput) endInput.disabled = true;
      });
      document.getElementById("saveBookingBtn").style.display = "none";
      document.getElementById("editBookingBtn").style.display = "inline-block";
      fetchBookingHours();
    });

    // ------------------------------
    // Group reservations by ISO date (YYYY-MM-DD)
    function groupReservationsByDate(reservationsArray) {
      const grouped = {};
      reservationsArray.forEach(reservation => {
        if (reservation.reservationDate) {
          const dateKey = new Date(reservation.reservationDate).toISOString().split('T')[0];
          if (!grouped[dateKey]) {
            grouped[dateKey] = [];
          }
          grouped[dateKey].push(reservation);
        }
      });
      return grouped;
    }

    // Helper to format a date (ISO string) as "dd-mm-yy"
    function formatDate_dd_mm_yy(isoDateStr) {
      const dateObj = new Date(isoDateStr);
      const dd = String(dateObj.getDate()).padStart(2, '0');
      const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
      const yy = String(dateObj.getFullYear()).slice(-2);
      return `${dd}-${mm}-${yy}`;
    }

    // Helper to get the day of the week from an ISO date (YYYY-MM-DD)
    function getDayOfWeek(isoDateStr) {
      const dateObj = new Date(isoDateStr);
      const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      return days[dateObj.getDay()];
    }

    // Render the scrollable list of reservation days
    function renderDaysList(groupedReservations) {
      const daysListDiv = document.getElementById("reservationsDaysList");
      daysListDiv.innerHTML = "";
      const sortedDates = Object.keys(groupedReservations).sort(); // ascending order
      sortedDates.forEach(dateKey => {
        const formattedDate = formatDate_dd_mm_yy(dateKey);
        const dayOfWeek = getDayOfWeek(dateKey);
        const btn = document.createElement("button");
        btn.className = "list-group-item list-group-item-action";
        btn.textContent = `${formattedDate} - ${dayOfWeek}`;
        btn.onclick = function() {
          renderReservationsForDay(groupedReservations[dateKey]);
        };
        daysListDiv.appendChild(btn);
      });
    }

    // Render reservations for a specific day
    function renderReservationsForDay(reservationsArray) {
      const reservationsListDiv = document.getElementById("reservationsList");
      reservationsListDiv.innerHTML = "";
      if (reservationsArray.length === 0) {
        reservationsListDiv.innerHTML = "<p class='text-center'>No reservations for this day.</p>";
        return;
      }
      reservationsArray.forEach(reservation => {
        reservationsListDiv.innerHTML += `
          <div class="col-md-4">
            <div class="card mb-3">
              <div class="card-header">Reservation #${reservation._id}</div>
              <div class="card-body">
                <p><strong>Customer:</strong> ${reservation.userId || "N/A"}</p>
                <p><strong>Table:</strong> ${reservation.tableId || "N/A"}</p>
                <p><strong>Date:</strong> ${reservation.reservationDate ? new Date(reservation.reservationDate).toLocaleDateString() : "N/A"}</p>
                <p><strong>Time:</strong> ${reservation.reservationTime || "N/A"}</p>
                <p><strong>Status:</strong> ${reservation.status || "N/A"}</p>
                <button class="btn btn-danger btn-sm" onclick="deleteReservation('${reservation._id}')">Delete</button>
              </div>
            </div>
          </div>
        `;
      });
    }

    // Display grouped reservations once data is fetched
    function displayGroupedReservations(data) {
      let reservationsArray = [];
      if (data && data.reservationList && typeof data.reservationList === 'object') {
        for (const date in data.reservationList) {
          if (data.reservationList[date] && Array.isArray(data.reservationList[date].reservations)) {
            reservationsArray = reservationsArray.concat(data.reservationList[date].reservations);
          }
        }
      } else if (data && data.reservations && Array.isArray(data.reservations)) {
        reservationsArray = data.reservations;
      } else if (Array.isArray(data)) {
        reservationsArray = data;
      }
      const grouped = groupReservationsByDate(reservationsArray);
      renderDaysList(grouped);
      // Render the first day's reservations by default:
      const sortedDates = Object.keys(grouped).sort();
      if (sortedDates.length > 0) {
        renderReservationsForDay(grouped[sortedDates[0]]);
      } else {
        document.getElementById("reservationsList").innerHTML = "<p class='text-center'>No reservations found.</p>";
      }
    }

    // Modify your existing fetchReservations function to use the grouped display
    async function fetchReservations() {
      try {
        const response = await fetch(`/api/shop/reservationList/${shopId}`);
        if (!response.ok) throw new Error("Failed to fetch reservations");
        const reservationsData = await response.json();
        displayGroupedReservations(reservationsData);
        
        // Process data for chart (if needed) remains unchanged:
        let reservationsArray = [];
        if (reservationsData && reservationsData.reservationList && typeof reservationsData.reservationList === 'object') {
          for (const date in reservationsData.reservationList) {
            if (reservationsData.reservationList[date] && Array.isArray(reservationsData.reservationList[date].reservations)) {
              reservationsArray = reservationsArray.concat(reservationsData.reservationList[date].reservations);
            }
          }
        } else if (reservationsData && reservationsData.reservations && Array.isArray(reservationsData.reservations)) {
          reservationsArray = reservationsData.reservations;
        } else if (Array.isArray(reservationsData)) {
          reservationsArray = reservationsData;
        }
        const chartData = processReservationData(reservationsArray);
        renderReservationChart(chartData);
      } catch (error) {
        console.error("Error fetching reservations:", error);
      }
    }
    fetchReservations();

    // ------------------------------
    // Availability Section
    // ------------------------------
    async function fetchAvailability() {
      const dateString = document.getElementById('dateString').value;
      const seats = document.getElementById('seatsRequired').value;
      const shopId = new URLSearchParams(window.location.search).get('shop_id');
      try {
         const response = await fetch(`/api/availability?shopId=${shopId}&dateString=${dateString}&seats=${seats}`);
         if (!response.ok) throw new Error('Failed to fetch availability');
         const data = await response.json();
         displayAvailability(data);
      } catch (error) {
         console.error("Error fetching availability:", error);
         document.getElementById('availabilitySection').innerHTML = `<p class="text-center">Error fetching availability: ${error.message}</p>`;
      }
    }
    
    function displayAvailability(data) {
      const availabilitySection = document.getElementById('availabilitySection');
      if (data && data.availability && Array.isArray(data.availability) && data.availability.length > 0) {
         let html = `<ul class="list-group">`;
         data.availability.forEach(hour => {
            html += `<li class="list-group-item">${hour}</li>`;
         });
         html += `</ul>`;
         availabilitySection.innerHTML = html;
      } else {
         availabilitySection.innerHTML = `<p class="text-center">No availability found for selected date and seats.</p>`;
      }
    }
    document.getElementById('checkAvailabilityBtn').addEventListener('click', fetchAvailability);

    // ------------------------------
    // Charts Section
    // ------------------------------
    function processReservationData(reservationsArray) {
      const countsByDate = {};
      reservationsArray.forEach(reservation => {
        const date = reservation.reservationDate ? new Date(reservation.reservationDate).toLocaleDateString() : "N/A";
        if(date !== "N/A"){
           countsByDate[date] = (countsByDate[date] || 0) + 1;
        }
      });
      const labels = Object.keys(countsByDate);
      const data = Object.values(countsByDate);
      return { labels, data };
    }
    function renderReservationChart(chartData) {
      const ctx = document.getElementById('reservationChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Number of Reservations',
            data: chartData.data,
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } },
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    
    // In your shopOwnerDashboard.html within the <script> block:
      async function deleteReservation(reservationId) {
  if (confirm("Are you sure you want to delete this reservation?")) {
    try {
      const jwtToken = localStorage.getItem("jwtToken");
      const shopId = localStorage.getItem("shopId"); // Παίρνουμε το shopId από το localStorage
      console.log("id",shopId);

      if (!jwtToken || !shopId) {
        alert("You are not logged in. Please log in again.");
        return;
      }

      const response = await fetch(`/api/reservation/${reservationId}?shopId=${shopId}`, { 
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${jwtToken}`
        }
      });

      if (!response.ok) {
        const errorResponse = await response.json();
        alert("Error deleting reservation: " + errorResponse.message);
        return;
      }

      alert("Reservation deleted successfully!");
      fetchReservations(); // Ανανεώνουμε τη λίστα κρατήσεων
    } catch (error) {
      console.error("Error deleting reservation:", error);
      alert("Error deleting reservation. Check console for details.");
    }
  }
}

async function fetchUserProfile() {
  try {
    const jwtToken = localStorage.getItem('jwtToken');
    const userId = localStorage.getItem('userId'); // Retrieve userId from localStorage

    if (!jwtToken) {
      alert('You are not logged in. Please log in again.');
      window.location.href = 'login.html';
      return;
    }

    if (!userId) {
      alert('User ID is missing. Please log in again.');
      window.location.href = 'login.html';
      return;
    }

    // Fetch user details using the userId
    const response = await fetch(`/api/users/details/${userId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${jwtToken}`,
      },
    });

    if (!response.ok) {
      const errorResponse = await response.json();
      alert('Error fetching user profile: ' + errorResponse.message);
      return;
    }

    const user = await response.json();
    console.log('User Profile:', user);

    // Update the form fields in the My Profile section
    document.getElementById('userName').value = user.name || 'N/A';
    document.getElementById('userSurname').value = user.surname || 'N/A';
    document.getElementById('userEmail').value = user.email || 'N/A';
    document.getElementById('userRole').value = user.role || 'N/A';
    document.getElementById('userShopId').value = user.shopId || 'N/A';
  } catch (error) {
    console.error('Error fetching user profile:', error);
    alert('An error occurred while fetching your profile. Check the console for details.');
  }
}
fetchUserProfile();

  </script>
</body>
</html>