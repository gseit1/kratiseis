<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../styles/admin.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    
</head>
<style>
  /* General Styles */
body {
    background-color: #f8f9fa;
    font-family: 'Arial', sans-serif;
    color: #343a40;
    margin: 0;
    padding: 0;
}

h1, h2 {
    color: #212529;
    font-weight: bold;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Card Styles */
.card {
    background-color: #ffffff;
    border: 1px solid #ddd;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    padding: 20px;
}

/* Form Styles */
form {
    margin-bottom: 20px;
}

.form-control {
    border-radius: 5px;
    border: 1px solid #ced4da;
    padding: 10px;
}

.form-label {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
}

button {
    border-radius: 5px;
    transition: background-color 0.3s ease, transform 0.2s ease;
}

button:hover {
    transform: scale(1.02);
}

/* Button Colors */
.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: #fff;
}

.btn-primary:hover {
    background-color: #0056b3;
    border-color: #004085;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: #fff;
}

.btn-secondary:hover {
    background-color: #5a6268;
    border-color: #545b62;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: #fff;
}

.btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
}

/* List Group Styles */
.list-group-item {
    border: none;
    border-bottom: 1px solid #ddd;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.list-group-item:last-child {
    border-bottom: none;
}

/* Image Styles */
img {
    max-width: 100%;
    height: auto;
    border-radius: 5px;
}

/* Responsive Styles */
@media (max-width: 768px) {
    .btn {
        width: 100%;
        margin-bottom: 10px;
    }

    .list-group-item {
        flex-direction: column;
        align-items: flex-start;
    }

    .list-group-item div {
        margin-bottom: 10px;
    }
}
</style>

<body>
    <div class="container mt-5">
        <h1 class="text-center">Admin Panel</h1>
        
        <!-- Categories Section -->
        <div class="mb-4">
            <h2>Categories</h2>
            <form id="addCategoryForm" enctype="multipart/form-data">
                <div class="mb-2">
                  <input type="text" id="categoryName" class="form-control" placeholder="Category Name" required>
                </div>
                <div class="mb-2">
                  <input type="file" id="categoryImage" name="image" class="form-control" accept="image/*" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Category</button>
              </form>            <ul id="categoryList" class="list-group">
                <!-- Categories will be dynamically inserted here -->
            </ul>
        </div>
        
        
        <!-- Edit Category Section -->
<div id="editCategorySection" class="mt-5" style="display: none;">
  <h2>Edit Category</h2>
  <form id="editCategoryForm" enctype="multipart/form-data">
    <div class="mb-2">
      <label for="editCategoryName" class="form-label">New Category Name</label>
      <input type="text" id="editCategoryName" class="form-control" placeholder="Enter new category name" required>
    </div>
    <div class="mb-2">
      <label for="editCategoryImage" class="form-label">New Category Image</label>
      <input type="file" id="editCategoryImage" name="image" class="form-control" accept="image/*">
    </div>
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <button type="button" class="btn btn-secondary" onclick="cancelEditCategory()">Cancel</button>
  </form>
</div>

        

        <!-- Cities Section -->
        <section id="cityManagement" class="mt-5">
            <div class="container">
              <h2>City Management</h2>
              <form id="addCityForm" enctype="multipart/form-data">
                <div class="mb-2">
                  <input type="text" id="cityName" class="form-control" placeholder="City Name" required>
                </div>
                <div class="mb-2">
                  <input type="file" id="cityImage" name="image" class="form-control" accept="image/*" required>
                </div>
                <button type="submit" class="btn btn-primary">Add City</button>
              </form>
              <div id="citiesList" class="list-group"></div>
            </div>
          </section>


          <div id="editCitySection" class="mt-5" style="display: none;">
            <h2>Edit City</h2>
            <form id="editCityForm" enctype="multipart/form-data">
              <div class="mb-2">
                <label for="editCityName" class="form-label">New City Name</label>
                <input type="text" id="editCityName" class="form-control" placeholder="Enter new city name" required>
              </div>
              <div class="mb-2">
                <label for="editCityImage" class="form-label">New City Image</label>
                <input type="file" id="editCityImage" name="image" class="form-control" accept="image/*">
              </div>
              <button type="submit" class="btn btn-primary">Save Changes</button>
              <button type="button" class="btn btn-secondary" onclick="cancelEditCity()">Cancel</button>
            </form>
          </div>




        <!-- Regions Section -->
        <section id="regionManagement" class="mt-5">
            <div class="container">
              <h2>Region Management</h2>
              <form id="addRegionForm" class="mb-3">
                <div class="row">
                  <div class="col-md-6">
                    <input type="text" id="regionName" class="form-control" placeholder="Enter region name" required>
                  </div>
                  <div class="col-md-4">
                    <select id="cityFilter" class="form-select" required>
                      <option value="" disabled selected>Select a city</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Add Region</button>
                  </div>
                </div>
              </form>
              <div id="regionsList" class="list-group"></div>
            </div>
          </section>

        <!-- Attributes Section -->
        <section id="attributesManagement" class="mt-5">
            <div class="container">
              <h2>Attributes Management</h2>
              <form id="addAttributeForm" class="mb-3">
                <div class="row">
                  <div class="col-md-8">
                    <input type="text" id="attributeName" class="form-control" placeholder="Enter attribute name" required>
                  </div>
                  <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">Add Attribute</button>
                  </div>
                </div>
              </form>
              <div id="attributesList" class="list-group"></div>
            </div>
        </section>

        <!-- Applications Section -->
        <section id="applicationsManagement" class="mt-5">
            <div class="container">
              <h2>Applications Management</h2>
              <div id="applicationsList" class="list-group"></div>
              <div id="applicationDetails" class="mt-4" style="display: none;">
                <h3>Application Details</h3>
                <p><strong>Shop Name:</strong> <span id="appShopName"></span></p>
                <p><strong>Description:</strong> <span id="appShopDescription"></span></p>
                <p><strong>User:</strong> <span id="appUser"></span></p>
                <button class="btn btn-success me-2" onclick="handleApplicationDecision('accept')">Accept</button>
                <button class="btn btn-danger" onclick="handleApplicationDecision('reject')">Reject</button>
              </div>
            </div>
        </section>


                <!-- User Management Section -->
                <section id="userManagement" class="mt-5">
                    <div class="container">
                      <h2>User Management</h2>
                      <div class="btn-group mb-3" role="group" aria-label="Role Filter">
                        <button class="btn btn-primary" onclick="fetchUsersByRole('user')">Users</button>
                        <button class="btn btn-secondary" onclick="fetchUsersByRole('shopOwner')">Shop Owners</button>
                        <button class="btn btn-danger" onclick="fetchUsersByRole('admin')">Admins</button>
                      </div>
                      <div class="row">
                        <div class="col-md-4">
                          <div id="userList" class="list-group" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                        <div class="col-md-8">
                          <div id="userDetails" style="display: none;">
                            <h3>User Details</h3>
                            <p><strong>Name:</strong> <span id="userName"></span></p>
                            <p><strong>Surname:</strong> <span id="userSurname"></span></p>
                            <p><strong>Email:</strong> <span id="userEmail"></span></p>
                            <p>
                              <strong>Role:</strong>
                              <select id="userRole" class="form-select">
                                <option value="user">User</option>
                                <option value="shopOwner">Shop Owner</option>
                                <option value="admin">Admin</option>
                              </select>
                              <button id="updateRoleButton" class="btn btn-primary mt-2">Update Role</button>
                            </p>
                            <p>
                              <strong>Shop ID:</strong>
                              <input type="text" id="userShopId" class="form-control" />
                              <button id="updateShopIdButton" class="btn btn-primary mt-2">Update Shop ID</button>
                            </p>
                            <p><strong>Reservation History:</strong> <span id="userReservationHistory"></span></p>
                          </div>
                        </div>
                      </div>
                    </div>
                </section>
                
                
                <!-- Reservations Management Section -->
<section id="reservationsManagement" class="mt-5">
    <div class="container">
      <h2>Reservations Management</h2>
      <div class="row mb-3">
        <div class="col-md-6">
          <p><strong>Total Reservations:</strong> <span id="totalReservations">0</span></p>
        </div>
        <div class="col-md-6">
          <form id="reservationSearchForm" class="d-flex">
            <input type="text" id="reservationSearchInput" class="form-control me-2" placeholder="Search by Reservation ID" required>
            <button type="submit" class="btn btn-primary">Search</button>
          </form>
        </div>
      </div>
      <div id="reservationDetails" class="card mt-3" style="display: none;">
        <div class="card-body">
          <h5 class="card-title">Reservation Details</h5>
          <p><strong>Reservation ID:</strong> <span id="reservationId"></span></p>
          <p><strong>Customer:</strong> <span id="reservationCustomer"></span></p>
          <p><strong>Shop:</strong> <span id="reservationShop"></span></p>
          <p><strong>Date:</strong> <span id="reservationDate"></span></p>
          <p><strong>Time:</strong> <span id="reservationTime"></span></p>
          <p><strong>Seats:</strong> <span id="reservationSeats"></span></p>
          <p><strong>Status:</strong> <span id="reservationStatus"></span></p>
        </div>
      </div>
    </div>
  </section>




                <!-- Shop Management Section -->
                <section id="shopManagement" class="mt-5">
                    <div class="container">
                      <h2>Shop Management</h2>
                      <div class="row">
                        <div class="col-md-4">
                          <div id="shopList" class="list-group" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                        <div class="col-md-8">
                          <div id="shopDetails" style="display: none;">
                            <h3>Shop Details</h3>
                            <p><strong>Name:</strong> <span id="shopName"></span></p>
                            <p><strong>Description:</strong> <span id="shopDescription"></span></p>
                            <p><strong>Phone:</strong> <span id="shopPhone"></span></p>
                            <p><strong>City:</strong> <span id="shopCity"></span></p>
                            <p><strong>Region:</strong> <span id="shopRegion"></span></p>
                            <p><strong>Category:</strong> <span id="shopCategory"></span></p>
                            <p><strong>Music Category:</strong> <span id="shopMusicCategory"></span></p>
                            <p><strong>Price Range:</strong> <span id="shopPriceRange"></span></p>
                            <p><strong>Time Slot Split:</strong> <span id="shopTimeSlotSplit"></span></p>
                            <p><strong>Opening Hours:</strong></p>
                            <div id="shopOpeningHours"></div>
                            <p><strong>Images:</strong></p>
                            <div id="shopImages"></div>
                            <p><strong>Tables:</strong></p>
                            <div id="shopTables"></div>
                            <p><strong>Reservations:</strong></p>
                            <div id="shopReservations"></div>
                            <p><strong>Reviews:</strong></p>
                            <div id="shopReviews"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                </section>
            </div>
        
            <script src="../scripts/admin.js"></script>
        </body>
        </html>

    <script>
       async function fetchCategories() {
  try {
    const response = await fetch('/category'); // Υποθέτουμε ότι το backend επιστρέφει τις κατηγορίες
    if (!response.ok) throw new Error('Failed to fetch categories');
    const data = await response.json();

    const categoryList = document.getElementById('categoryList');
    categoryList.innerHTML = ''; // Καθαρισμός της λίστας πριν την ενημέρωση

    data.categories.forEach(category => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';

      li.innerHTML = `
        <div class="d-flex align-items-center">
          <img src="${category.image}" alt="${category.name}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
          <span>${category.name}</span>
        </div>
        <div>
          <button class="btn btn-sm btn-warning me-2" onclick="editCategory('${category._id}', '${category.name}', '${category.image}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCategory('${category._id}')">Delete</button>
        </div>
      `;

      categoryList.appendChild(li);
    });
  } catch (error) {
    console.error('Error fetching categories:', error);
  }
}


        async function fetchShops() {
  try {
    const response = await fetch('/api/shop'); // Υποθέτουμε ότι το backend έχει route για όλα τα καταστήματα
    if (!response.ok) throw new Error('Failed to fetch shops');
    const shops = await response.json();

    const shopList = document.getElementById('shopList');
    shopList.innerHTML = '';
    shops.forEach(shop => {
      const item = document.createElement('div');
      item.className = 'list-group-item list-group-item-action';
      item.innerHTML = `
        <strong>${shop.shopName}</strong> <br>
        <small>ID: ${shop._id}</small>
      `;
      item.onclick = () => fetchShopDetails(shop._id); // Κλήση για εμφάνιση λεπτομερειών
      shopList.appendChild(item);
    });
  } catch (error) {
    console.error('Error fetching shops:', error);
  }
}


async function fetchShopDetails(shopId) {
  try {
    const response = await fetch(`/api/shop/${shopId}`); // Κλήση στο backend για λεπτομέρειες καταστήματος
    if (!response.ok) throw new Error('Failed to fetch shop details');
    const shop = await response.json();

    // Ενημέρωση των στοιχείων του καταστήματος
    document.getElementById('shopName').textContent = shop.shopName;
    document.getElementById('shopDescription').textContent = shop.shopDescription;
    document.getElementById('shopPhone').textContent = shop.phone || 'N/A';
    document.getElementById('shopCity').textContent = shop.city || 'N/A';
    document.getElementById('shopRegion').textContent = shop.region || 'N/A';
    document.getElementById('shopCategory').textContent = shop.category || 'N/A';
    document.getElementById('shopMusicCategory').textContent = shop.musicCategory || 'N/A';
    document.getElementById('shopPriceRange').textContent = shop.priceRange || 'N/A';
    document.getElementById('shopTimeSlotSplit').textContent = shop.timeSlotSplit || 'N/A';

    // Εμφάνιση ωρών λειτουργίας
    const openingHoursDiv = document.getElementById('shopOpeningHours');
    openingHoursDiv.innerHTML = shop.openingHours
      ? Object.entries(shop.openingHours)
          .map(([day, hours]) => `
            <p>
              <strong>${day.charAt(0).toUpperCase() + day.slice(1)}:</strong> 
              ${hours.isOpen ? `${hours.open}:00 - ${hours.close}:00 (Booking: ${hours.bookingStart}:00 - ${hours.bookingEnd}:00)` : 'Closed'}
            </p>
          `)
          .join('')
      : 'No opening hours available';

    // Εμφάνιση εικόνων
    const imagesDiv = document.getElementById('shopImages');
    imagesDiv.innerHTML = shop.images.length
      ? shop.images.map(image => `<img src="${image}" alt="Shop Image" class="img-thumbnail" style="max-width: 150px; margin: 5px;">`).join('')
      : 'No images available';

    // Εμφάνιση τραπεζιών
    const tablesDiv = document.getElementById('shopTables');
    tablesDiv.innerHTML = shop.tables.length
      ? shop.tables.map(table => `<p>Table ID: ${table}</p>`).join('')
      : 'No tables available';

    // Εμφάνιση λίστας κρατήσεων
    const reservationsDiv = document.getElementById('shopReservations');
    reservationsDiv.innerHTML = shop.undefinedReservationList.length
      ? shop.undefinedReservationList.map(reservation => `<p>Reservation ID: ${reservation}</p>`).join('')
      : 'No reservations available';

    // Εμφάνιση λίστας αξιολογήσεων
    const reviewsDiv = document.getElementById('shopReviews');
    reviewsDiv.innerHTML = shop.reviewList.length
      ? shop.reviewList.map(review => `<p>Review ID: ${review}</p>`).join('')
      : 'No reviews available';

    document.getElementById('shopDetails').style.display = 'block';
  } catch (error) {
    console.error('Error fetching shop details:', error);
  }
}


async function fetchCities() {
  try {
    const response = await fetch('/city');
    if (!response.ok) throw new Error('Failed to fetch cities');
    const cities = await response.json();
    console.log('Fetched cities:', cities); // Log για έλεγχο

    const citiesList = document.getElementById('citiesList');
    citiesList.innerHTML = ''; // Καθαρισμός της λίστας πριν την ενημέρωση
    cities.forEach(city => {
      const item = document.createElement('div');
      item.className = 'list-group-item d-flex justify-content-between align-items-center';
      item.innerHTML = `
        <div>
          <span>${city.name}</span>
          <img src="${city.image}" alt="${city.name}" style="width: 50px; height: 50px; object-fit: cover; margin-left: 10px;">
        </div>
        <div>
          <button class="btn btn-sm btn-warning me-2" onclick="editCity('${city._id}', '${city.name}', '${city.image}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCity('${city._id}')">Delete</button>
        </div>
      `;
      citiesList.appendChild(item);
    });
  } catch (error) {
    console.error('Error fetching cities:', error);
  }
}

async function fetchUsersByRole(role) {
  try {
    const response = await fetch(`/api/users/filter?role=${role}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) throw new Error('Failed to fetch users by role');
    const users = await response.json();

    const userList = document.getElementById('userList');
    userList.innerHTML = '';
    users.forEach(user => {
  const item = document.createElement('div');
  item.className = 'list-group-item d-flex justify-content-between align-items-center';
  item.innerHTML = `
    <div>
      <strong>Email:</strong> ${user.email} <br>
      <strong>ID:</strong> ${user._id}
    </div>
    <div>
      <button class="btn btn-sm btn-primary me-2" onclick="fetchUserDetails('${user._id}')">View Details</button>
      <button class="btn btn-sm btn-danger" onclick="deleteUser('${user._id}', '${user.email}')">Delete</button>
    </div>
  `;
  userList.appendChild(item);
});
  } catch (error) {
    console.error('Error fetching users by role:', error);
  }
}

async function fetchUserDetails(userId) {
  try {
    const response = await fetch(`/api/users/details/${userId}`);
    if (!response.ok) throw new Error('Failed to fetch user details');
    const user = await response.json();

    document.getElementById('userName').textContent = user.name;
    document.getElementById('userSurname').textContent = user.surname;
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('userRole').value = user.role;
    document.getElementById('userShopId').value = user.shopId || '';
    document.getElementById('userReservationHistory').textContent = user.reservationHistory.join(', ');

    document.getElementById('userDetails').style.display = 'block';

    // Set up update buttons
    document.getElementById('updateRoleButton').onclick = () => updateUserRole(userId);
    document.getElementById('updateShopIdButton').onclick = () => updateUserShopId(userId);


  } catch (error) {
    console.error('Error fetching user details:', error);
  }
}




async function populateCityDropdown() {
  try {
    const response = await fetch('/city');
    if (!response.ok) throw new Error('Failed to fetch cities');
    const cities = await response.json();

    const cityFilter = document.getElementById('cityFilter');
    cityFilter.innerHTML = '<option value="" disabled selected>Select a city</option>';
    cities.forEach(city => {
      const option = document.createElement('option');
      option.value = city._id;
      option.textContent = city.name;
      cityFilter.appendChild(option);
    });
  } catch (error) {
    console.error('Error populating city dropdown:', error);
  }
}

// Fetch regions and display them
async function fetchRegions() {
  try {
    const response = await fetch('/region');
    if (!response.ok) throw new Error('Failed to fetch regions');
    const data = await response.json();

    const regionList = document.getElementById('regionsList');
    regionList.innerHTML = '';
    data.regions.forEach(region => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
        ${region.name} (City: ${region.city ? region.city.name : 'No City'})
        <div>
          <button class="btn btn-sm btn-warning" onclick="editRegion('${region._id}', '${region.name}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteRegion('${region._id}')">Delete</button>
        </div>
      `;
      regionList.appendChild(li);
    });
  } catch (error) {
    console.error('Error fetching regions:', error);
  }
}

// Populate city dropdown and fetch regions on page load

async function addCategory(event) {
  event.preventDefault();

  const formData = new FormData();
  formData.append('type', 'category');
  formData.append('name', document.getElementById('categoryName').value);
  formData.append('image', document.getElementById('categoryImage').files[0]);

  try {
    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData,
    });

    if (!response.ok) throw new Error('Failed to upload category image');
    const data = await response.json();
    alert(`Category added successfully with image: ${data.filePath}`);
  } catch (error) {
    console.error('Error adding category:', error);
    alert('Error adding category');
  }
}
        



        async function addCity(event) {
  event.preventDefault();

  const formData = new FormData();
  formData.append('type', 'city'); // Ορίζουμε τον τύπο ως "city"
  formData.append('name', document.getElementById('cityName').value); // Όνομα πόλης
  formData.append('image', document.getElementById('cityImage').files[0]); // Εικόνα πόλης

  try {
    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData,
    });

    if (!response.ok) throw new Error('Failed to upload city image');
    const data = await response.json();
    alert(`City added successfully with image: ${data.filePath}`);

    // Καθαρισμός πεδίων φόρμας
    document.getElementById('cityName').value = '';
    document.getElementById('cityImage').value = '';
    fetchCities(); // Ενημέρωση της λίστας πόλεων
  } catch (error) {
    console.error('Error adding city:', error);
    alert('Error adding city');
  }
}


document.getElementById('addCityForm').addEventListener('submit', async (event) => {
  event.preventDefault();

  const formData = new FormData();
  formData.append('name', document.getElementById('cityName').value);
  formData.append('image', document.getElementById('cityImage').files[0]);

  try {
    const response = await fetch('/city', {
      method: 'POST',
      body: formData,
    });

    if (!response.ok) throw new Error('Failed to add city');
    const data = await response.json();
    alert('City added successfully');
    fetchCities(); // Ενημέρωση της λίστας πόλεων
  } catch (error) {
    console.error('Error adding city:', error);
    alert('Error adding city');
  }
});










async function editCategory(id, name, imageUrl) {

console.log('Editing category with ID:', id);
  console.log('Current name:', name);
  console.log('Current image URL:', imageUrl);

  selectedCategoryId = id;
  document.getElementById('editCategoryName').value = name;
  document.getElementById('editCategorySection').style.display = 'block';
  
  // Αποθηκεύουμε το ID της κατηγορίας που επεξεργαζόμαστε
  selectedCategoryId = id;

  // Προσυμπληρώνουμε τα πεδία της φόρμας
  document.getElementById('editCategoryName').value = name;

  // Εμφανίζουμε τη φόρμα επεξεργασίας
  document.getElementById('editCategorySection').style.display = 'block';
}
document.getElementById('editCategoryForm').addEventListener('submit', async (event) => {
  event.preventDefault();

  console.log('Submitting editCategoryForm...');

  const name = document.getElementById('editCategoryName').value.trim();
  const imageFile = document.getElementById('editCategoryImage').files[0];

  console.log('Category Name:', name);

  if (!name) {
    alert('Category name is required');
    console.log('Category name is missing.');
    return;
  }

  const formData = new FormData();
  formData.append('name', name);

  if (imageFile) {
    formData.append('image', imageFile);
    console.log('Image File:', imageFile.name);
  } else {
    console.log('No image file selected.');
  }

  console.log('FormData entries:');
  for (let [key, value] of formData.entries()) {
    console.log(`${key}:`, value);
  }

  try {
    console.log('Sending PATCH request to backend...');
    const response = await fetch(`/category/${selectedCategoryId}`, {
      method: 'PATCH',
      body: formData,
    });

    console.log('Response status:', response.status);

    if (!response.ok) {
      const errorData = await response.json();
      console.error('Error response from backend:', errorData);
      throw new Error('Failed to edit category');
    }

    const data = await response.json();
    alert('Category updated successfully');
    console.log('Category updated successfully:', data);

    // Ενημέρωση της εικόνας και του ονόματος στη λίστα κατηγοριών
    fetchCategories();

    // Απόκρυψη της φόρμας
    document.getElementById('editCategorySection').style.display = 'none';
  } catch (error) {
    console.error('Error editing category:', error);
    alert('Error editing category');
  }
});

// Προεπισκόπηση της νέας εικόνας όταν επιλέγεται
document.getElementById('editCategoryImage').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const previewImage = document.getElementById('categoryImagePreview');
      if (!previewImage) {
        const img = document.createElement('img');
        img.id = 'categoryImagePreview';
        img.style.width = '100px';
        img.style.height = '100px';
        img.style.objectFit = 'cover';
        img.style.marginTop = '10px';
        document.getElementById('editCategoryForm').appendChild(img);
      }
      document.getElementById('categoryImagePreview').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});

function cancelEditCategory() {
  document.getElementById('editCategorySection').style.display = 'none';
  selectedCategoryId = null; // Καθαρίζουμε το επιλεγμένο ID
}



async function editCity(id, name, imageUrl) {
  // Προσυμπλήρωση της φόρμας με τα τρέχοντα δεδομένα
  document.getElementById('editCityName').value = name;
  document.getElementById('editCitySection').style.display = 'block';

  // Αποθήκευση του ID της πόλης που επεξεργάζεσαι
  selectedCityId = id;

  // Αφαίρεση προηγούμενων event listeners
  const editCityForm = document.getElementById('editCityForm');
  const newForm = editCityForm.cloneNode(true);
  editCityForm.replaceWith(newForm);

  // Προσθήκη νέου event listener
  newForm.addEventListener('submit', async (event) => {
    event.preventDefault();

    const formData = new FormData();
    formData.append('name', document.getElementById('editCityName').value);
    const imageFile = document.getElementById('editCityImage').files[0];
    if (imageFile) {
      formData.append('image', imageFile);
    }

    try {
      const response = await fetch(`/city/${selectedCityId}`, {
        method: 'PATCH',
        body: formData,
      });

      if (!response.ok) throw new Error('Failed to edit city');
      alert('City updated successfully');
      fetchCities(); // Ενημέρωση της λίστας πόλεων
      document.getElementById('editCitySection').style.display = 'none'; // Κλείσιμο της φόρμας
    } catch (error) {
      console.error('Error editing city:', error);
      alert('Error editing city');
    }
  });
}





function cancelEditCity() {
  document.getElementById('editCitySection').style.display = 'none';
  selectedCityId = null; // Καθαρισμός του επιλεγμένου ID
}
        async function addRegion(event) {
  event.preventDefault();
  const regionName = document.getElementById('regionName').value;
  const cityId = document.getElementById('cityFilter').value;

  if (!regionName || !cityId) {
    alert('Region name and city are required');
    return;
  }

  try {
    const response = await fetch('/region', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ name: regionName, city: cityId }),
    });

    if (!response.ok) throw new Error('Failed to add region');
    document.getElementById('regionName').value = '';
    fetchRegions();
  } catch (error) {
    console.error('Error adding region:', error);
  }
}







async function editRegion(id, name) {
  const newName = prompt('Enter new region name:', name);

  if (newName && newName !== name) {
    try {
      const response = await fetch(`/region/${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: newName }),
      });

      if (!response.ok) throw new Error('Failed to edit region');
      fetchRegions(); // Ενημέρωση της λίστας μετά την επεξεργασία
    } catch (error) {
      console.error('Error editing region:', error);
    }
  }
}

        async function deleteCategory(id) {
            if (confirm('Are you sure you want to delete this category?')) {
                try {
                    await fetch(`/category/${id}`, {
                        method: 'DELETE'
                    });
                    fetchCategories();
                } catch (error) {
                    console.error('Error deleting category:', error);
                }
            }
        }

        async function deleteCity(id) {
  if (confirm('Are you sure you want to delete this city?')) {
    try {
      const response = await fetch(`/city/${id}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Failed to delete city');
      }

      fetchCities(); // Ενημέρωση της λίστας μετά τη διαγραφή
    } catch (error) {
      console.error('Error deleting city:', error.message);
      alert(`Error: ${error.message}`);
    }
  }
}
        async function deleteRegion(id) {
            if (confirm('Are you sure you want to delete this region?')) {
                try {
                    await fetch(`/region/${id}`, {
                        method: 'DELETE'
                    });
                    fetchRegions();
                } catch (error) {
                    console.error('Error deleting region:', error);
                }
            }
        }


        // Fetch and display all attributes
async function fetchAttributes() {
  try {
    const response = await fetch('/api/attributes');
    if (!response.ok) throw new Error('Failed to fetch attributes');
    const { attributes } = await response.json();

    const attributesList = document.getElementById('attributesList');
    attributesList.innerHTML = '';
    attributes.forEach(attribute => {
      const item = document.createElement('div');
      item.className = 'list-group-item d-flex justify-content-between align-items-center';
      item.innerHTML = `
        <span>${attribute.name}</span>
        <div>
          <button class="btn btn-sm btn-secondary me-2" onclick="editAttribute('${attribute._id}', '${attribute.name}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteAttribute('${attribute._id}')">Delete</button>
        </div>
      `;
      attributesList.appendChild(item);
    });
  } catch (error) {
    console.error('Error fetching attributes:', error);
  }
}

// Add a new attribute
document.getElementById('addAttributeForm').addEventListener('submit', async (event) => {
  event.preventDefault();
  const attributeName = document.getElementById('attributeName').value;

  try {
    const response = await fetch('/api/attributes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: attributeName }),
    });

    if (!response.ok) throw new Error('Failed to add attribute');
    document.getElementById('attributeName').value = '';
    fetchAttributes();
  } catch (error) {
    console.error('Error adding attribute:', error);
  }
});

// Edit an attribute
async function editAttribute(id, currentName) {
  const newName = prompt('Edit attribute name:', currentName);
  if (!newName) return;

  try {
    const response = await fetch(`/api/attributes/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: newName }),
    });

    if (!response.ok) throw new Error('Failed to edit attribute');
    fetchAttributes();
  } catch (error) {
    console.error('Error editing attribute:', error);
  }
}

// Delete an attribute
async function deleteAttribute(id) {
  if (!confirm('Are you sure you want to delete this attribute?')) return;

  try {
    const response = await fetch(`/api/attributes/${id}`, { method: 'DELETE' });
    if (!response.ok) throw new Error('Failed to delete attribute');
    fetchAttributes();
  } catch (error) {
    console.error('Error deleting attribute:', error);
  }
}

// Fetch attributes on page load
fetchAttributes();






let selectedApplicationId = null;

// Fetch and display all applications
async function fetchApplications() {
  try {
    const response = await fetch('/api/applications');
    if (!response.ok) throw new Error('Failed to fetch applications');
    const applications = await response.json();

    const applicationsList = document.getElementById('applicationsList');
    applicationsList.innerHTML = '';
    applications.forEach(app => {
      const item = document.createElement('div');
      item.className = 'list-group-item d-flex justify-content-between align-items-center';
      item.innerHTML = `
        <span>${app.shopName}</span>
        <button class="btn btn-sm btn-primary" onclick="viewApplicationDetails('${app._id}')">View Details</button>
      `;
      applicationsList.appendChild(item);
    });
  } catch (error) {
    console.error('Error fetching applications:', error);
  }
}

// View application details
async function viewApplicationDetails(applicationId) {
  try {
    const response = await fetch(`/api/applications/${applicationId}`);
    if (!response.ok) throw new Error('Failed to fetch application details');
    const application = await response.json();

    selectedApplicationId = applicationId;
    document.getElementById('appShopName').textContent = application.shopName;
    document.getElementById('appShopDescription').textContent = application.shopDescription;
    document.getElementById('appUser').textContent = `${application.userId.name} (${application.userId.email})`;
    document.getElementById('applicationDetails').style.display = 'block';
  } catch (error) {
    console.error('Error fetching application details:', error);
  }
}

// Handle application decision
async function handleApplicationDecision(decision) {
  if (!selectedApplicationId) return;

  try {
    const response = await fetch('/api/applications/handle', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ applicationId: selectedApplicationId, decision }),
    });

    if (!response.ok) throw new Error('Failed to handle application decision');
    alert(`Application ${decision}ed successfully!`);
    document.getElementById('applicationDetails').style.display = 'none';
    fetchApplications();
  } catch (error) {
    console.error('Error handling application decision:', error);
  }
}

// Fetch applications on page load
fetchApplications();


async function updateUserRole(userId) {
  try {
    const role = document.getElementById('userRole').value;

    const response = await fetch('/api/change-role', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email: document.getElementById('userEmail').textContent, newRole: role }),
    });

    if (!response.ok) throw new Error('Failed to update role');
    alert('Role updated successfully');
    fetchUsersByRole(role); // Refresh the list of users for the current role
  } catch (error) {
    console.error('Error updating role:', error);
    alert('Error updating role');
  }
}

async function updateUserShopId(userId) {
  try {
    const shopId = document.getElementById('userShopId').value;

    const response = await fetch('/api/user/shopId', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ shopId }),
    });

    if (!response.ok) throw new Error('Failed to update shop ID');
    alert('Shop ID updated successfully');
  } catch (error) {
    console.error('Error updating shop ID:', error);
    alert('Error updating shop ID');
  }
}

async function deleteUser(userId, userEmail) {
  if (confirm('Are you sure you want to delete this user?')) {
    try {
      const response = await fetch('/api/delete-user', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: userEmail }), // Στέλνουμε το email στο body
      });

      if (!response.ok) throw new Error('Failed to delete user');
      alert('User deleted successfully');
      fetchUsersByRole('user'); // Ενημέρωση της λίστας χρηστών
    } catch (error) {
      console.error('Error deleting user:', error);
      alert('Error deleting user');
    }
  }
}


// Fetch total reservations count
async function fetchTotalReservations() {
  try {
    const response = await fetch('/api/reservations/count'); // Backend route to get total reservations count
    if (!response.ok) throw new Error('Failed to fetch total reservations count');
    const { total } = await response.json();
    document.getElementById('totalReservations').textContent = total;
  } catch (error) {
    console.error('Error fetching total reservations count:', error);
  }
}

// Search reservation by ID
async function searchReservationById(event) {
  event.preventDefault();
  const reservationId = document.getElementById('reservationSearchInput').value;

  try {
    const response = await fetch(`/api/reservations/${reservationId}`); // Backend route to get reservation by ID
    if (!response.ok) throw new Error('Reservation not found');
    const reservation = await response.json();

    // Populate reservation details
    document.getElementById('reservationId').textContent = reservation._id;
    document.getElementById('reservationCustomer').textContent = reservation.userId?.name || 'N/A';
    document.getElementById('reservationShop').textContent = reservation.shopId?.shopName || 'N/A';
    document.getElementById('reservationDate').textContent = reservation.reservationDate || 'N/A';
    document.getElementById('reservationTime').textContent = reservation.reservationTime || 'N/A';
    document.getElementById('reservationSeats').textContent = reservation.seats || 'N/A';
    document.getElementById('reservationStatus').textContent = reservation.status || 'N/A';

    document.getElementById('reservationDetails').style.display = 'block';
  } catch (error) {
    console.error('Error fetching reservation:', error);
    alert('Reservation not found');
    document.getElementById('reservationDetails').style.display = 'none';
  }
}












// Add event listener for reservation search form
document.getElementById('reservationSearchForm').addEventListener('submit', searchReservationById);

// Fetch total reservations on page load
fetchTotalReservations();





        document.addEventListener('DOMContentLoaded', () => {
            fetchCategories();
            fetchCities();
            fetchRegions();
            populateCityDropdown();
            fetchUsersByRole('user');
            fetchShops(); // Φόρτωση καταστημάτων

            
            //document.getElementById('addCityForm').addEventListener('submit', addCity);
        document.getElementById('addCategoryForm').addEventListener('submit', addCategory);
        document.getElementById('editCategoryForm').addEventListener('submit', async (event) => {
  // Υποβολή φόρμας
});
            
         
            document.getElementById('addRegionForm').addEventListener('submit', addRegion);
        });
    </script>
</body>
</html>