<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shop Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Custom Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital@0;1&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Additional Custom Style -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f4f9;
      color: #333;
      padding-top: 20px;
    }
   .container {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  padding: 40px 30px;
}

.shop-img {
    width: 100%;
    max-height: 350px;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  p {
    font-size: 1rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  p i {
    font-size: 1.2rem;
  }

  .text-primary {
    color: #0d6efd !important;
  }

  .text-danger {
    color: #dc3545 !important;
  }

  .text-success {
    color: #198754 !important;
  }

  .text-warning {
    color: #ffc107 !important;
  }

  .text-info {
    color: #0dcaf0 !important;
  }

    h1, h3 {
      font-family: 'Lora', serif;
    }
    .shop-img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 10px;
    }
    form {
      margin-top: 20px;
    }
    #availableTimes {
      margin-top: 20px;
    }
    .btn-primary {
      background-color: #5a67d8;
      border-color: #5a67d8;
    }
    .btn-primary:hover {
      background-color: #434190;
      border-color: #434190;
    }
    
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="index.html">MyShop</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="shops.html">Shops</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="createShop.html">Create Shop</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="registerLogin.html">Register/Login</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container mt-5">
  <div class="row g-4 align-items-start">
    <!-- Left Side: Image, Name, Description -->
    <div class="col-lg-6">
      <h1 id="shopName" class="mb-3"></h1>
      <img id="shopImage" class="shop-img mb-3" alt="Shop Image">
      <p id="shopDescription" class="mb-4"></p>
      <p><i class="bi bi-telephone-fill text-primary"></i> <strong>Phone:</strong> <span id="shopPhone">N/A</span></p>
      <p><i class="bi bi-geo-alt-fill text-danger"></i> <strong>City:</strong> <span id="shopCity">N/A</span></p>
      <p><i class="bi bi-map-fill text-success"></i> <strong>Region:</strong> <span id="shopRegion">N/A</span></p>
      <p><i class="bi bi-tags-fill text-warning"></i> <strong>Category:</strong> <span id="shopCategory">N/A</span></p>
      <p><i class="bi bi-currency-dollar text-info"></i> <strong>Price Range:</strong> <span id="shopPriceRange">N/A</span></p>
    </div>

    <!-- Right Side: Opening Hours + Reservation -->
    <div class="col-lg-6">
      <div id="shopDetails" class="mb-4">
        <!-- Shop opening hours will be injected here -->
      </div>

      <!-- Reservation Search Form -->
      <h3 class="mb-3">Book a Reservation</h3>
      <form id="searchForm">
        <div class="mb-3">
          <label for="numberOfPeople" class="form-label">Number of People:</label>
          <input type="number" class="form-control" id="numberOfPeople" name="numberOfPeople" required>
        </div>
        <div class="mb-3">
          <label for="reservationDate" class="form-label">Date:</label>
          <input type="date" class="form-control" id="reservationDate" name="reservationDate" required>
        </div>
        <button type="submit" class="btn btn-primary">Search Available Times</button>
      </form>

      <!-- Available Times -->
      <div id="availableTimes" class="mt-4"></div>

      <!-- Reservation Form -->
      <form id="reservationForm" class="mt-4" style="display: none;">
        <div class="mb-3">
          <label for="userName" class="form-label">Full Name:</label>
          <input type="text" class="form-control" id="userName" name="userName" required>
        </div>
        <div class="mb-3">
          <label for="reservationTime" class="form-label">Time:</label>
          <select class="form-control" id="reservationTime" name="reservationTime" required></select>
        </div>
        <div class="mb-3">
          <label for="commentFromUser" class="form-label">Comments:</label>
          <textarea class="form-control" id="commentFromUser" name="commentFromUser" maxlength="200"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Book Reservation</button>
      </form>
    </div>
  </div>
</div>


  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6VZB+6Kk6Dv9ZZD8+ZOJZp6YbN8ZynyP+9I2Qv0P5rPp" crossorigin="anonymous"></script>
  <script>
    // Fetch shop details using shopId from URL parameters.
    async function fetchShopDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const shopId = urlParams.get('id');

      try {
        const response = await fetch(`/api/shop/${shopId}`);
        if (!response.ok) {
          throw new Error('Failed to fetch shop details');
        }
        const shop = await response.json();

        document.getElementById('shopName').textContent = shop.shopName;
        document.getElementById('shopImage').src = `${shop.images[0]}`;
        document.getElementById('shopDescription').textContent = shop.shopDescription;
        
        // Populate additional details
    document.getElementById('shopPhone').textContent = shop.phone || 'N/A';
    document.getElementById('shopCity').textContent = shop.city?.name || 'N/A';
    document.getElementById('shopRegion').textContent = shop.region?.name || 'N/A';
    document.getElementById('shopCategory').textContent = shop.category?.name || 'N/A';
    document.getElementById('shopPriceRange').textContent = shop.priceRange || 'N/A';

        const shopDetails = document.getElementById('shopDetails');
        shopDetails.innerHTML = `
  <h4 class="text-center mb-3">Opening Hours</h4>
  <table class="table table-bordered text-center">
    <thead class="table-light">
      <tr>
        <th>Day</th>
        <th>Hours</th>
      </tr>
    </thead>
    <tbody>
      ${Object.entries(shop.openingHours).map(([day, hours]) => `
        <tr>
          <td><strong>${day.charAt(0).toUpperCase() + day.slice(1)}</strong></td>
          <td>${hours.isOpen ? `${hours.open} - ${hours.close}` : '<span class="text-danger">Closed</span>'}</td>
        </tr>
      `).join('')}
    </tbody>
  </table>
`;
      } catch (error) {
        console.error('Error fetching shop details:', error);
        alert('Error fetching shop details');
      }
    }

    // Format time number into HH:MM format.
    function formatTime(time) {
      const hours = Math.floor(time);
      const minutes = Math.round((time % 1) * 60);
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    // Fetch available reservation times based on search form input.
    async function fetchAvailableTimes(event) {
      event.preventDefault();
      const urlParams = new URLSearchParams(window.location.search);
      const shopId = urlParams.get('id');
      const reservationDate = document.getElementById('reservationDate').value;
      const numberOfPeople = document.getElementById('numberOfPeople').value;

      try {
        const response = await fetch(`/api/availability?shopId=${shopId}&dateString=${reservationDate}&seats=${numberOfPeople}`);
        if (!response.ok) {
          throw new Error('Failed to fetch available times');
        }
        const result = await response.json();
        const availableTimes = result.availability;

        const availableTimesDiv = document.getElementById('availableTimes');
        if (availableTimes && availableTimes.length > 0) {
          availableTimesDiv.innerHTML = `<p class="fw-bold">Available Times:</p>
            <p>${availableTimes.map(time => formatTime(time)).join(', ')}</p>`;
          // Populate the reservationTime select element.
          const reservationTimeSelect = document.getElementById('reservationTime');
          reservationTimeSelect.innerHTML = availableTimes.map(time => `<option value="${time}">${formatTime(time)}</option>`).join('');
          // Display the reservation form.
          document.getElementById('reservationForm').style.display = 'block';
        } else {
          availableTimesDiv.innerHTML = `<p class="text-danger">No available times for the selected date and number of people.</p>`;
          document.getElementById('reservationForm').style.display = 'none';
        }
      } catch (error) {
        console.error('Error fetching available times:', error);
        alert('Error fetching available times');
      }
    }

    // Submit the reservation form.
    document.getElementById('reservationForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const urlParams = new URLSearchParams(window.location.search);
      const shopId = urlParams.get('id');

      const formData = new FormData(event.target);
      const reservationData = Object.fromEntries(formData.entries());
      reservationData.shopId = shopId;
      reservationData.reservationDate = document.getElementById('reservationDate').value;
      reservationData.numberOfPeople = document.getElementById('numberOfPeople').value;

      try {
        const response = await fetch('/api/reservations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reservationData)
        });
        const result = await response.json();
        if (response.ok) {
          alert('Reservation booked successfully!');
        } else {
          alert('Error booking reservation: ' + result.message);
        }
      } catch (error) {
        console.error('Error booking reservation:', error);
        alert('Error booking reservation');
      }
    });

    // Add event listeners.
    document.addEventListener('DOMContentLoaded', fetchShopDetails);
    document.getElementById('searchForm').addEventListener('submit', fetchAvailableTimes);
  </script>
</body>
</html>