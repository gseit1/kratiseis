<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../styles/customer.css">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" />
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Shop</title>
    <style>
        body {
            background: linear-gradient(to right, #6a11cb, #2575fc); /* Gradient background */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Arial', sans-serif;
            padding: 20px;
        }
        .container {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            padding: 30px;
            max-width: 800px;
            width: 100%;
        }
        h1 {
            text-align: center;
            color: #007bff;
            margin-bottom: 20px;
        }
        label {
            font-weight: bold;
            color: #495057;
        }
        input, textarea, select, button {
            width: 50%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        .instructions {
            text-align: center;
            margin-bottom: 20px;
            color: #6c757d;
        }
        .section-title {
            font-size: 1.5rem;
            color: #343a40;
            margin-bottom: 10px;
        }
        .opening-hours {
            margin-top: 20px;
        }
        .opening-hours label {
            display: block;
            margin-bottom: 5px;
        }
        .opening-hours input {
            display: inline-block;
            width: calc(50% - 10px);
            margin-right: 10px;
        }
        #map {
            height: 400px;
            margin-bottom: 20px;
        }

        .mapboxgl-ctrl-geocoder {
            margin: 10px auto;
            max-width: 600px;
            width: 100%;
            z-index: 1;
        }

        .geocoder-container {
            position: relative;
            z-index: 10;
            margin-bottom: -50px; /* Το search bar πάνω από τον χάρτη */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Create Shop</h1>
        <form id="createShopForm" class="mx-auto" style="max-width: 600px;">
            <div class="mb-3">
                <label for="shopName" class="form-label">Shop Name:</label>
                <input type="text" class="form-control" id="shopName" name="shopName" required>
            </div>
            <div class="mb-3">
                <label for="shopDescription" class="form-label">Description:</label>
                <textarea class="form-control" id="shopDescription" name="shopDescription" required minlength="10"></textarea>
            </div>
            <div class="mb-3">
                <label for="category" class="form-label">Category:</label>
                <select class="form-control" id="category" name="category" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="mb-3">
                <label for="city" class="form-label">City:</label>
                <select class="form-control" id="city" name="city" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="mb-3">
                <label for="region" class="form-label">Region:</label>
                <select class="form-control" id="region" name="region" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="mb-3">
                <label for="address" class="form-label">Address:</label>
                <input type="text" class="form-control" id="address" name="address" required>
            </div>
            <div class="mb-3">
                <label for="map" class="form-label">Select Location:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="geocoder" style="flex: 1;"></div> <!-- Το search bar -->
                    <select id="mapStyle" class="form-select" style="width: auto;">
                        <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                        <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
                    </select>
                </div>
                <div id="map" style="margin-top: 10px;"></div>
                <input type="hidden" id="longitude" name="longitude">
                <input type="hidden" id="latitude" name="latitude">
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">Phone:</label>
                <input type="text" class="form-control" id="phone" name="phone" required>
            </div>
            <div class="mb-3">
                <label for="priceRange" class="form-label">Price Range:</label>
                <input type="text" class="form-control" id="priceRange" name="priceRange">
            </div>
            <div class="mb-3">
                <label for="timeSlotSplit" class="form-label">Time Slot Split:</label>
                <select class="form-control" id="timeSlotSplit" name="timeSlotSplit" required>
                    <option value="15">15 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">60 minutes</option>
                </select>
            </div>
            <h3>Opening Hours:</h3>
            <div class="mb-3">
                <label for="monday" class="form-label">Monday:</label>
                <input type="checkbox" id="mondayIsOpen" name="openingHours[monday][isOpen]"> Open
                <div id="mondayFields">
                    <input type="number" class="form-control" id="mondayOpen" name="openingHours[monday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="mondayClose" name="openingHours[monday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="mondayBookingStart" name="openingHours[monday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="mondayBookingEnd" name="openingHours[monday][bookingEnd]" placeholder="Booking End">
                </div>
            </div>
                <!-- Repeat for other days... -->
                <div class="mb-3">
                    <label for="tuesday" class="form-label">Tuesday:</label>
                    <input type="checkbox" id="tuesdayIsOpen" name="openingHours[tuesday][isOpen]"> Open
                    <input type="number" class="form-control" id="tuesdayOpen" name="openingHours[tuesday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="tuesdayClose" name="openingHours[tuesday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="tuesdayBookingStart" name="openingHours[tuesday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="tuesdayBookingEnd" name="openingHours[tuesday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="wednesday" class="form-label">Wednesday:</label>
                    <input type="checkbox" id="wednesdayIsOpen" name="openingHours[wednesday][isOpen]"> Open
                    <input type="number" class="form-control" id="wednesdayOpen" name="openingHours[wednesday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="wednesdayClose" name="openingHours[wednesday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="wednesdayBookingStart" name="openingHours[wednesday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="wednesdayBookingEnd" name="openingHours[wednesday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="thursday" class="form-label">Thursday:</label>
                    <input type="checkbox" id="thursdayIsOpen" name="openingHours[thursday][isOpen]"> Open
                    <input type="number" class="form-control" id="thursdayOpen" name="openingHours[thursday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="thursdayClose" name="openingHours[thursday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="thursdayBookingStart" name="openingHours[thursday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="thursdayBookingEnd" name="openingHours[thursday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="friday" class="form-label">Friday:</label>
                    <input type="checkbox" id="fridayIsOpen" name="openingHours[friday][isOpen]"> Open
                    <input type="number" class="form-control" id="fridayOpen" name="openingHours[friday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="fridayClose" name="openingHours[friday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="fridayBookingStart" name="openingHours[friday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="fridayBookingEnd" name="openingHours[friday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="saturday" class="form-label">Saturday:</label>
                    <input type="checkbox" id="saturdayIsOpen" name="openingHours[saturday][isOpen]"> Open
                    <input type="number" class="form-control" id="saturdayOpen" name="openingHours[saturday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="saturdayClose" name="openingHours[saturday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="saturdayBookingStart" name="openingHours[saturday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="saturdayBookingEnd" name="openingHours[saturday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="sunday" class="form-label">Sunday:</label>
                    <input type="checkbox" id="sundayIsOpen" name="openingHours[sunday][isOpen]"> Open
                    <input type="number" class="form-control" id="sundayOpen" name="openingHours[sunday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="sundayClose" name="openingHours[sunday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="sundayBookingStart" name="openingHours[sunday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="sundayBookingEnd" name="openingHours[sunday][bookingEnd]" placeholder="Booking End">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Create Shop</button>
        </form>
    </div>
    <script>

document.addEventListener('DOMContentLoaded', function () {
    // Λειτουργία για εμφάνιση/απόκρυψη πεδίων ανάλογα με το isOpen
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    days.forEach(day => {
        const isOpenCheckbox = document.getElementById(`${day}IsOpen`);
        const openField = document.getElementById(`${day}Open`);
        const closeField = document.getElementById(`${day}Close`);
        const bookingStartField = document.getElementById(`${day}BookingStart`);
        const bookingEndField = document.getElementById(`${day}BookingEnd`);

        // Αρχική κατάσταση
        toggleFields(isOpenCheckbox.checked, openField, closeField, bookingStartField, bookingEndField);

        // Προσθήκη event listener για αλλαγές στο checkbox
        isOpenCheckbox.addEventListener('change', function () {
            toggleFields(isOpenCheckbox.checked, openField, closeField, bookingStartField, bookingEndField);
        });
    });

    // Συνάρτηση για εμφάνιση/απόκρυψη πεδίων
    function toggleFields(isOpen, ...fields) {
        fields.forEach(field => {
            field.style.display = isOpen ? 'block' : 'none';
            if (!isOpen) {
                field.value = ''; // Καθαρισμός τιμών αν είναι κρυφό
            }
        });
    }
});



        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Fetch categories, cities, and regions from the backend
                const [categoriesResponse, cities, regionsResponse] = await Promise.all([
                    fetch('/category').then(res => res.json()),
                    fetch('/city').then(res => res.json()),
                    fetch('/region').then(res => res.json())
                ]);

                console.log('Categories:', categoriesResponse);
                console.log('Cities:', cities);
                console.log('Regions:', regionsResponse);

                // Extract the arrays from the responses
                const categories = categoriesResponse.categories;
                const regions = regionsResponse.regions;

                // Check if the fetched data is an array
                if (!Array.isArray(categories)) {
                    throw new Error('Categories is not an array');
                }
                if (!Array.isArray(cities)) {
                    throw new Error('Cities is not an array');
                }
                if (!Array.isArray(regions)) {
                    throw new Error('Regions is not an array');
                }

                // Populate the category dropdown
                const categorySelect = document.getElementById('category');
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category._id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });

                // Populate the city dropdown
                const citySelect = document.getElementById('city');
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city._id;
                    option.textContent = city.name;
                    citySelect.appendChild(option);
                });

                // Populate the region dropdown
                const regionSelect = document.getElementById('region');
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region._id;
                    option.textContent = region.name;
                    regionSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        });

        createShopForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const formData = new FormData(createShopForm);
            const shopData = Object.fromEntries(formData.entries());

            // Ενημέρωση τοποθεσίας
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);

            if (!latitude || !longitude) {
                alert('Please select a location on the map.');
                return;
            }

            shopData.location = {
                type: 'Point',
                coordinates: [longitude, latitude],
            };

            // Δημιουργία της δομής για τα openingHours
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            shopData.openingHours = {};

            days.forEach(day => {
                const isOpen = document.getElementById(`${day}IsOpen`).checked;
                const open = parseInt(document.getElementById(`${day}Open`).value) || null;
                const close = parseInt(document.getElementById(`${day}Close`).value) || null;
                const bookingStart = parseInt(document.getElementById(`${day}BookingStart`).value) || null;
                const bookingEnd = parseInt(document.getElementById(`${day}BookingEnd`).value) || null;

                shopData.openingHours[day] = {
                    isOpen,
                    ...(isOpen && open !== null && close !== null ? { open, close } : {}),
                    ...(isOpen && bookingStart !== null && bookingEnd !== null ? { bookingStart, bookingEnd } : {})
                };
            });

            try {
                // Create shop - remove the Authorization header since the cookie will be sent automatically
                const shopResponse = await fetch('/api/shop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(shopData),
                    // Add this to ensure cookies are sent with the request
                    credentials: 'include'
                });

                if (!shopResponse.ok) {
                    const errorData = await shopResponse.json();
                    throw new Error(errorData.message || 'Failed to create shop');
                }
                
                const shopResult = await shopResponse.json();
                console.log('Shop created successfully:', shopResult);

                // Update user's shopId - also with credentials
                const shopIdResponse = await fetch('/api/user/shopId', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ shopId: shopResult.shop._id }),
                    credentials: 'include'
                });

                if (!shopIdResponse.ok) {
                    const errorData = await shopIdResponse.json();
                    throw new Error(errorData.message || 'Failed to update shop ID');
                }
                
                const shopIdResult = await shopIdResponse.json();
                console.log('Shop ID updated successfully:', shopIdResult);

                // Save shopId to localStorage for future use
                localStorage.setItem('shopId', shopResult.shop._id);

                // Redirect to the dashboard
                alert('Shop created and linked successfully! Redirecting to dashboard...');
                window.location.href = 'shopOwnerDashboard.html';
            } catch (error) {
                console.error('Error during shop creation or linking:', error);
                alert('Error: ' + error.message);
            }
        });

    document.addEventListener('DOMContentLoaded', function () {
        // Mapbox API Key
        mapboxgl.accessToken = 'pk.eyJ1IjoicGFub3UyMSIsImEiOiJjbTlzcW9uYmkwM2k4MmpzYjc5dTF6M2ZtIn0.YBe_KPam5O4bdPh2xCpMdw';

        // Αρχικοποίηση του χάρτη με default στυλ
        const map = new mapboxgl.Map({
            container: 'map', // Το div ID για τον χάρτη
            style: 'mapbox://styles/mapbox/streets-v12', // Default: Streets
            center: [23.7275, 37.9838], // Default: Αθήνα (longitude, latitude)
            zoom: 13,
        });

        // Προσθήκη ελέγχου zoom και περιστροφής
        map.addControl(new mapboxgl.NavigationControl());

        // Προσθήκη autocomplete (Mapbox Geocoder)
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Search for a location', // Placeholder για το πεδίο αναζήτησης
            countries: 'GR', // Περιορισμός στην Ελλάδα
            marker: false, // Δεν θέλουμε αυτόματο marker
        });

        // Προσθήκη του geocoder στο div "geocoder"
        document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

        // Marker για την επιλογή τοποθεσίας
        let marker;

        // Event listener για click στον χάρτη
        map.on('click', function (e) {
            const lng = e.lngLat.lng;
            const lat = e.lngLat.lat;

            // Ενημέρωση ή δημιουργία marker
            if (marker) {
                marker.setLngLat([lng, lat]);
            } else {
                marker = new mapboxgl.Marker({ draggable: true })
                    .setLngLat([lng, lat])
                    .addTo(map);
            }

            // Ενημέρωση των πεδίων φόρμας
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
        });

        // Event listener για μετακίνηση του marker
        if (marker) {
            marker.on('dragend', function () {
                const lngLat = marker.getLngLat();
                document.getElementById('latitude').value = lngLat.lat;
                document.getElementById('longitude').value = lngLat.lng;
            });
        }

        // Event listener για επιλογή τοποθεσίας από το geocoder
        geocoder.on('result', function (e) {
            const lng = e.result.center[0];
            const lat = e.result.center[1];

            // Ενημέρωση ή δημιουργία marker
            if (marker) {
                marker.setLngLat([lng, lat]);
            } else {
                marker = new mapboxgl.Marker({ draggable: true })
                    .setLngLat([lng, lat])
                    .addTo(map);
            }

            // Ενημέρωση των πεδίων φόρμας
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            // Εστίαση στον χάρτη
            map.flyTo({ center: [lng, lat], zoom: 15 });
        });

        // Αλλαγή στυλ χάρτη
        const mapStyleSelect = document.getElementById('mapStyle');
        mapStyleSelect.addEventListener('change', function () {
            map.setStyle(this.value);
        });
    });
    </script>
</body>
</html>