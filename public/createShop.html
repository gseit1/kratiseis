<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../styles/customer.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Shop</title>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Create Shop</h1>
        <form id="createShopForm" class="mx-auto" style="max-width: 600px;">
            <div class="mb-3">
                <label for="shopName" class="form-label">Shop Name:</label>
                <input type="text" class="form-control" id="shopName" name="shopName" required>
            </div>
            <div class="mb-3">
                <label for="shopDescription" class="form-label">Description:</label>
                <textarea class="form-control" id="shopDescription" name="shopDescription" required minlength="10"></textarea>
            </div>
            <div class="mb-3">
                <label for="category" class="form-label">Category:</label>
                <select class="form-control" id="category" name="category" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="mb-3">
                <label for="images" class="form-label">Images (comma-separated URLs):</label>
                <input type="text" class="form-control" id="images" name="images" required>
            </div>
            <div class="mb-3">
                <label for="city" class="form-label">City:</label>
                <select class="form-control" id="city" name="city" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="mb-3">
                <label for="region" class="form-label">Region:</label>
                <select class="form-control" id="region" name="region" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="mb-3">
                <label for="location" class="form-label">Location (longitude, latitude):</label>
                <input type="text" class="form-control" id="location" name="location" required>
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">Phone:</label>
                <input type="text" class="form-control" id="phone" name="phone" required>
            </div>
            <div class="mb-3">
                <label for="musicCategory" class="form-label">Music Category:</label>
                <input type="text" class="form-control" id="musicCategory" name="musicCategory">
            </div>
            <div class="mb-3">
                <label for="priceRange" class="form-label">Price Range:</label>
                <input type="text" class="form-control" id="priceRange" name="priceRange">
            </div>
            <div class="mb-3">
                <label for="timeSlotSplit" class="form-label">Time Slot Split:</label>
                <input type="number" class="form-control" id="timeSlotSplit" name="timeSlotSplit" required>
            </div>
            <h3>Opening Hours:</h3>
            <div id="openingHours">
                <div class="mb-3">
                    <label for="monday" class="form-label">Monday:</label>
                    <input type="checkbox" id="mondayIsOpen" name="openingHours[monday][isOpen]"> Open
                    <input type="number" class="form-control" id="mondayOpen" name="openingHours[monday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="mondayClose" name="openingHours[monday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="mondayBookingStart" name="openingHours[monday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="mondayBookingEnd" name="openingHours[monday][bookingEnd]" placeholder="Booking End">
                </div>
                <!-- Repeat for other days... -->
                <div class="mb-3">
                    <label for="tuesday" class="form-label">Tuesday:</label>
                    <input type="checkbox" id="tuesdayIsOpen" name="openingHours[tuesday][isOpen]"> Open
                    <input type="number" class="form-control" id="tuesdayOpen" name="openingHours[tuesday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="tuesdayClose" name="openingHours[tuesday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="tuesdayBookingStart" name="openingHours[tuesday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="tuesdayBookingEnd" name="openingHours[tuesday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="wednesday" class="form-label">Wednesday:</label>
                    <input type="checkbox" id="wednesdayIsOpen" name="openingHours[wednesday][isOpen]"> Open
                    <input type="number" class="form-control" id="wednesdayOpen" name="openingHours[wednesday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="wednesdayClose" name="openingHours[wednesday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="wednesdayBookingStart" name="openingHours[wednesday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="wednesdayBookingEnd" name="openingHours[wednesday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="thursday" class="form-label">Thursday:</label>
                    <input type="checkbox" id="thursdayIsOpen" name="openingHours[thursday][isOpen]"> Open
                    <input type="number" class="form-control" id="thursdayOpen" name="openingHours[thursday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="thursdayClose" name="openingHours[thursday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="thursdayBookingStart" name="openingHours[thursday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="thursdayBookingEnd" name="openingHours[thursday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="friday" class="form-label">Friday:</label>
                    <input type="checkbox" id="fridayIsOpen" name="openingHours[friday][isOpen]"> Open
                    <input type="number" class="form-control" id="fridayOpen" name="openingHours[friday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="fridayClose" name="openingHours[friday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="fridayBookingStart" name="openingHours[friday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="fridayBookingEnd" name="openingHours[friday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="saturday" class="form-label">Saturday:</label>
                    <input type="checkbox" id="saturdayIsOpen" name="openingHours[saturday][isOpen]"> Open
                    <input type="number" class="form-control" id="saturdayOpen" name="openingHours[saturday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="saturdayClose" name="openingHours[saturday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="saturdayBookingStart" name="openingHours[saturday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="saturdayBookingEnd" name="openingHours[saturday][bookingEnd]" placeholder="Booking End">
                </div>
                <div class="mb-3">
                    <label for="sunday" class="form-label">Sunday:</label>
                    <input type="checkbox" id="sundayIsOpen" name="openingHours[sunday][isOpen]"> Open
                    <input type="number" class="form-control" id="sundayOpen" name="openingHours[sunday][open]" placeholder="Open Time">
                    <input type="number" class="form-control" id="sundayClose" name="openingHours[sunday][close]" placeholder="Close Time">
                    <input type="number" class="form-control" id="sundayBookingStart" name="openingHours[sunday][bookingStart]" placeholder="Booking Start">
                    <input type="number" class="form-control" id="sundayBookingEnd" name="openingHours[sunday][bookingEnd]" placeholder="Booking End">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Create Shop</button>
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Fetch categories, cities, and regions from the backend
                const [categoriesResponse, cities, regionsResponse] = await Promise.all([
                    fetch('/category').then(res => res.json()),
                    fetch('/city').then(res => res.json()),
                    fetch('/region').then(res => res.json())
                ]);

                console.log('Categories:', categoriesResponse);
                console.log('Cities:', cities);
                console.log('Regions:', regionsResponse);

                // Extract the arrays from the responses
                const categories = categoriesResponse.categories;
                const regions = regionsResponse.regions;

                // Check if the fetched data is an array
                if (!Array.isArray(categories)) {
                    throw new Error('Categories is not an array');
                }
                if (!Array.isArray(cities)) {
                    throw new Error('Cities is not an array');
                }
                if (!Array.isArray(regions)) {
                    throw new Error('Regions is not an array');
                }

                // Populate the category dropdown
                const categorySelect = document.getElementById('category');
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category._id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });

                // Populate the city dropdown
                const citySelect = document.getElementById('city');
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city._id;
                    option.textContent = city.name;
                    citySelect.appendChild(option);
                });

                // Populate the region dropdown
                const regionSelect = document.getElementById('region');
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region._id;
                    option.textContent = region.name;
                    regionSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        });

        document.getElementById('createShopForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const shopData = Object.fromEntries(formData.entries());

            // Parse location
            const [longitude, latitude] = shopData.location.split(',').map(Number);
            shopData.location = { type: 'Point', coordinates: [longitude, latitude] };

            // Parse images
            shopData.images = shopData.images.split(',').map(url => url.trim());

            // Parse opening hours
            const openingHours = {};
            for (const day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']) {
                openingHours[day] = {
                    isOpen: document.getElementById(`${day}IsOpen`).checked,
                    open: document.getElementById(`${day}Open`).value ? Number(document.getElementById(`${day}Open`).value) : null,
                    close: document.getElementById(`${day}Close`).value ? Number(document.getElementById(`${day}Close`).value) : null,
                    bookingStart: document.getElementById(`${day}BookingStart`).value ? Number(document.getElementById(`${day}BookingStart}`).value) : null,
                    bookingEnd: document.getElementById(`${day}BookingEnd`).value ? Number(document.getElementById(`${day}BookingEnd}`).value) : null,
                };
            }
            shopData.openingHours = openingHours;

            try {
                const response = await fetch('api/shop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shopData)
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Shop created successfully!');
                } else {
                    alert('Error creating shop: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating shop');
            }
        });
    </script>
</body>
</html>