<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Shops</title>
    <link rel="stylesheet" href="/styles/searchShops.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-lg" id="navbar" style="background: rgba(30, 30, 40, 0.85); backdrop-filter: blur(8px); box-shadow: 0 4px 10px rgba(0,0,0,0.15);">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html" style="font-weight:bold;font-size:1.5rem;color:#fff;">
                <i class="bi bi-shop"></i> MyShop
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="navbarLinks">
                    <!-- Î¤Î± links Î¸Î± Î³ÎµÎ¼Î¯Î¶Î¿Ï…Î½ Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬ Î±Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î¿ login -->
                </ul>
            </div>
        </div>
    </nav>
    <style>
    #navbar .navbar-nav .nav-link {
        color: #fff !important;
        font-weight: 500;
        transition: color 0.3s, transform 0.2s;
    }
    #navbar .navbar-nav .nav-link:hover,
    #navbar .navbar-nav .nav-link:focus {
        color: #ff6ec4 !important;
        transform: scale(1.07);
    }
    #navbar .dropdown-menu {
        background: rgba(30,30,40,0.97);
    }
    #navbar .dropdown-item:hover {
        background: #ff6ec4;
        color: #fff !important;
    }

    .selected-category {
        background: #e0e0e0 !important;
        border-radius: 8px;
        transition: background 0.2s;
    }
    </style>

<!-- ğŸ–¥ï¸ Modern Layout -->
<main class="container-fluid px-0" style="background:#f7f8fa;min-height:100vh;height:100vh;">
  <div id="splitLayout" class="d-flex flex-row flex-nowrap w-100" style="height:100vh;min-height:100vh;">
    <section id="mapSection" class="position-relative flex-grow-1" style="min-width:0;transition:width 0.3s;height:100vh;max-height:100vh;">
      <div id="mapContainer" class="w-100 h-100 position-relative" style="border-radius:0 0 32px 32px;overflow:hidden;height:100vh;max-height:100vh;"></div>
      <aside id="categorySummaryContainer"
             class="summary-bar-glass position-absolute top-0 ms-5 m-3 p-2 d-flex flex-column align-items-center"
             style="z-index:10;min-width:90px;max-width:220px;">
        <!-- Dynamically inserted summary icons -->
      </aside>
    </section>
    <section id="categoriesPanel" class="flex-grow-1 bg-transparent pt-4" style="min-width:0;transition:width 0.3s;height:100vh;max-height:100vh;overflow-y:auto;">
      <!-- New right-side filter bar -->
      <div id="rightFilterBar" class="right-filter-bar mb-3 px-3 py-2 d-flex flex-wrap align-items-center gap-3" style="background:#fff;border-radius:18px;box-shadow:0 2px 12px #ff6ec422;">
        <label for="cityFilter" class="form-label mb-0 fw-semibold" style="color:#ff6ec4;">Î ÏŒÎ»Î·</label>
        <select id="cityFilter" class="form-select rounded-2" style="width:180px;max-width:220px;"></select>
       
        <input id="shopSearchInput" class="form-control" type="text" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚..." style="width:220px;max-width:260px;">
      </div>
      <div id="categoryContextHeader"
           style="display:none;font-size:1.1rem;font-weight:600;color:#7873f5;margin:18px 0 8px 0;min-height:28px;">
        <!-- Î•Î´Ï Î¸Î± Î¼Ï€Î±Î¯Î½ÎµÎ¹ Ï„Î¿ context header -->
      </div>
      <div id="categoriesContainer" class="categories-container container">
        <!-- Categories & Shops loaded dynamically -->
      </div>
    </section>
  </div>
</main>

    <script src="/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoicGFub3UyMSIsImEiOiJjbTlzcW9uYmkwM2k4MmpzYjc5dTF6M2ZtIn0.YBe_KPam5O4bdPh2xCpMdw';

        document.addEventListener('DOMContentLoaded', async () => {
            const cityFilter = document.getElementById('cityFilter');
            const topFrame = document.getElementById('mapSection');
            const categoriesContainer = document.getElementById('categoriesContainer');
            let categoryIcons = {};

            // --- ÎÎ•ÎŸ: Î‘Î½Î¬Î³Î½Ï‰ÏƒÎ· cityId Î±Ï€ÏŒ Ï„Î¿ query string ---
            function getCityIdFromQuery() {
                const params = new URLSearchParams(window.location.search);
                return params.get('cityId') || '';
            }

            // --- Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ· populateCities ÏÏƒÏ„Îµ Î½Î± ÎµÏ€Î¹Î»Î­Î³ÎµÎ¹ Ï„Î·Î½ Ï€ÏŒÎ»Î· Ï€Î¿Ï… Î®ÏÎ¸Îµ Î±Ï€ÏŒ index ---
            async function populateCities() {
                try {
                    const response = await fetch('/city');
                    if (!response.ok) throw new Error('Failed to fetch cities');
                    const cities = await response.json();

                    cityFilter.innerHTML = '<option value="" disabled selected>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏŒÎ»Î·</option>';
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city._id;
                        option.textContent = city.name;
                        cityFilter.appendChild(option);
                    });

                    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï„Î¿ cityId Î±Ï€ÏŒ Ï„Î¿ query string Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ„Î± cities
                    const initialCityId = getCityIdFromQuery();
                    let foundCity = cities.find(city => city._id === initialCityId);

                    // Î‘Î½ Î´ÎµÎ½ Î²ÏÎµÎ¸ÎµÎ¯, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ default id
                    let cityIdToUse = initialCityId;
                    if (!foundCity) {
                        cityIdToUse = '67ef5b1015e5f9c8a42e2e8b';
                        foundCity = cities.find(city => city._id === cityIdToUse);
                    }

                    if (foundCity) {
                        cityFilter.value = cityIdToUse;
                        await updateMap(cityIdToUse);
                        await updateCategories(cityIdToUse);
                    }
                    // Î‘Î½ Î´ÎµÎ½ Î²ÏÎµÎ¸ÎµÎ¯ Î¿ÏÏ„Îµ Ï„Î¿ default, Î´ÎµÎ½ ÎºÎ¬Î½ÎµÎ¹ Ï„Î¯Ï€Î¿Ï„Î± (Î¼Î­Î½ÎµÎ¹ ÏƒÏ„Î¿ "Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏŒÎ»Î·")
                } catch (error) {
                    console.error('Error populating cities:', error);
                }
            }

            // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· ÏŒÏ„Î±Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï€ÏŒÎ»Î·
            cityFilter.addEventListener('change', async () => {
                const cityId = cityFilter.value;
                if (!cityId) {
                    topFrame.innerHTML = '<h3 class="text-muted">Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€ÏŒÎ»Î· Î³Î¹Î± Î½Î± Î±Î½Î±Î¶Î·Ï„Î®ÏƒÎµÎ¹Ï‚ Î¼Î±Î³Î±Î¶Î¹Î¬</h3>';
                    categoriesContainer.innerHTML = '';
                    return;
                }
                await updateMap(cityId);
                await updateCategories(cityId);
            });

           

            async function updateMap(cityId) {
                try {
                    console.log('updateMap cityId:', cityId);

                    // Fetch ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ Î³Î¹Î± icons
                    const categoriesResponse = await fetch('/category');
                    if (!categoriesResponse.ok) throw new Error('Failed to fetch categories');
                    let categories = await categoriesResponse.json();
                    // Î‘Î½ Ï„Î¿ response ÎµÎ¯Î½Î±Î¹ object Î¼Îµ property categories, Ï€Î¬ÏÎµ Ï„Î¿ array
                    if (categories.categories) categories = categories.categories;
                    categoryIcons = {};
                    // Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ map Î³Î¹Î± ÎµÏÎºÎ¿Î»Î· Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚
                    const categoryNames = {};
                    categories.forEach(category => {
                        categoryIcons[category._id] = category.image || '/images/default-placeholder.jpg';
                        categoryNames[category._id] = category.name;
                    });

                    const cityResponse = await fetch(`/city/${cityId}`);
                    console.log('cityResponse status:', cityResponse.status);
                    const { city } = await cityResponse.json();
                    console.log('city:', city);

                    if (!city || !city.location || !city.location.coordinates || city.location.coordinates.length < 2) {
                        alert('Î— Ï€ÏŒÎ»Î· Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î­Î³ÎºÏ…ÏÎµÏ‚ ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚.');
                        return;
                    }

                    const mapShopsResponse = await fetch(`/search/city/${cityId}`);
                    console.log('mapShopsResponse status:', mapShopsResponse.status);
                    const shops = await mapShopsResponse.json();
                    console.log('shops:', shops);

                    // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï€Î»Î®Î¸Î¿Ï…Ï‚ Î¼Î±Î³Î±Î¶Î¹ÏÎ½ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±
                    const categoryCounts = {};
                    shops.forEach(shop => {
                        const categoryId = shop.category?._id || shop.category;
                        if (!categoryCounts[categoryId]) {
                            categoryCounts[categoryId] = { count: 0 };
                        }
                        categoryCounts[categoryId].count += 1;
                    });

                    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· summary bar icons & count ÎœÎ•Î¤Î‘ Ï„Î·Î½ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
                    let summaryHtml = '';
                    if (Object.keys(categoryCounts).length > 0) {
                        Object.entries(categoryCounts).forEach(([categoryId, info]) => {
                            const name = categoryNames[categoryId] || '';
                            const image = categoryIcons[categoryId] || '/images/default-placeholder.jpg';
                            summaryHtml += `
                                <div class="summary-item d-flex flex-row align-items-center mb-3" style="width: 190px;" data-category-id="${categoryId}">
                                    <span class="category-name text-start" style="font-size: 15px; font-weight: 500; color: #333; min-width: 90px; max-width: 110px; word-break: break-word; margin-right: 10px;">${name}</span>
                                    <div class="d-flex flex-column align-items-center">
                                        <img src="${image}" alt="${name}" title="${name}" style="width:48px;height:48px;object-fit:cover;border-radius:50%;border:2px solid #e74c3c;">
                                        <span class="badge bg-danger mt-1 mb-1">${info.count}</span>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· split: summary bar (floating) + map (full width)
                    const summaryContainer = document.getElementById('categorySummaryContainer');
                    summaryContainer.innerHTML = summaryHtml;

                    // --- Î’Î¬Î»Îµ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î­Î¾Ï‰ Î±Ï€ÏŒ Ï„Î·Î½ updateMap ---
                    let currentMap = null;

                    function renderMapWithShops(city, shops, categoryIcons, initialStyle = 'mapbox://styles/mapbox/satellite-streets-v12') {
                        const mapContainer = document.getElementById('mapContainer');
                        mapContainer.innerHTML = ''; // Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿ Ï€ÏÎ¹Î½ new mapboxgl.Map
                        if (window.currentMap) {
                            window.currentMap.remove();
                            window.currentMap = null;
                        }
                        mapContainer.innerHTML = '';

                        // ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î¼Îµ zoom-out
                        const startZoom = 8;
                        const targetZoom = 13;
                        const map = new mapboxgl.Map({
                            container: 'mapContainer',
                            style: initialStyle,
                            center: [city.location.coordinates[0], city.location.coordinates[1]],
                            zoom: startZoom,
                            pitch: 60,
                            bearing: -30,
                            antialias: true,
                            maxZoom: 20,
                            minZoom: 5,
                            maxPitch: 85,
                            dragRotate: true,
                            boxZoom: true,
                            fadeDuration: 250
                        });
                        window.currentMap = map;

                        // ÎŒÏ„Î±Î½ Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Ï„Î¿ style, ÎºÎ¬Î½Îµ smooth zoom-in
                        map.on('load', () => {
                            map.flyTo({
                                center: [city.location.coordinates[0], city.location.coordinates[1]],
                                zoom: Math.min(targetZoom, 11.5), // ÎœÎ·Î½ Ï€Î¬ÎµÎ¹ Ï€Î¹Î¿ ÎºÎ¿Î½Ï„Î¬ Î±Ï€ÏŒ 2km
                                speed: 1.0,
                                curve: 1.5,
                                essential: true
                            });
                        });

                        // 3D buildings
                        map.on('style.load', () => {
                            if (!map.getLayer('3d-buildings')) {
                                map.addLayer({
                                    'id': '3d-buildings',
                                    'source': 'composite',
                                    'source-layer': 'building',
                                    'filter': ['==', 'extrude', 'true'],
                                    'type': 'fill-extrusion',
                                    'minzoom': 15,
                                    'paint': {
                                        'fill-extrusion-color': '#aaa',
                                        'fill-extrusion-height': [
                                            "interpolate", ["linear"], ["zoom"],
                                            15, 0,
                                            15.05, ["get", "height"]
                                        ],
                                        'fill-extrusion-base': [
                                            "interpolate", ["linear"], ["zoom"],
                                            15, 0,
                                            15.05, ["get", "min_height"]
                                        ],
                                        'fill-extrusion-opacity': 0.7
                                    }
                                });
                            }
                        });

                        // Style switcher
                        const styleSwitcher = document.createElement('div');
                        styleSwitcher.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';
                        styleSwitcher.style.position = 'absolute';
                        styleSwitcher.style.top = '10px';
                        styleSwitcher.style.right = '10px';
                        styleSwitcher.innerHTML = `
                            <button id="streetStyleBtn" class="btn btn-light" title="Street View"><i class="bi bi-map"></i></button>
                            <button id="satelliteStyleBtn" class="btn btn-light" title="Satellite View"><i class="bi bi-globe2"></i></button>
                        `;
                        mapContainer.appendChild(styleSwitcher);

                        document.getElementById('streetStyleBtn').onclick = () => {
                            map.setStyle('mapbox://styles/mapbox/streets-v12');
                        };
                        document.getElementById('satelliteStyleBtn').onclick = () => {
                            map.setStyle('mapbox://styles/mapbox/satellite-streets-v12');
                        };

                        map.addControl(new mapboxgl.NavigationControl(), 'top-left');
                        map.addControl(new mapboxgl.ScaleControl(), 'bottom-left');
                        map.addControl(new mapboxgl.FullscreenControl(), 'top-left');

                        // Markers & popups
                        shops.forEach(shop => {
                            if (shop.location && shop.location.coordinates) {
                                const categoryId = shop.category?._id || shop.category;
                                const iconUrl = categoryIcons[categoryId] || '/images/default-placeholder.jpg';

                                const markerEl = document.createElement('div');
                                markerEl.className = 'custom-marker';
                                markerEl.style.width = '50px';
                                markerEl.style.height = '60px'; // Î»Î¯Î³Î¿ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ Î³Î¹Î± Î½Î± Ï‡Ï‰ÏÎ¬ÎµÎ¹ Î· Ï€Î¹Î½Î­Î¶Î±
                                markerEl.style.position = 'relative';
                                markerEl.style.background = 'transparent';

                                // Î•Ï€Î¬Î½Ï‰: Ï„Î¿ ÎµÎ¹ÎºÎ¿Î½Î¯Î´Î¹Î¿ Ï„Î·Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚
                                const imgEl = document.createElement('img');
                                imgEl.src = iconUrl;
                                imgEl.alt = shop.shopName;
                                imgEl.style.width = '40px';
                                imgEl.style.height = '40px';
                                imgEl.style.objectFit = 'cover';
                                imgEl.style.borderRadius = '50%';
                                imgEl.style.border = '2px solid #fff';
                                imgEl.style.background = '#222';
                                imgEl.style.position = 'absolute';
                                imgEl.style.left = '50%';
                                imgEl.style.top = '0';
                                imgEl.style.transform = 'translateX(-50%)';
                                markerEl.appendChild(imgEl);

                                // ÎšÎ¬Ï„Ï‰: SVG Ï€Î¹Î½Î­Î¶Î±
                                const pinSvg = document.createElement('div');
                                pinSvg.innerHTML = `
                                  <svg width="24" height="24" viewBox="0 0 24 24" style="display:block;margin:0 auto;">
                                    <path d="M12 2C10.067 2 8.5 3.567 8.5 5.5c0 2.485 2.5 6.5 2.5 6.5s2.5-4.015 2.5-6.5C15.5 3.567 13.933 2 12 2zm0 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zm0 17c-4.418 0-8-3.582-8-8 0-2.21 1.79-4 4-4h8c2.21 0 4 1.79 4 4 0 4.418-3.582-8-8-8z" fill="#e74c3c"/>
                                    <circle cx="12" cy="5.5" r="1.5" fill="#fff"/>
                                  </svg>
                                `;
                                pinSvg.style.position = 'absolute';
                                pinSvg.style.left = '50%';
                                pinSvg.style.bottom = '0';
                                pinSvg.style.transform = 'translateX(-50%)';
                                markerEl.appendChild(pinSvg);

                                const marker = new mapboxgl.Marker(markerEl)
                                    .setLngLat(shop.location.coordinates)
                                    .addTo(map);

                                // Popup
                                let imageUrl = shop.image || (shop.images && shop.images.length > 0 ? shop.images[0] : '/images/default-placeholder.jpg');
                                if (imageUrl.startsWith('/')) {
                                    imageUrl = `http://localhost:300${imageUrl}`;
                                }
                                let rating = typeof shop.reviewRatingAverage === 'number' && shop.reviewRatingAverage >= 0
                                    ? shop.reviewRatingAverage.toFixed(1)
                                    : 'â€”';
                                let stars = '';
                                if (typeof shop.reviewRatingAverage === 'number' && shop.reviewRatingAverage > 0) {
                                    const rounded = Math.round(shop.reviewRatingAverage);
                                    stars = 'â­'.repeat(rounded);
                                }

                                const popup = new mapboxgl.Popup({
                                    offset: 25,
                                    closeButton: true,
                                    closeOnClick: true,
                                    anchor: 'right'
                                }).setHTML(`
                                    <div class="popup-card">
                                        <img src="${imageUrl}" 
                                             alt="${shop.shopName}" 
                                             style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
                                        <h5 style="font-size: 16px; margin: 8px 0;">${shop.shopName}</h5>
                                        <p style="font-size: 14px; color: #666; margin-bottom: 8px; min-height:30px;max-height:60px;overflow:auto;">
                                            ${shop.address || ''}
                                        </p>
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="text-warning me-2">${stars}</span>
                                            <span class="text-muted">${rating}</span>
                                        </div>
                                        <button onclick="window.location.href='shop.html?id=${shop._id || shop.id}'" 
                                                class="btn btn-primary btn-sm w-100">Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚</button>
                                    </div>
                                `);

                                marker.setPopup(popup);
                            }
                        });
                    }

                    document.querySelectorAll('#categorySummaryContainer .summary-item').forEach(item => {
                        item.addEventListener('click', async function() {
                            const categoryId = this.getAttribute('data-category-id');
                            if (!categoryId) return;

                            // Î¦Î­ÏÎµ shops Î¼ÏŒÎ½Î¿ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±
                            console.log('Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:', categoryId);

                            const shopsRes = await fetch(`/search/city/${cityId}/category/${categoryId}`);
                            console.log('shopsRes status:', shopsRes.status);
                            const shops = await shopsRes.json();
                            console.log('shops Î³Î¹Î± ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:', shops);

                            // Î¦ÏŒÏÏ„Ï‰ÏƒÎµ Ï„Î¿ map ÎœÎŸÎÎŸ Î¼Îµ Î±Ï…Ï„Î¬ Ï„Î± shops
                            renderMapWithShops(city, shops, categoryIcons, 'mapbox://styles/mapbox/satellite-streets-v12');

                            // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎµ Ï„Î± shops ÎºÎ¬Ï„Ï‰ Î±Ï€ÏŒ Ï„Î¿ map (ÏŒÏ‡Î¹ grouped)
                            categoriesContainer.innerHTML = '';
                            if (shops.length === 0) {
                                categoriesContainer.innerHTML = '<p class="text-muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î± Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±.</p>';
                            } else {
                                // Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ container Î¼Îµ Î¿ÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î¿ scroll
                                const horizontalList = document.createElement('div');
                                horizontalList.className = 'horizontal-shops-list d-flex flex-row flex-nowrap overflow-auto py-2';
                                horizontalList.style.gap = '16px';

                                shops.forEach(shop => {
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'shop-card me-3';
                                    wrapper.innerHTML = createShopCard(shop);
                                    horizontalList.appendChild(wrapper);

                                    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· event listener ÏƒÏ„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "Add to Favourites"
                                    const favouriteBtn = wrapper.querySelector('.favourite-btn');
                                    if (favouriteBtn) {
                                      favouriteBtn.addEventListener('click', async (event) => {
                                        event.stopPropagation();
                                        await handleAddToFavourites(shop._id || shop.id);
                                      });
                                    }

                                    // Î“Î¹Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚"
                                    const detailsBtn = wrapper.querySelector('.shop-card-btn-fixed, .view-details');
                                    if (detailsBtn) {
                                      detailsBtn.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        window.location.href = `shop.html?id=${shop._id || shop.id}`;
                                      });
                                    }
                                });
                                categoriesContainer.appendChild(horizontalList);
                            }
                        });
                    });

                    const mapContainer = document.getElementById('mapContainer');
                    mapContainer.innerHTML = ''; // Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿ Ï€ÏÎ¹Î½ new mapboxgl.Map

                    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Mapbox map Î¼Îµ 3D, Ï‰ÏÎ±Î¯Î± Î³Ï‰Î½Î¯Î± ÎºÎ±Î¹ ÎµÏ€Î¹Î»Î¿Î³Î® ÏƒÏ„Ï…Î»
                    const map = new mapboxgl.Map({
                        container: 'mapContainer',
                        style: 'mapbox://styles/mapbox/satellite-streets-v12', // <-- SATELLITE BY DEFAULT
                        center: [city.location.coordinates[0], city.location.coordinates[1]],
                        zoom: 13,
                        pitch: 60,
                        bearing: -30,
                        antialias: true,
                        maxZoom: 20,
                        minZoom: 5,
                        maxPitch: 85,
                        dragRotate: true,
                        boxZoom: true,
                        fadeDuration: 250
                    });

                    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· 3D ÎºÏ„Î¹ÏÎ¯Ï‰Î½
                    map.on('style.load', () => {
                        if (map.getLayer('3d-buildings')) return;
                        map.addLayer({
                            'id': '3d-buildings',
                            'source': 'composite',
                            'source-layer': 'building',
                            'filter': ['==', 'extrude', 'true'],
                            'type': 'fill-extrusion',
                            'minzoom': 15,
                            'paint': {
                                'fill-extrusion-color': '#aaa',
                                'fill-extrusion-height': [
                                    "interpolate", ["linear"], ["zoom"],
                                    15, 0,
                                    15.05, ["get", "height"]
                                ],
                                'fill-extrusion-base': [
                                    "interpolate", ["linear"], ["zoom"],
                                    15, 0,
                                    15.05, ["get", "min_height"]
                                ],
                                'fill-extrusion-opacity': 0.7
                            }
                        });
                    });

                    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ ÏƒÏ„Ï…Î» (Street/Î”Î¿ÏÏ…Ï†ÏŒÏÎ¿Ï‚)
                    const styleSwitcher = document.createElement('div');
                    styleSwitcher.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';
                    styleSwitcher.style.position = 'absolute';
                    styleSwitcher.style.top = '10px';
                    styleSwitcher.style.right = '10px';
                    styleSwitcher.innerHTML = `
                        <button id="streetStyleBtn" class="btn btn-light" title="Street View"><i class="bi bi-map"></i></button>
                        <button id="satelliteStyleBtn" class="btn btn-light" title="Satellite View"><i class="bi bi-globe2"></i></button>
                    `;
                    mapContainer.appendChild(styleSwitcher);

                    document.getElementById('streetStyleBtn').onclick = () => {
                        map.setStyle('mapbox://styles/mapbox/streets-v12');
                    };
                    document.getElementById('satelliteStyleBtn').onclick = () => {
                        map.setStyle('mapbox://styles/mapbox/satellite-streets-v12');
                    };

                    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· controls
                    map.addControl(new mapboxgl.NavigationControl(), 'top-left');
                    map.addControl(new mapboxgl.ScaleControl(), 'bottom-left');
                    map.addControl(new mapboxgl.FullscreenControl(), 'top-left');

                    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· markers
                    shops.forEach(shop => {
                        if (shop.location && shop.location.coordinates) {
                            const categoryId = shop.category?._id || shop.category;
                            const iconUrl = categoryIcons[categoryId] || '/images/default-placeholder.jpg';

                            // Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ custom marker element
                            const markerEl = document.createElement('div');
                            markerEl.className = 'custom-marker';
                            markerEl.style.width = '50px';
                            markerEl.style.height = '60px'; // Î»Î¯Î³Î¿ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ Î³Î¹Î± Î½Î± Ï‡Ï‰ÏÎ¬ÎµÎ¹ Î· Ï€Î¹Î½Î­Î¶Î±
                            markerEl.style.position = 'relative';
                            markerEl.style.background = 'transparent';

                            // Î•Ï€Î¬Î½Ï‰: Ï„Î¿ ÎµÎ¹ÎºÎ¿Î½Î¯Î´Î¹Î¿ Ï„Î·Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚
                            const imgEl = document.createElement('img');
                            imgEl.src = iconUrl;
                            imgEl.alt = shop.shopName;
                            imgEl.style.width = '40px';
                            imgEl.style.height = '40px';
                            imgEl.style.objectFit = 'cover';
                            imgEl.style.borderRadius = '50%';
                            imgEl.style.border = '2px solid #fff';
                            imgEl.style.background = '#222';
                            imgEl.style.position = 'absolute';
                            imgEl.style.left = '50%';
                            imgEl.style.top = '0';
                            imgEl.style.transform = 'translateX(-50%)';
                            markerEl.appendChild(imgEl);

                            // ÎšÎ¬Ï„Ï‰: SVG Ï€Î¹Î½Î­Î¶Î±
                            const pinSvg = document.createElement('div');
                            pinSvg.innerHTML = `
                              <svg width="24" height="24" viewBox="0 0 24 24" style="display:block;margin:0 auto;">
                                <path d="M12 2C10.067 2 8.5 3.567 8.5 5.5c0 2.485 2.5 6.5 2.5 6.5s2.5-4.015 2.5-6.5C15.5 3.567 13.933 2 12 2zm0 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zm0 17c-4.418 0-8-3.582-8-8 0-2.21 1.79-4 4-4h8c2.21 0 4 1.79 4 4 0 4.418-3.582-8-8-8z" fill="#e74c3c"/>
                                <circle cx="12" cy="5.5" r="1.5" fill="#fff"/>
                              </svg>
                            `;
                            pinSvg.style.position = 'absolute';
                            pinSvg.style.left = '50%';
                            pinSvg.style.bottom = '0';
                            pinSvg.style.transform = 'translateX(-50%)';
                            markerEl.appendChild(pinSvg);

                            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± marker Î¼Îµ animation
                            const marker = new mapboxgl.Marker(markerEl)
                                .setLngLat(shop.location.coordinates)
                                .addTo(map);

                            // Î‘Î¦Î‘Î™Î¡Î•Î˜Î—ÎšÎ• Ï„Î¿ animation:
                            // markerEl.style.transition = 'transform 0.3s ease';
                            // markerEl.style.transform = 'scale(0)';
                            // setTimeout(() => {
                            //     markerEl.style.transform = 'scale(1)';
                            // }, 100);

                            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± popup
                            let imageUrl = shop.image || (shop.images && shop.images.length > 0 ? shop.images[0] : '/images/default-placeholder.jpg');
                            if (imageUrl.startsWith('/')) {
                                imageUrl = `http://localhost:300${imageUrl}`;
                            }
                            let rating = typeof shop.reviewRatingAverage === 'number' && shop.reviewRatingAverage >= 0
                                ? shop.reviewRatingAverage.toFixed(1)
                                : 'â€”';
                            let stars = '';
                            if (typeof shop.reviewRatingAverage === 'number' && shop.reviewRatingAverage > 0) {
                                const rounded = Math.round(shop.reviewRatingAverage);
                                stars = 'â­'.repeat(rounded);
                            }

                            const popup = new mapboxgl.Popup({
                                offset: 25,
                                closeButton: true,
                                closeOnClick: true,
                                anchor: 'right'
                            }).setHTML(`
                                <div class="popup-card">
                                    <img src="${imageUrl}" 
                                         alt="${shop.shopName}" 
                                         style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
                                    <h5 style="font-size: 16px; margin: 8px 0;">${shop.shopName}</h5>
                                    <p style="font-size: 14px; color: #666; margin-bottom: 8px; min-height:30px;max-height:60px;overflow:auto;">
                                        ${shop.address || ''}
                                    </p>
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="text-warning me-2">${stars}</span>
                                        <span class="text-muted">${rating}</span>
                                    </div>
                                    <button onclick="window.location.href='shop.html?id=${shop._id || shop.id}'" 
                                            class="btn btn-primary btn-sm w-100">Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚</button>
                                </div>
                            `);

                            marker.setPopup(popup);
                        }
                    });
                } catch (error) {
                    console.error('Error updating map:', error);
                }
            }

            async function updateCategories(cityId) {
                try {
                    const categoriesResponse = await fetch('/category');
                    if (!categoriesResponse.ok) throw new Error('Failed to fetch categories');
                    let categories = await categoriesResponse.json();
                    if (categories.categories) categories = categories.categories;

                    // Î¦Î­ÏÎµ Ï„Î± Ï€Î»Î®Î¸Î· Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î³Î¹Î± Ï†Î¸Î¯Î½Î¿Ï…ÏƒÎ± Ï„Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·
                    const countsRes = await fetch(`/search/city/${cityId}`);
                    const shopsForCount = await countsRes.json();
                    const catCounts = {};
                    shopsForCount.forEach(shop => {
                        const catId = shop.category?._id || shop.category;
                        catCounts[catId] = (catCounts[catId] || 0) + 1;
                    });

                    // Î¦Î­ÏÎµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î·Ï‚ Ï€ÏŒÎ»Î·Ï‚ (Î³Î¹Î± ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· ÏƒÏ„Î¿ header)
                    let cityName = '';
                    try {
                        const cityRes = await fetch(`/city/${cityId}`);
                        if (cityRes.ok) {
                            const cityData = await cityRes.json();
                            cityName = cityData.city?.name || '';
                        }
                    } catch {}

                    // Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½ ÎºÎ±Ï„Î¬ Ï†Î¸Î¯Î½Î¿Ï…ÏƒÎ± ÏƒÎµÎ¹ÏÎ¬ Ï€Î»Î®Î¸Î¿Ï…Ï‚
                    categories.sort((a, b) => (catCounts[b._id] || 0) - (catCounts[a._id] || 0));

                    categoriesContainer.innerHTML = '';
                    for (const category of categories) {
                        const categorySection = document.createElement('div');
                        categorySection.className = 'category-section mb-4';
                        categorySection.setAttribute('data-category-id', category._id);

                        // Î— context-header ÎµÎ¯Î½Î±Î¹ Î Î‘ÎÎ¤Î‘ Î¿ÏÎ±Ï„Î®, Î¼Îµ default ÎºÎµÎ¯Î¼ÎµÎ½Î¿ (Î¸Î± Î±Î»Î»Î¬Î¶ÎµÎ¹ ÏŒÏ„Î±Î½ Ï€Î±Ï„Î¹Î­Ï„Î±Î¹ Ï„Î¿ summary)
                        categorySection.innerHTML = `
                            <div class="category-header-bar">
                                <span class="category-title">${category.name}</span>
                            </div>
                            <div class="shops-horizontal-scroll-wrapper" style="display:flex;align-items:center;gap:10px;">
                                <button class="rotate-arrow rotate-left" aria-label="Rotate left">&#8592;</button>
                                <div class="shops-horizontal-scroll" style="flex:1;display:flex;overflow-x:auto;"></div>
                                <button class="rotate-arrow rotate-right" aria-label="Rotate right">&#8594;</button>
                            </div>
                        `;

                        categoriesContainer.appendChild(categorySection);

                        // Fetch shops with full details for each shop (not just summary)
                        console.log('fetching shops for', category.name, 'cityId:', cityId, 'categoryId:', category._id);
                        const shopsResponse = await fetch(`/search/city/${cityId}/category/${category._id}?details=1`);
                        console.log('shopsResponse status:', shopsResponse.status);
                        if (!shopsResponse.ok) throw new Error(`Failed to fetch shops for category ${category.name}`);
                        const shops = await shopsResponse.json();

                        let shopsArr = [...shops];

                        const shopsWrapper = categorySection.querySelector('.shops-horizontal-scroll-wrapper');
                        const shopsContainer = categorySection.querySelector('.shops-horizontal-scroll');
                        const leftArrow = categorySection.querySelector('.rotate-left');
                        const rightArrow = categorySection.querySelector('.rotate-right');

                        function renderShops() {
                            shopsContainer.innerHTML = '';
                            shopsArr.forEach(shop => {
                                // Use homepage card markup
                                const wrapper = document.createElement('div');
                                wrapper.className = 'shop-card';
                                wrapper.innerHTML = `
                                  <img src="${shop.images && shop.images[0] ? shop.images[0] : shop.image || '/images/default-placeholder.jpg'}" alt="${shop.shopName || 'Shop'}">
                                  <div class="card-body">
                                    <h6 class="card-title mb-1"><i class="bi bi-shop me-1"></i>${shop.shopName || 'Unnamed Shop'}</h6>
                                    <div class="card-text mb-1"><i class="bi bi-geo-alt me-1"></i>${shop.address || 'No location'}</div>
                                    <div class="shop-rating mb-1"><i class="bi bi-star-fill text-warning"></i> ${typeof shop.reviewRatingAverage === 'number' ? shop.reviewRatingAverage.toFixed(1) : 'â€”'}</div>
                                    <a href="shop.html?id=${shop._id || shop.id}" class="btn shop-card-btn-fixed"><i class="bi bi-box-arrow-up-right me-1"></i>Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚</a>
                                  </div>
                                `;
                                shopsContainer.appendChild(wrapper);
                            });
                        }
                        leftArrow.addEventListener('click', () => {
                            if (shopsArr.length > 1) {
                                shopsArr.push(shopsArr.shift());
                                renderShops();
                            }
                        });
                        rightArrow.addEventListener('click', () => {
                            if (shopsArr.length > 1) {
                                shopsArr.unshift(shopsArr.pop());
                                renderShops();
                            }
                        });
                        renderShops();
                    }

                    // 1. Fetch recommended Î³Î¹Î± Ï„Î·Î½ Ï€ÏŒÎ»Î·
                    const recommendedRes = await fetch(`/recommended/city/${cityId}`);
                    const recommendedShops = await recommendedRes.json();

                    if (recommendedShops.length > 0) {
                      const recommendedSection = document.createElement('div');
                      recommendedSection.className = 'recommended-section mb-4';
                      recommendedSection.innerHTML = `
                        <h5 class="mb-2" style="color:#ff9800;font-weight:700;">Î ÏÎ¿Ï„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½Î±</h5>
                        <div class="horizontal-shops-list d-flex flex-row flex-nowrap overflow-auto py-2" style="gap:16px;"></div>
                      `;
                      const recList = recommendedSection.querySelector('.horizontal-shops-list');
                      recommendedShops.forEach(shop => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'shop-card me-3';
                        wrapper.innerHTML = createShopCard(shop);
                        recList.appendChild(wrapper);
                        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· event listener ÏƒÏ„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "Add to Favourites"
                        const favouriteBtn = wrapper.querySelector('.favourite-btn');
                        if (favouriteBtn) {
                          favouriteBtn.addEventListener('click', async (event) => {
                            event.stopPropagation();
                            await handleAddToFavourites(shop._id || shop.id);
                          });
                        }
                        // Î“Î¹Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚"
                        const detailsBtn = wrapper.querySelector('.shop-card-btn-fixed, .view-details');
                        if (detailsBtn) {
                          detailsBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            window.location.href = `shop.html?id=${shop._id || shop.id}`;
                          });
                        }
                      });
                      categoriesContainer.appendChild(recommendedSection);
                    }
                } catch (error) {
                    console.error('Error updating categories:', error);
                }
            }

            // Navbar state logic (checkAuth, login/logout/profile)
            async function checkAuth() {
                try {
                    const res = await fetch('/api/check-auth', { credentials: 'include' });
                    if (!res.ok) return false;
                    const data = await res.json();
                    return !!data && !!data.isAuthenticated;
                } catch {
                    return false;
                }
            }

            function renderNavbarLinks(auth) {
                const navbarLinks = document.getElementById('navbarLinks');
                navbarLinks.innerHTML = '';
                navbarLinks.innerHTML += `
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">
                            <i class="bi bi-house-door"></i> Î‘ÏÏ‡Î¹ÎºÎ®
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="filteredShops.html">
                            <i class="bi bi-shop-window"></i> ÎœÎ±Î³Î±Î¶Î¹Î¬
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="application.html">
                            <i class="bi bi-pencil-square"></i> ÎšÎ¬Î½Îµ Î±Î¯Ï„Î·ÏƒÎ·
                        </a>
                    </li>
                `;
                if (auth) {
                    navbarLinks.innerHTML += `
                        <li class="nav-item dropdown" id="profileDropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="profileDropdownMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle"></i> ÎŸ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Î¼Î¿Ï…
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdownMenu">
                                <li>
                                    <a class="dropdown-item" href="profile.html">
                                        <i class="bi bi-person"></i> Î ÏÎ¿Ï†Î¯Î»
                                    </a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" id="logoutBtn">
                                        <i class="bi bi-box-arrow-right"></i> Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·
                                    </a>
                                </li>
                            </ul>
                        </li>
                    `;
                } else {
                    navbarLinks.innerHTML += `
                        <li class="nav-item" id="registerLoginNavItem">
                            <a class="nav-link" href="registerLogin.html">
                                <i class="bi bi-person-plus"></i> Î•Î³Î³ÏÎ±Ï†Î®/Î£ÏÎ½Î´ÎµÏƒÎ·
                            </a>
                        </li>
                    `;
                }
            }

            async function setupNavbar() {
                const auth = await checkAuth();
                renderNavbarLinks(auth);

                // Logout functionality
                setTimeout(() => {
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', () => {
                            localStorage.clear();
                            sessionStorage.clear();
                            fetch('/api/users/logout', { method: 'POST', credentials: 'include' }).finally(() => {
                                window.location.href = 'registerLogin.html';
                            });
                        });
                    }
                }, 100);
            }

            // Add to Favourites logic (filteredShops style)
            async function handleAddToFavourites(shopId) {
                try {
                    const auth = await checkAuth();
                    if (!auth) {
                        alert('Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯ÏƒÏ„Îµ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î± ÏƒÏ„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î±.');
                        return;
                    }
                    const response = await fetch('/api/users/favourites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ shopId }),
                        credentials: 'include'
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        alert(`Î£Ï†Î¬Î»Î¼Î±: ${error.message}`);
                        return;
                    }
                    alert('Î¤Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î± ÏƒÎ±Ï‚!');
                } catch (error) {
                    alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.');
                }
            }

            await populateCities();
            await setupNavbar();

            // Event delegation Î³Î¹Î± Î½Î± Î´Î¿Ï…Î»ÎµÏÎµÎ¹ ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ ÎºÎ¬Î¸Îµ refresh Ï„Î¿Ï… summary
            document.addEventListener('click', function(e) {
                const item = e.target.closest('.summary-item');
                if (item && item.hasAttribute('data-category-id')) {
                    // Î‘Ï†Î±Î¯ÏÎµÏƒÎµ Ï„Î¿ selected Î±Ï€ÏŒ ÏŒÎ»Î±
                    document.querySelectorAll('.summary-item.selected-category').forEach(el => {
                        el.classList.remove('selected-category');
                    });
                    // Î’Î¬Î»Îµ Ï„Î¿ selected ÏƒÏ„Î¿ Ï„ÏÎ­Ï‡Î¿Î½
                    item.classList.add('selected-category');
                    // ...ÎµÎ´Ï Î²Î¬Î»Îµ Ï„Î¿ fetch ÎºÎ±Î¹ Ï„Î¿ render Ï„Ï‰Î½ markers Î³Î¹Î± Ï„Î¿ category Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î·...
                }
            });

            // ÎœÎµÏ„Î¬ Ï„Î¿ await setupNavbar();

const params = new URLSearchParams(window.location.search);
const categoryIdFromQuery = params.get('categoryId');
if (categoryIdFromQuery) {
  // Î ÎµÏÎ¯Î¼ÎµÎ½Îµ Î½Î± Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Ï„Î¿ summary bar
  setTimeout(() => {
    const summaryItem = document.querySelector(`.summary-item[data-category-id="${categoryIdFromQuery}"]`);
    if (summaryItem) {
      summaryItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
      summaryItem.click();
    }
  }, 800);
}

// ÎŒÏ„Î±Î½ Ï€Î±Ï„Î¹Î­Ï„Î±Î¹ Î­Î½Î± summary icon:
document.addEventListener('click', function(e) {
  const item = e.target.closest('.summary-item');
  if (item && item.hasAttribute('data-category-id')) {
    const catId = item.getAttribute('data-category-id');
    // ÎšÏÏÏˆÎµ ÏŒÎ»Î± Ï„Î± category sections
    document.querySelectorAll('.category-section').forEach(section => {
      section.style.display = 'none';
    });
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎµ Î¼ÏŒÎ½Î¿ Ï„Î¿ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿
    const selectedSection = document.querySelector(`.category-section[data-category-id="${catId}"]`);
    if (selectedSection) {
      selectedSection.style.display = '';
      selectedSection.style.width = '100%';
      // Î’ÏÎµÏ‚ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î·Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚ ÎºÎ±Î¹ Ï„Î·Ï‚ Ï€ÏŒÎ»Î·Ï‚
      const categoryName = selectedSection.querySelector('.category-title')?.textContent || '';
      const cityName = document.getElementById('categoriesContainer').dataset.cityName || '';
      // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎµ Ï„Î¿ context header (Ï€Î¬Î½Ï„Î± Î¿ÏÎ±Ï„ÏŒ)
      const ctx = document.getElementById('categoryContextHeader');
      if (ctx) {
        ctx.textContent = `${categoryName} ÏƒÏ„Î·Î½ ${cityName}`;
        ctx.style.display = 'block';
      }
    }
  }
});

document.addEventListener('DOMContentLoaded', function() {
  const splitLayout = document.getElementById('splitLayout');
  const mapSection = document.getElementById('mapSection');
  const categoriesPanel = document.getElementById('categoriesPanel');
  const toggleMapBtn = document.getElementById('toggleMapBtn');
  const toggleMapIcon = document.getElementById('toggleMapIcon');
  let isMapHidden = false;

  if (toggleMapBtn) {
    toggleMapBtn.addEventListener('click', function() {
      isMapHidden = !isMapHidden;
      if (isMapHidden) {
        splitLayout.classList.add('collapsed-map');
        categoriesPanel.classList.add('expanded-panel');
        toggleMapIcon.className = 'bi bi-chevron-right';
        toggleMapBtn.setAttribute('aria-label', 'Expand map');
      } else {
        splitLayout.classList.remove('collapsed-map');
        categoriesPanel.classList.remove('expanded-panel');
        toggleMapIcon.className = 'bi bi-chevron-left';
        toggleMapBtn.setAttribute('aria-label', 'Collapse map');
      }
    });
  }
});
        });
    </script>
</body>
</html>