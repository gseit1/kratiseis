<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtered Shops</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* General Reset and Base */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
    
          /* Offcanvas Styling */
    .offcanvas {
        background-color: #ffffff;
        border-right: 1px solid #e0e0e0;
    }

    .offcanvas .offcanvas-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
    }

    .offcanvas .form-label {
        font-size: 1rem;
        font-weight: bold;
        color: #495057;
    }

    .offcanvas .form-select {
        border-radius: 5px;
        padding: 10px;
        font-size: 1rem;
    }

    .offcanvas .btn-primary {
        font-size: 1rem;
        font-weight: bold;
        padding: 10px;
        border-radius: 5px;
        transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .offcanvas .btn-primary:hover {
        background-color: #0056b3;
        transform: scale(1.05);
    }

    /* Responsive Design */
    @media (min-width: 992px) {
        .offcanvas {
            position: static;
            transform: none;
            visibility: visible;
            height: auto;
            width: 100%;
            max-width: 260px;
            border-right: 1px solid #e0e0e0;
        }

        .offcanvas-body {
            padding: 0;
        }
    }
    @media (min-width: 992px) {
    .offcanvas.offcanvas-start {
        transform: none !important;
        visibility: visible !important;
        position: relative !important;
        border-right: 1px solid #dee2e6;
    }

    .offcanvas-header.d-lg-none {
        display: none !important;
    }
}

        /* Main Content */
        .content {
            margin-left: 280px;
            padding: 30px;
        }
    
        .content h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 25px;
        }
    
        /* Shop Cards */
        .card {
            height: 100%;
            border: none;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            background-color: #ffffff;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        }
    
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
    
        .card-img-top {
            height: 180px;
            object-fit: cover;
            border-bottom: 1px solid #e9ecef;
        }
    
        .card-body {
            padding: 20px;
            text-align: center;
        }
    
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0d6efd;
            margin-bottom: 10px;
        }
    
        .card-text {
            font-size: 0.95rem;
            color: #6c757d;
            margin-bottom: 15px;
        }
    
        .btn-primary {
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 6px;
            background-color: #0d6efd;
        }
    
        /* No Results */
        .no-results {
            text-align: center;
            color: #6c757d;
            font-size: 1.2rem;
            margin-top: 50px;
        }
    
        /* Navbar */
        .navbar {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
    
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 600;
        }
    
        .navbar-nav .nav-link {
            font-size: 1rem;
            font-weight: 500;
            padding: 8px 12px;
        }
    
        .navbar-nav .nav-link.active {
            background-color: #0056b3;
            color: #fff !important;
            border-radius: 6px;
        }
    
        /* Responsive Design */
        @media (max-width: 768px) {
            .filter-menu {
                position: relative;
                top: 0;
                width: 100%;
                height: auto;
                margin-bottom: 20px;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
    
            .content {
                margin-left: 0;
                padding: 15px;
            }
    
            .card-img-top {
                height: 150px;
            }
    
            .card-title {
                font-size: 1rem;
            }
    
            .card-text {
                font-size: 0.9rem;
            }
        }
    
        @media (max-width: 576px) {
            .card-img-top {
                height: 120px;
            }
    
            .card-title {
                font-size: 0.95rem;
            }
    
            .card-text {
                font-size: 0.85rem;
            }
    
            .btn-primary {
                font-size: 0.8rem;
            }
        }
        .no-results-box {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 30px;
    max-width: 500px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    text-align: center;
}
.no-results-box h3 {
    color: #dc3545;
    font-weight: 600;
}
.no-results-box p {
    color: #6c757d;
}

    </style>
    
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">MyShop</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="shops.html">Shops</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="createShop.html">Create Shop</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="registerLogin.html">Register/Login</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Offcanvas Trigger Button -->
            <div class="col-12 mb-3 d-lg-none">
                <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas" aria-controls="filterOffcanvas">
                    <i class="bi bi-funnel"></i> Filters
                </button>
            </div>
    
            <div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffcanvas" aria-labelledby="filterOffcanvasLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="filterOffcanvasLabel">Filter Shops</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <form id="filterForm">
                        <div class="mb-4">
                            <label for="cityFilter" class="form-label">City</label>
                            <select id="cityFilter" class="form-select">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="regionFilter" class="form-label">Region</label>
                            <select id="regionFilter" class="form-select">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="categoryFilter" class="form-label">Category</label>
                            <select id="categoryFilter" class="form-select">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary w-100" id="applyFilters">Apply Filters</button>
                    </form>
                </div>
            </div>
            <!-- Shops Container -->
            <div class="col-lg-9 col-md-8">
                <div id="shopsContainer" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
                    <!-- Shop cards will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function fetchFilters() {
            try {
                const [categoriesResponse, citiesResponse, regionsResponse] = await Promise.all([
                    fetch('/category').then(res => res.json()),
                    fetch('/city').then(res => res.json()),
                    fetch('/region').then(res => res.json())
                ]);

                const categories = categoriesResponse.categories;
                const cities = citiesResponse;
                const regions = regionsResponse.regions;

                // Populate categories
                const categoryFilter = document.getElementById('categoryFilter');
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(category => {
                    categoryFilter.innerHTML += `<option value="${category._id}">${category.name}</option>`;
                });

                // Populate cities
                const cityFilter = document.getElementById('cityFilter');
                cityFilter.innerHTML = '<option value="">All Cities</option>';
                cities.forEach(city => {
                    cityFilter.innerHTML += `<option value="${city._id}">${city.name}</option>`;
                });

                // Populate regions
                const regionFilter = document.getElementById('regionFilter');
                regionFilter.innerHTML = '<option value="">All Regions</option>';
                regions.forEach(region => {
                    regionFilter.innerHTML += `<option value="${region._id}">${region.name}</option>`;
                });
            } catch (error) {
                console.error('Error fetching filters:', error);
            }
        }
        async function fetchShops(filters = {}) {
    try {
        let url = '/api/shop'; // Use the exact route

        // If filters are provided, construct the filtered URL
        if (filters.city && filters.region && filters.category) {
            url = `/search/city/${filters.city}/region/${filters.region}/category/${filters.category}`;
        } else if (filters.city && filters.region) {
            url = `/search/city/${filters.city}/region/${filters.region}`;
        } else if (filters.city && filters.category) {
            url = `/search/city/${filters.city}/category/${filters.category}`;
        } else if (filters.city) {
            url = `/search/city/${filters.city}`;
        }

        const response = await fetch(url);

        // Handle 404 response for no results
        if (response.status === 404) {
    const shopsContainer = document.getElementById('shopsContainer');
    shopsContainer.innerHTML = `
    <div class="col-12 d-flex justify-content-center align-items-center flex-column p-5">
        <div class="no-results-box">
            <h3><i class="bi bi-search"></i> No Shops Found</h3>
            <p>Please try different filters or reset your search to explore all shops.</p>
            <button class="btn btn-outline-primary mt-3" onclick="fetchShops()">Reset Filters</button>
        </div>
    </div>
`;

    return;
}
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const shops = await response.json();

        const shopsContainer = document.getElementById('shopsContainer');
        shopsContainer.innerHTML = '';

        if (shops.length === 0) {
            // Display a message if no results are found
            shopsContainer.innerHTML = `
                <div class="col-12 text-center">
                    <p class="text-muted">No shops found matching your criteria.</p>
                </div>
            `;
            return;
        }

        shops.forEach(shop => {
            console.log('Shop Object:', shop); // Debugging: Log the shop object

            const shopCard = document.createElement('div');
            shopCard.className = 'col-md-4';

            // Handle both `id` and `_id` properties
            const shopId = shop.id || shop._id;
            if (!shopId) {
                console.error('Shop is missing an id:', shop);
                return;
            }

            shopCard.setAttribute('data-id', shopId); // Add shop ID as a data attribute

            // Use the first image from the `images` array or a placeholder
            let imageUrl = shop.image || (shop.images && shop.images.length > 0 ? shop.images[0] : null);
            if (!imageUrl || (!imageUrl.startsWith('http') && !imageUrl.startsWith('/'))) {
                imageUrl = '/images/default-placeholder.jpg'; // Use placeholder if image is invalid
            } else if (imageUrl.startsWith('/')) {
                imageUrl = `http://localhost:300${imageUrl}`; // Prepend base URL for relative paths
            }

            console.log('Image URL:', imageUrl); // Debugging: Log the image URL

            shopCard.innerHTML = `
                <div class="card mb-4">
                    <img src="${imageUrl}" class="card-img-top" alt="${shop.shopName}">
                    <div class="card-body">
                        <h5 class="card-title">${shop.shopName}</h5>
                        <p class="card-text">${shop.shopDescription || ''}</p>
                        <a href="#" class="btn btn-primary view-details">View Details</a>
                    </div>
                </div>
            `;
            shopsContainer.appendChild(shopCard);

            console.log('Shop Card:', shopCard); // Debugging: Log the shop card

            // Add click event listener to the shop card
            shopCard.addEventListener('click', () => {
                const shopId = shopCard.getAttribute('data-id');
                console.log('Shop ID:', shopId); // Log the shop ID
                if (shopId) {
                    // Redirect to the shop details page
                    window.location.href = `shop.html?id=${shopId}`;
                } else {
                    console.error('Shop ID is missing!');
                }
            });
        });
    } catch (error) {
        console.error('Error fetching shops:', error);
    }
}
        document.addEventListener('DOMContentLoaded', () => {
            fetchFilters();
            fetchShops();

            document.getElementById('applyFilters').addEventListener('click', () => {
                const city = document.getElementById('cityFilter').value;
                const region = document.getElementById('regionFilter').value;
                const category = document.getElementById('categoryFilter').value;

                const filters = { city, region, category };
                fetchShops(filters);
            });
        });
    </script>
</body>
</html>