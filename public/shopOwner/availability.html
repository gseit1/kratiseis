<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Availability</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #content {
            padding: 20px;
        }
        #floorPanelFilters button.active {
          background-color: #007bff;
          color: #fff;
          border-color: #007bff;
        }
        #availableHoursContainer.loading {
          opacity: 0.5;
          pointer-events: none;
          transition: opacity 0.3s ease-in-out;
        }
        .available-hour.active {
          background-color: #007bff;
          color: #fff;
          border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="content">
            <section id="availability">
                <div class="container">
                    <h2 class="mb-3">Check Availability</h2>
                    <form id="availabilityForm" class="row">
                        <div class="col-md-4 mb-3">
                            <label for="dateString" class="form-label">Date</label>
                            <input type="date" id="dateString" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="seatsRequired" class="form-label">Seats Required</label>
                            <input type="number" id="seatsRequired" class="form-control" min="1">
                        </div>
                    </form>
                    <div id="availabilitySection" class="mt-3">
                      <div id="floorPanelFilters" class="mb-3"></div>
                      <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                      <div id="availableHoursContainer"></div>
                    </div>
                    <div id="reservationFormContainer" class="mt-4" style="display: none;">
                        <h3>Make a Reservation</h3>
                        <form id="reservationForm">
                            <div class="mb-3">
                                <label for="reservationName" class="form-label">Name</label>
                                <input type="text" id="reservationName" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="reservationSurname" class="form-label">Surname</label>
                                <input type="text" id="reservationSurname" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="reservationDateTime" class="form-label">Date & Time</label>
                                <input type="text" id="reservationDateTime" class="form-control" disabled>
                            </div>
                            <div class="mb-3">
                              <label for="reservationFloorPanel" class="form-label">Floor Panel</label>
                              <input type="text" id="reservationFloorPanel" class="form-control" disabled>
                            </div>
                            <button type="button" id="submitReservationBtn" class="btn btn-success">Submit Reservation</button>
                            <button type="button" class="btn btn-secondary" onclick="closeReservationForm()">Cancel</button>
                        </form>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        let shopId = null; // Global shopId variable

        // Fetch availability
        async function fetchAvailability(floorPanelId = null) {
          const dateString = document.getElementById('dateString').value;
          const seats = document.getElementById('seatsRequired').value;

          console.log("Fetching availability with the following parameters:");
          console.log("Date:", dateString);
          console.log("Seats:", seats);
          console.log("Floor Panel ID:", floorPanelId);

          if (!shopId) {
            alert("Shop ID is missing. Please refresh the page.");
            return;
          }

          if (!dateString || !seats) {
            document.getElementById('availabilitySection').innerHTML = `<p class="text-danger">Please provide all required inputs (date and seats).</p>`;
            return;
          }

          // Εμφάνιση του loading spinner και προσθήκη εφέ φόρτωσης
          const loadingSpinner = document.getElementById('loadingSpinner');
          const availableHoursContainer = document.getElementById('availableHoursContainer');
          loadingSpinner.style.display = 'block';
          availableHoursContainer.classList.add('loading');

          try {
            const query = `/api/availability?shopId=${shopId}&dateString=${dateString}&seats=${seats}` +
                          (floorPanelId ? `&floorPanelId=${floorPanelId}` : '');
            console.log("API Query:", query);

            const response = await fetch(query);

            if (!response.ok) {
              const error = await response.json();
              console.error("Error response from API:", error);
              throw new Error(error.message || 'Failed to fetch availability');
            }

            const data = await response.json();
            console.log("Availability Data:", data);

            displayAvailability(data);

            // Εμφάνιση των φίλτρων FloorPanel
            if (!floorPanelId) {
              const floorPanels = await fetchFloorPanels(); // Φόρτωση των floorPanels
              renderFloorPanelFilters(floorPanels);
            }
          } catch (error) {
            console.error("Error fetching availability:", error);
            document.getElementById('availableHoursContainer').innerHTML = `<p class="text-danger">Error fetching availability: ${error.message}</p>`;
          } finally {
            // Απόκρυψη του loading spinner και αφαίρεση εφέ φόρτωσης
            loadingSpinner.style.display = 'none';
            availableHoursContainer.classList.remove('loading');
          }
        }

        // Display availability
        function displayAvailability(data) {
  const availableHoursContainer = document.getElementById('availableHoursContainer');
  if (data && data.availability && Array.isArray(data.availability) && data.availability.length > 0) {
    let html = `<div class="row">`;
    data.availability.forEach(hour => {
      html += `
        <div class="col-md-3 mb-2">
          <button class="btn btn-outline-success w-100 available-hour" data-hour="${hour}">
            ${hour}
          </button>
        </div>`;
    });
    html += `</div>`;
    availableHoursContainer.innerHTML = html;

    // Add click event listeners to available hours
    document.querySelectorAll('.available-hour').forEach(item => {
      item.addEventListener('click', (event) => {
        const selectedHour = event.target.getAttribute('data-hour');
        setActiveHour(event.target); // Ορισμός ενεργής ώρας
        showReservationForm(); // Κλήση της φόρμας κράτησης
      });
    });
  } else {
    availableHoursContainer.innerHTML = `<p class="text-warning">No availability found for the selected date and seats.</p>`;
  }
}

// Συνάρτηση για ορισμό ενεργής ώρας
function setActiveHour(selectedButton) {
  const buttons = document.querySelectorAll('.available-hour');
  buttons.forEach(button => button.classList.remove('active')); // Αφαίρεση της κλάσης active από όλα τα κουμπιά
  selectedButton.classList.add('active'); // Προσθήκη της κλάσης active στο επιλεγμένο κουμπί
}

        // Show reservation form
        function showReservationForm() {
  const activeFloorPanelButton = document.querySelector('#floorPanelFilters button.active');
  const selectedFloorPanelId = activeFloorPanelButton ? activeFloorPanelButton.dataset.floorPanelId : null;

  document.getElementById('reservationFloorPanel').value = selectedFloorPanelId || 'General';
  document.getElementById('reservationFormContainer').style.display = 'block';
}

        // Submit reservation
        document.getElementById('submitReservationBtn').addEventListener('click', async () => {
  const name = document.getElementById('reservationName').value.trim();
  const surname = document.getElementById('reservationSurname').value.trim();
  const seats = document.getElementById('seatsRequired').value.trim();
  const floorPanelId = document.getElementById('reservationFloorPanel').value.trim(); // Λήψη του ID του FloorPanel
  const activeHourButton = document.querySelector('.available-hour.active');
  const reservationTime = activeHourButton ? activeHourButton.getAttribute('data-hour') : null;

  if (!name || !surname || !reservationTime || !seats) {
    alert("Please fill in all required fields.");
    return;
  }

  const reservationDate = document.getElementById('dateString').value;

  if (!shopId) {
    alert("Shop ID is missing. Please refresh the page.");
    return;
  }

  // Δημιουργία του αντικειμένου κράτησης
  const reservationData = {
    shopId,
    name,
    surname,
    reservationDate,
    reservationTime,
    seats,
  };

  // Προσθήκη του floorPanelId μόνο αν δεν είναι "General"
  if (floorPanelId !== 'General') {
    reservationData.floorPanelId = floorPanelId;
  }

  try {
    const response = await fetch('/api/reservation/manual', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(reservationData),
    });

    if (!response.ok) {
      const error = await response.json();
      alert("Error submitting reservation: " + error.message);
      return;
    }

    alert("Reservation submitted successfully!");

    // Τροποποίηση στην υποβολή κράτησης - μετά το alert "Reservation submitted successfully!"
    if (window.self !== window.top) {
      // Είμαστε σε iframe - ενημερώνουμε το parent window
      window.parent.postMessage('reservationSuccess', '*');
    } else {
      closeReservationForm(); // Μόνο αν είμαστε σε κανονικό παράθυρο
    }
  } catch (error) {
    console.error("Error submitting reservation:", error);
    alert("An error occurred while submitting the reservation.");
  }
});

        // Fetch shop ID on page load
        async function fetchShopId() {
            try {
                const response = await fetch('/api/users/details', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const userData = await response.json();
                console.log('User Data:', userData); // Debugging

                if (userData.isAuthenticated && userData.user) {
                    shopId = userData.user.shopId;

                    if (!shopId) {
                        console.log('No shopId found, redirecting to create shop');
                        window.location.href = 'createShop.html';
                    } else {
                        console.log('ShopId found:', shopId);
                    }
                } else {
                    throw new Error('Invalid user data structure');
                }
            } catch (error) {
                console.error('Error fetching shop ID:', error);
                alert('Failed to fetch shop details. Redirecting to login.');
                window.location.href = '../registerLogin.html';
            }
        }

        // Fetch floor panels
        async function fetchFloorPanels() {
          if (!shopId) {
            console.error("Shop ID is missing. Cannot fetch floor panels.");
            return [];
          }

          try {
            const response = await fetch(`/api/shop/${shopId}/floorPanels`, {
              method: 'GET',
              credentials: 'include',
            });

            if (!response.ok) {
              throw new Error(`Failed to fetch floor panels: ${response.status}`);
            }

            const floorPanels = await response.json();
            return floorPanels;
          } catch (error) {
            console.error("Error fetching floor panels:", error);
            return [];
          }
        }

        // Render floor panel filters
        function renderFloorPanelFilters(floorPanels) {
          const filtersContainer = document.getElementById('floorPanelFilters');
          filtersContainer.innerHTML = ''; // Καθαρισμός προηγούμενων φίλτρων

          // Προσθήκη κουμπιού "Γενικά"
          const generalButton = document.createElement('button');
          generalButton.className = 'btn btn-outline-secondary me-2';
          generalButton.textContent = 'Γενικά';
          generalButton.dataset.floorPanelId = 'General';
          generalButton.addEventListener('click', () => {
            setActiveFilter(generalButton); // Ορισμός ενεργού φίλτρου
            fetchAvailability(); // Εκτέλεση request χωρίς floorPanelId
            closeReservationForm(); // Κλείσιμο της φόρμας κράτησης
          });
          filtersContainer.appendChild(generalButton);

          // Προσθήκη κουμπιών για κάθε floorPanel
          floorPanels.forEach(panel => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-primary me-2';
            button.textContent = panel.name || `Floor Panel ${panel._id}`;
            button.dataset.floorPanelId = panel._id; // Προσθήκη του ID του FloorPanel

            button.addEventListener('click', () => {
              setActiveFilter(button); // Ορισμός ενεργού φίλτρου
              const floorPanelId = button.dataset.floorPanelId;
              fetchAvailability(floorPanelId); // Εκτέλεση request για το συγκεκριμένο floorPanel
              closeReservationForm(); // Κλείσιμο της φόρμας κράτησης
            });

            filtersContainer.appendChild(button);
          });
        }

        // Συνάρτηση για ορισμό ενεργού φίλτρου
        function setActiveFilter(selectedButton) {
          const buttons = document.querySelectorAll('#floorPanelFilters button');
          buttons.forEach(button => button.classList.remove('active')); // Αφαίρεση της κλάσης active από όλα τα κουμπιά
          selectedButton.classList.add('active'); // Προσθήκη της κλάσης active στο επιλεγμένο κουμπί
        }

        // Load the external menu dynamically
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const menuContainer = document.getElementById('menu');
                const response = await fetch('./components/menu.html');
                if (response.ok) {
                    menuContainer.innerHTML = await response.text();
                } else {
                    console.error('Failed to load menu:', response.status);
                }
            } catch (error) {
                console.error('Error loading menu:', error);
            }

            await fetchShopId();
            await fetchFloorPanels(); // Φόρτωση των floor panels
        });

        document.getElementById('dateString').addEventListener('change', () => {
          const seatsField = document.getElementById('seatsRequired');
          seatsField.value = ''; // Τα Seats γίνονται null
          seatsField.parentElement.style.display = 'block'; // Εμφάνιση του πεδίου Seats

          const availableHoursContainer = document.getElementById('availableHoursContainer');
          const floorPanelFilters = document.getElementById('floorPanelFilters');

          availableHoursContainer.innerHTML = ''; // Καθαρισμός των ωρών
          availableHoursContainer.style.display = 'none'; // Απόκρυψη του πλαισίου ωρών
          floorPanelFilters.style.display = 'none'; // Απόκρυψη των φίλτρων FloorPanel

          closeReservationForm(); // Κλείσιμο της φόρμας κράτησης
        });

        document.getElementById('seatsRequired').addEventListener('change', () => {
          const availableHoursContainer = document.getElementById('availableHoursContainer');
          const floorPanelFilters = document.getElementById('floorPanelFilters');

          fetchAvailability(); // Εκτέλεση του request για διαθεσιμότητα

          availableHoursContainer.style.display = 'block'; // Εμφάνιση του πλαισίου ωρών
          floorPanelFilters.style.display = 'block'; // Εμφάνιση των φίλτρων FloorPanel

          closeReservationForm(); // Κλείσιμο της φόρμας κράτησης
        });

        function closeReservationForm() {
  document.getElementById('reservationFormContainer').style.display = 'none';
}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>