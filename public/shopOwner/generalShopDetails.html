<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Shop Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <!-- Mapbox CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet">
    <!-- Mapbox JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #menu {
        height: 100vh;
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        padding-top: 20px;
    }
    #menu h4 {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }
    #menu .nav-link {
        color: #000;
        padding: 10px 15px;
        border-radius: 5px;
        transition: background-color 0.3s, color 0.3s;
    }
    #menu .nav-link:hover {
        background-color: #e9ecef;
        color: #007bff;
    }
    #menu .nav-link.active {
        background-color: #007bff;
        color: #fff;
    }
    #menu .nav-link i {
        font-size: 1.2rem;
    }
        #content {
            padding: 20px;
        }
        #map {
            height: 200px;
            width: 50%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Left Menu -->
            <div id="menu-container" class="col-md-3">
                <!-- Include the external menu -->
                <div id="menu"></div>
            </div>

            <!-- Right Content -->
            <div id="content" class="col-md-9">
                <section id="generalShopDetails">
                    <div class="container mt-5">
                        <h2>General Shop Details</h2>
                        <form id="generalShopForm">
                            <div class="mb-3">
                                <label class="form-label">Shop Name</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" id="shopName" class="form-control me-2" disabled>
                                    <button type="button" id="editNameBtn" class="btn btn-warning btn-sm">Edit</button>
                                    <button type="button" id="saveNameBtn" class="btn btn-success btn-sm" style="display:none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <div class="d-flex align-items-center">
                                    <textarea id="shopDescription" class="form-control me-2" rows="3" disabled></textarea>
                                    <button type="button" id="editDescriptionBtn" class="btn btn-warning btn-sm">Edit</button>
                                    <button type="button" id="saveDescriptionBtn" class="btn btn-success btn-sm" style="display:none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" id="shopPhone" class="form-control me-2" disabled>
                                    <button type="button" id="editPhoneBtn" class="btn btn-warning btn-sm">Edit</button>
                                    <button type="button" id="savePhoneBtn" class="btn btn-success btn-sm" style="display:none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">City</label>
                                <input type="text" id="shopCity" class="form-control" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Region</label>
                                <input type="text" id="shopRegion" class="form-control" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" id="shopCategory" class="form-control" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Address</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" id="shopAddress" class="form-control me-2" disabled>
                                    <button type="button" id="editAddressBtn" class="btn btn-warning btn-sm">Edit</button>
                                    <button type="button" id="saveAddressBtn" class="btn btn-success btn-sm" style="display:none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Location</label>
                                <div id="map" style="height: 200px; width: 100%; margin-bottom: 20px;"></div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" id="editLocationBtn" class="btn btn-warning btn-sm me-2">Edit</button>
                                    <button type="button" id="saveLocationBtn" class="btn btn-success btn-sm" style="display: none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Opening Hours</label>
                                <div id="shopOpeningHours" class="border p-3 rounded bg-light text-dark"></div>
                            </div>
                        </form>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        // Load the external menu dynamically
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const menuContainer = document.getElementById('menu');
                const response = await fetch('./components/menu.html');
                if (response.ok) {
                    menuContainer.innerHTML = await response.text();

                    // Add event listener for logout button after menu is loaded
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', async () => {
                            try {
                                // Call a logout endpoint to clear the cookie
                                await fetch('/api/logout', {
                                    method: 'POST',
                                    credentials: 'include',
                                });
                                
                                // Clear any client-side storage
                                localStorage.clear();
                                sessionStorage.clear();
                                
                                alert('You have been logged out.');
                                window.location.href = 'registerLogin.html'; // Redirect to login page
                            } catch (error) {
                                console.error('Error during logout:', error);
                                // If the fetch fails, still clear storage and redirect
                                localStorage.clear();
                                sessionStorage.clear();
                                window.location.href = 'registerLogin.html';
                            }
                        });
                    }
                } else {
                    console.error('Failed to load menu:', response.status);
                }
            } catch (error) {
                console.error('Error loading menu:', error);
            }
        });

        // Global shopId variable
        let shopId = null;
        let marker; // Global marker variable
    
        // Fetch General Shop Details
        async function fetchGeneralDetails() {
            try {
                const response = await fetch('/api/shop/generalDetails', {
                    method: 'GET',
                    credentials: 'include', // Include cookies in the request
                });
    
                if (!response.ok) throw new Error("Failed to fetch shop details");
                const shop = await response.json();
    
                // Set the global shopId variable
                shopId = shop._id || shop.id; // Χρησιμοποιήστε το σωστό πεδίο από την απάντηση
    
                // Update the fields with the populated data
                document.getElementById("shopName").value = shop.shopName || 'N/A';
                document.getElementById("shopDescription").value = shop.shopDescription || 'N/A';
                document.getElementById("shopPhone").value = shop.phone || 'N/A';
                document.getElementById("shopCity").value = shop.city?.name || 'N/A';
                document.getElementById("shopRegion").value = shop.region?.name || 'N/A';
                document.getElementById("shopCategory").value = shop.category?.name || 'N/A';
                document.getElementById("shopAddress").value = shop.address || 'N/A';
    
                // Display opening hours
                const openingHoursDiv = document.getElementById("shopOpeningHours");
                openingHoursDiv.innerHTML = Object.entries(shop.openingHours || {})
                    .map(([day, hours]) => `
                        <p>
                            <strong>${day.charAt(0).toUpperCase() + day.slice(1)}:</strong> 
                            ${hours.isOpen ? `${hours.open}:00 - ${hours.close}:00` : 'Closed'}
                        </p>
                    `)
                    .join('');

                // Display location on map
                if (shop.location?.coordinates) {
                    const [longitude, latitude] = shop.location.coordinates;
                    initializeMap(latitude, longitude);
                }

                renderOpeningBookingHours(shop.openingHours || {});
            } catch (error) {
                console.error("Error fetching general shop details:", error);
                alert("Failed to fetch shop details. Please try again later.");
            }
        }
    
        // Helper function to toggle edit/save buttons and enable/disable inputs
        function toggleEditSaveGeneral(editBtnId, saveBtnId, inputId, isEditing) {
            document.getElementById(editBtnId).style.display = isEditing ? "none" : "inline-block";
            document.getElementById(saveBtnId).style.display = isEditing ? "inline-block" : "none";
            if (inputId) {
                document.getElementById(inputId).disabled = !isEditing;
            }
        }
    
        // Function to send PATCH request for General Shop Details
        async function updateShopField(field, value) {
            try {
                const response = await fetch(`/api/shop/${shopId}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ [field]: value }),
                });
    
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error updating ${field}: ${error.message}`);
                    return false;
                }
    
                alert(`${field} updated successfully!`);
                return true;
            } catch (error) {
                console.error(`Error updating ${field}:`, error);
                alert(`Error updating ${field}. Please try again later.`);
                return false;
            }
        }
    
        // Event listeners for Shop Name
        document.getElementById("editNameBtn").addEventListener("click", () => {
            toggleEditSaveGeneral("editNameBtn", "saveNameBtn", "shopName", true);
        });
        document.getElementById("saveNameBtn").addEventListener("click", async () => {
            const newName = document.getElementById("shopName").value;
            if (await updateShopField("shopName", newName)) {
                toggleEditSaveGeneral("editNameBtn", "saveNameBtn", "shopName", false);
            }
        });
    
        // Event listeners for Shop Description
        document.getElementById("editDescriptionBtn").addEventListener("click", () => {
            toggleEditSaveGeneral("editDescriptionBtn", "saveDescriptionBtn", "shopDescription", true);
        });
        document.getElementById("saveDescriptionBtn").addEventListener("click", async () => {
            const newDescription = document.getElementById("shopDescription").value;
            if (await updateShopField("shopDescription", newDescription)) {
                toggleEditSaveGeneral("editDescriptionBtn", "saveDescriptionBtn", "shopDescription", false);
            }
        });
    
        // Event listeners for Shop Phone
        document.getElementById("editPhoneBtn").addEventListener("click", () => {
            toggleEditSaveGeneral("editPhoneBtn", "savePhoneBtn", "shopPhone", true);
        });
        document.getElementById("savePhoneBtn").addEventListener("click", async () => {
            const newPhone = document.getElementById("shopPhone").value;
            if (await updateShopField("phone", newPhone)) {
                toggleEditSaveGeneral("editPhoneBtn", "savePhoneBtn", "shopPhone", false);
            }
        });

        // Event listeners for Shop Address
        document.getElementById("editAddressBtn").addEventListener("click", () => {
            toggleEditSaveGeneral("editAddressBtn", "saveAddressBtn", "shopAddress", true);
        });
        document.getElementById("saveAddressBtn").addEventListener("click", async () => {
            const newAddress = document.getElementById("shopAddress").value;
            if (await updateShopField("address", newAddress)) {
                toggleEditSaveGeneral("editAddressBtn", "saveAddressBtn", "shopAddress", false);
            }
        });

        // Initialize Map with Mapbox
        async function initializeMap(latitude, longitude) {
            mapboxgl.accessToken = 'pk.eyJ1IjoicGFub3UyMSIsImEiOiJjbTlzcW9uYmkwM2k4MmpzYjc5dTF6M2ZtIn0.YBe_KPam5O4bdPh2xCpMdw';

            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [longitude, latitude],
                zoom: 14,
            });

            // Add marker to the map
            marker = new mapboxgl.Marker({ draggable: false })
                .setLngLat([longitude, latitude])
                .addTo(map);

            // Enable dragging and clicking when Edit is clicked
            document.getElementById("editLocationBtn").addEventListener("click", () => {
                marker.setDraggable(true);
                toggleEditSaveGeneral("editLocationBtn", "saveLocationBtn", null, true);

                // Allow clicking on the map to move the marker
                map.on('click', (e) => {
                    const lng = e.lngLat.lng;
                    const lat = e.lngLat.lat;
                    marker.setLngLat([lng, lat]); // Move marker to clicked location
                });
            });

            // Save new location when Save is clicked
            document.getElementById("saveLocationBtn").addEventListener("click", async () => {
                const newCoordinates = marker.getLngLat();
                const newLongitude = newCoordinates.lng;
                const newLatitude = newCoordinates.lat;

                const location = {
                    type: "Point",
                    coordinates: [newLongitude, newLatitude],
                };

                if (await updateShopField("location", location)) {
                    marker.setDraggable(false);
                    toggleEditSaveGeneral("editLocationBtn", "saveLocationBtn", null, false);
                }
            });
        }

        function renderOpeningBookingHours(openingHours) {
            const daysOfWeek = [
                "monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"
            ];
            const dayNames = {
                monday: "Monday", tuesday: "Tuesday", wednesday: "Wednesday",
                thursday: "Thursday", friday: "Friday", saturday: "Saturday", sunday: "Sunday"
            };
            let html = `<div class="table-responsive"><table class="table table-bordered align-middle bg-white">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Status</th>
                        <th>Open</th>
                        <th>Close</th>
                        <th>Booking Start</th>
                        <th>Booking End</th>
                        <th>Edit</th>
                    </tr>
                </thead>
                <tbody>
            `;
            daysOfWeek.forEach(day => {
                const hours = openingHours[day] || {};
                html += `
                <tr data-day="${day}">
                    <td class="fw-bold">${dayNames[day]}</td>
                    <td class="status-label">
                        <button type="button" class="btn btn-sm ${hours.isOpen ? 'btn-success' : 'btn-danger'} toggle-status-btn" data-day="${day}">
                            ${hours.isOpen ? 'Open' : 'Closed'}
                        </button>
                    </td>
                    <td class="open-label">${hours.isOpen ? `${hours.open}:00` : '-'}</td>
                    <td class="close-label">${hours.isOpen ? `${hours.close}:00` : '-'}</td>
                    <td class="bookingStart-label">${hours.isOpen ? `${hours.bookingStart}:00` : '-'}</td>
                    <td class="bookingEnd-label">${hours.isOpen ? `${hours.bookingEnd}:00` : '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm edit-day-btn" data-day="${day}">Edit</button>
                    </td>
                </tr>
                `;
            });
            html += `</tbody></table></div>`;
            document.getElementById("shopOpeningHours").innerHTML = html;

            // Add event listeners for edit buttons
            document.querySelectorAll('.edit-day-btn').forEach(btn => {
                btn.onclick = () => showEditDay(openingHours, btn.getAttribute('data-day'));
            });

            // Add event listeners for status toggle buttons
            document.querySelectorAll('.toggle-status-btn').forEach(btn => {
    btn.onclick = async function () {
        const day = btn.getAttribute('data-day');
        const isOpen = btn.textContent.trim() === 'Open';
        const newStatus = isOpen ? 'close' : 'open';
        if (!shopId) {
            alert('Shop ID not loaded yet. Παρακαλώ ανανεώστε τη σελίδα.');
            return;
        }
        if (newStatus === 'open') {
            // Αν υπάρχει ήδη το πλαίσιο, απλά άλλαξε τα values
            let formDiv = document.getElementById('openDayForm');
            if (!formDiv) {
                // Δημιούργησε το πλαίσιο αν δεν υπάρχει
                const formHtml = `
                    <div id="openDayForm" class="p-3 border rounded bg-white" style="position:fixed;top:20%;left:50%;transform:translateX(-50%);z-index:9999;min-width:350px;">
                        <h5 id="openDayTitle"></h5>
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <label>Open</label>
                                <input type="number" min="0" max="23" class="form-control" id="open_input" required>
                            </div>
                            <div class="col-md-3">
                                <label>Close</label>
                                <input type="number" min="0" max="24" class="form-control" id="close_input" required>
                            </div>
                            <div class="col-md-3">
                                <label>Booking Start</label>
                                <input type="number" min="0" max="23" class="form-control" id="bookingStart_input" required>
                            </div>
                            <div class="col-md-3">
                                <label>Booking End</label>
                                <input type="number" min="0" max="24" class="form-control" id="bookingEnd_input" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" id="saveOpenDayBtn" class="btn btn-success btn-sm me-2">OK</button>
                            <button type="button" id="cancelOpenDayBtn" class="btn btn-secondary btn-sm">Cancel</button>
                        </div>
                    </div>
                `;
                const container = document.createElement('div');
                container.innerHTML = formHtml;
                document.body.appendChild(container);
                formDiv = document.getElementById('openDayForm');
                document.getElementById('cancelOpenDayBtn').onclick = () => formDiv.remove();
            }

            // Ενημέρωσε το title και τα values κάθε φορά
            document.getElementById('openDayTitle').textContent = `Ρύθμιση ωρών για ${day.charAt(0).toUpperCase() + day.slice(1)}`;
            // Προσπάθησε να βρεις τις τιμές από το openingHours
            const hours = (window.lastOpeningHours || {})[day] || {};
            document.getElementById('open_input').value = hours.open ?? '';
            document.getElementById('close_input').value = hours.close ?? '';
            document.getElementById('bookingStart_input').value = hours.bookingStart ?? '';
            document.getElementById('bookingEnd_input').value = hours.bookingEnd ?? '';

            // Αποθήκευσε το τρέχον day στο formDiv για χρήση στο save
            formDiv.setAttribute('data-day', day);

            // Βάλε το save handler (μία φορά)
            if (!formDiv.saveHandlerSet) {
                document.getElementById('saveOpenDayBtn').onclick = async () => {
                    const day = formDiv.getAttribute('data-day');
                    const open = Number(document.getElementById('open_input').value);
                    const close = Number(document.getElementById('close_input').value);
                    const bookingStart = Number(document.getElementById('bookingStart_input').value);
                    const bookingEnd = Number(document.getElementById('bookingEnd_input').value);

                    if (isNaN(open) || isNaN(close) || isNaN(bookingStart) || isNaN(bookingEnd)) {
                        alert("Όλα τα πεδία πρέπει να συμπληρωθούν.");
                        return;
                    }
                    if (open >= close) {
                        alert("Η ώρα ανοίγματος πρέπει να είναι πριν το κλείσιμο.");
                        return;
                    }
                    if (bookingStart >= bookingEnd) {
                        alert("Το booking start πρέπει να είναι πριν το booking end.");
                        return;
                    }
                    if (bookingStart < open || bookingEnd > close) {
                        alert("Οι ώρες booking πρέπει να είναι εντός των ωρών λειτουργίας.");
                        return;
                    }

                    try {
                        const response = await fetch(`/api/shop/${shopId}/is-open-for-day`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                day,
                                isOpen: true,
                                open,
                                close,
                                bookingStart,
                                bookingEnd
                            })
                        });
                        if (!response.ok) {
                            const error = await response.json();
                            alert(`Σφάλμα: ${error.message}`);
                            return;
                        }
                        alert('Η κατάσταση ενημερώθηκε επιτυχώς!');
                        formDiv.remove();
                        fetchGeneralDetails();
                    } catch (err) {
                        alert('Σφάλμα κατά την ενημέρωση.');
                    }
                };
                formDiv.saveHandlerSet = true;
            }

            // Κράτα τα τελευταία openingHours για να βρίσκεις τιμές κάθε φορά
            window.lastOpeningHours = window.lastOpeningHours || {};
            fetch('/api/shop/generalDetails', { credentials: 'include' })
                .then(r => r.json())
                .then(shop => { window.lastOpeningHours = shop.openingHours || {}; });

            return;
        }

        // Αν γίνεται close
        if (confirm(`Αλλαγή για ${dayNames[day]}: το μαγαζί θα είναι κλειστό;`)) {
            try {
                const response = await fetch(`/api/shop/${shopId}/is-open-for-day`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        day,
                        isOpen: false
                    })
                });
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Σφάλμα: ${error.message}`);
                    return;
                }
                alert('Η κατάσταση ενημερώθηκε επιτυχώς!');
                fetchGeneralDetails();
            } catch (err) {
                alert('Σφάλμα κατά την ενημέρωση.');
            }
        }
    };
});
        }

        function showEditDay(openingHours, day) {
            const dayNames = {
                monday: "Monday", tuesday: "Tuesday", wednesday: "Wednesday",
                thursday: "Thursday", friday: "Friday", saturday: "Saturday", sunday: "Sunday"
            };
            const hours = openingHours[day] || {};
            const html = `
            <form id="editDayForm" class="p-3 border rounded bg-white">
                <h5 class="mb-3">${dayNames[day]}</h5>
                <div class="row mb-2">
                    <div class="col-md-3">
                        <label>Open</label>
                        <input type="number" min="0" max="23" class="form-control" id="open_${day}" value="${hours.open ?? ''}" required>
                    </div>
                    <div class="col-md-3">
                        <label>Close</label>
                        <input type="number" min="0" max="24" class="form-control" id="close_${day}" value="${hours.close ?? ''}" required>
                    </div>
                    <div class="col-md-3">
                        <label>Booking Start</label>
                        <input type="number" min="0" max="23" class="form-control" id="bookingStart_${day}" value="${hours.bookingStart ?? ''}" required>
                    </div>
                    <div class="col-md-3">
                        <label>Booking End</label>
                        <input type="number" min="0" max="24" class="form-control" id="bookingEnd_${day}" value="${hours.bookingEnd ?? ''}" required>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" id="saveDayBtn" class="btn btn-success btn-sm me-2">Save</button>
                    <button type="button" id="backDayBtn" class="btn btn-secondary btn-sm">Back</button>
                </div>
            </form>
            `;
            document.getElementById("shopOpeningHours").innerHTML = html;

            document.getElementById("backDayBtn").onclick = () => renderOpeningBookingHours(openingHours);

            document.getElementById("saveDayBtn").onclick = async function() {
                const open = Number(document.getElementById(`open_${day}`).value);
                const close = Number(document.getElementById(`close_${day}`).value);
                const bookingStart = Number(document.getElementById(`bookingStart_${day}`).value);
                const bookingEnd = Number(document.getElementById(`bookingEnd_${day}`).value);

                // Validation
                if (isNaN(open) || isNaN(close) || isNaN(bookingStart) || isNaN(bookingEnd)) {
                    alert("All fields must be filled.");
                    return;
                }
                if (open >= close) {
                    alert("Open time must be before close time.");
                    return;
                }
                if (bookingStart >= bookingEnd) {
                    alert("Booking start must be before booking end.");
                    return;
                }
                if (bookingStart < open || bookingEnd > close) {
                    alert("Booking hours must be within opening hours.");
                    return;
                }

                // Έλεγχος αν έχει αλλάξει κάποιο πεδίο
                const prev = openingHours[day] || {};
                if (
                    prev.open == open &&
                    prev.close == close &&
                    prev.bookingStart == bookingStart &&
                    prev.bookingEnd == bookingEnd
                ) {
                    alert("Δεν έγινε καμία αλλαγή.");
                    renderOpeningBookingHours(openingHours);
                    return;
                }

                // Στείλε PATCH request με και τα 4 πεδία
                try {
                    const body = {
                        day,
                        openingStart: open,
                        openingEnd: close,
                        bookingStart,
                        bookingEnd
                    };
                    const response = await fetch('/api/shop/booking-hours', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(body)
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        alert(`Error updating hours: ${error.message}`);
                        return;
                    }
                    alert("Hours updated successfully!");
                    // Ενημέρωσε τα δεδομένα και ξαναφόρτωσε
                    fetchGeneralDetails();
                } catch (error) {
                    alert("Error updating opening/booking hours.");
                }
            };
        }

        // Fetch General Shop Details on page load
        fetchGeneralDetails();
    </script>
</body>
</html>