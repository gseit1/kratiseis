<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Shop Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <!-- Mapbox CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet">
    <!-- Mapbox JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #menu {
        height: 100vh;
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        padding-top: 20px;
    }
    #menu h4 {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }
    #menu .nav-link {
        color: #000;
        padding: 10px 15px;
        border-radius: 5px;
        transition: background-color 0.3s, color 0.3s;
    }
    #menu .nav-link:hover {
        background-color: #e9ecef;
        color: #007bff;
    }
    #menu .nav-link.active {
        background-color: #007bff;
        color: #fff;
    }
    #menu .nav-link i {
        font-size: 1.2rem;
    }
        #content {
            padding: 20px;
        }
        #map {
            height: 200px;
            width: 50%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Left Menu -->
            <nav id="menu" class="col-md-3 bg-light border-end">
                <h4 class="text-center py-3 border-bottom">Dashboard Menu</h4>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link d-flex align-items-center">
                            <i class="bi bi-table me-2"></i> Table Options
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="generalShopDetails.html" class="nav-link d-flex align-items-center">
                            <i class="bi bi-shop me-2"></i> General Shop Details
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="bookingHours.html" class="nav-link d-flex align-items-center">
                            <i class="bi bi-clock me-2"></i> Booking Hours
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="reservations.html" class="nav-link d-flex align-items-center">
                            <i class="bi bi-calendar-check me-2"></i> Reservations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="undefinedReservations.html" class="nav-link d-flex align-items-center">
                            <i class="bi bi-exclamation-circle me-2"></i> Undefined Reservations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="availability.html" class="nav-link d-flex align-items-center">
                            <i class="bi bi-calendar-range me-2"></i> Availability
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="charts.html" class="nav-link d-flex align-items-center">
                            <i class="bi bi-bar-chart me-2"></i> Reservations Chart
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="photoManagement.html" class="nav-link d-flex align-items-center">
                            <i class="bi bi-images me-2"></i> Photo Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="../registerLogin.html" class="nav-link d-flex align-items-center text-danger" id="logoutBtn">
                            <i class="bi bi-box-arrow-right me-2"></i> Logout
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Right Content -->
            <div id="content" class="col-md-9">
                <section id="generalShopDetails">
                    <div class="container mt-5">
                        <h2>General Shop Details</h2>
                        <form id="generalShopForm">
                            <div class="mb-3">
                                <label class="form-label">Shop Name</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" id="shopName" class="form-control me-2" disabled>
                                    <button type="button" id="editNameBtn" class="btn btn-warning btn-sm">Edit</button>
                                    <button type="button" id="saveNameBtn" class="btn btn-success btn-sm" style="display:none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <div class="d-flex align-items-center">
                                    <textarea id="shopDescription" class="form-control me-2" rows="3" disabled></textarea>
                                    <button type="button" id="editDescriptionBtn" class="btn btn-warning btn-sm">Edit</button>
                                    <button type="button" id="saveDescriptionBtn" class="btn btn-success btn-sm" style="display:none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" id="shopPhone" class="form-control me-2" disabled>
                                    <button type="button" id="editPhoneBtn" class="btn btn-warning btn-sm">Edit</button>
                                    <button type="button" id="savePhoneBtn" class="btn btn-success btn-sm" style="display:none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">City</label>
                                <input type="text" id="shopCity" class="form-control" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Region</label>
                                <input type="text" id="shopRegion" class="form-control" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" id="shopCategory" class="form-control" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Address</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" id="shopAddress" class="form-control me-2" disabled>
                                    <button type="button" id="editAddressBtn" class="btn btn-warning btn-sm">Edit</button>
                                    <button type="button" id="saveAddressBtn" class="btn btn-success btn-sm" style="display:none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Location</label>
                                <div id="map" style="height: 200px; width: 100%; margin-bottom: 20px;"></div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" id="editLocationBtn" class="btn btn-warning btn-sm me-2">Edit</button>
                                    <button type="button" id="saveLocationBtn" class="btn btn-success btn-sm" style="display: none;">Save</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Opening Hours</label>
                                <div id="shopOpeningHours" class="border p-3 rounded bg-light text-dark"></div>
                            </div>
                        </form>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
             // Logout functionality
document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        // Call a logout endpoint to clear the cookie
        await fetch('/api/logout', {
            method: 'POST',
            credentials: 'include',
        });
        
        // Clear any client-side storage
        localStorage.clear();
        sessionStorage.clear();
        
        alert('You have been logged out.');
        window.location.href = 'registerLogin.html'; // Redirect to login page
    } catch (error) {
        console.error('Error during logout:', error);
        // If the fetch fails, still clear storage and redirect
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = 'registerLogin.html';
    }
});
        // Global shopId variable
        let shopId = null;
        let marker; // Global marker variable
    
        // Fetch General Shop Details
        async function fetchGeneralDetails() {
            try {
                const response = await fetch('/api/shop/generalDetails', {
                    method: 'GET',
                    credentials: 'include', // Include cookies in the request
                });
    
                if (!response.ok) throw new Error("Failed to fetch shop details");
                const shop = await response.json();
    
                // Set the global shopId variable
                shopId = shop._id || shop.id; // Χρησιμοποιήστε το σωστό πεδίο από την απάντηση
    
                // Update the fields with the populated data
                document.getElementById("shopName").value = shop.shopName || 'N/A';
                document.getElementById("shopDescription").value = shop.shopDescription || 'N/A';
                document.getElementById("shopPhone").value = shop.phone || 'N/A';
                document.getElementById("shopCity").value = shop.city?.name || 'N/A';
                document.getElementById("shopRegion").value = shop.region?.name || 'N/A';
                document.getElementById("shopCategory").value = shop.category?.name || 'N/A';
                document.getElementById("shopAddress").value = shop.address || 'N/A';
    
                // Display opening hours
                const openingHoursDiv = document.getElementById("shopOpeningHours");
                openingHoursDiv.innerHTML = Object.entries(shop.openingHours || {})
                    .map(([day, hours]) => `
                        <p>
                            <strong>${day.charAt(0).toUpperCase() + day.slice(1)}:</strong> 
                            ${hours.isOpen ? `${hours.open}:00 - ${hours.close}:00` : 'Closed'}
                        </p>
                    `)
                    .join('');

                // Display location on map
                if (shop.location?.coordinates) {
                    const [longitude, latitude] = shop.location.coordinates;
                    initializeMap(latitude, longitude);
                }
            } catch (error) {
                console.error("Error fetching general shop details:", error);
                alert("Failed to fetch shop details. Please try again later.");
            }
        }
    
        // Helper function to toggle edit/save buttons and enable/disable inputs
        function toggleEditSaveGeneral(editBtnId, saveBtnId, inputId, isEditing) {
            document.getElementById(editBtnId).style.display = isEditing ? "none" : "inline-block";
            document.getElementById(saveBtnId).style.display = isEditing ? "inline-block" : "none";
            if (inputId) {
                document.getElementById(inputId).disabled = !isEditing;
            }
        }
    
        // Function to send PATCH request for General Shop Details
        async function updateShopField(field, value) {
            try {
                const response = await fetch(`/api/shop/${shopId}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ [field]: value }),
                });
    
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error updating ${field}: ${error.message}`);
                    return false;
                }
    
                alert(`${field} updated successfully!`);
                return true;
            } catch (error) {
                console.error(`Error updating ${field}:`, error);
                alert(`Error updating ${field}. Please try again later.`);
                return false;
            }
        }
    
        // Event listeners for Shop Name
        document.getElementById("editNameBtn").addEventListener("click", () => {
            toggleEditSaveGeneral("editNameBtn", "saveNameBtn", "shopName", true);
        });
        document.getElementById("saveNameBtn").addEventListener("click", async () => {
            const newName = document.getElementById("shopName").value;
            if (await updateShopField("shopName", newName)) {
                toggleEditSaveGeneral("editNameBtn", "saveNameBtn", "shopName", false);
            }
        });
    
        // Event listeners for Shop Description
        document.getElementById("editDescriptionBtn").addEventListener("click", () => {
            toggleEditSaveGeneral("editDescriptionBtn", "saveDescriptionBtn", "shopDescription", true);
        });
        document.getElementById("saveDescriptionBtn").addEventListener("click", async () => {
            const newDescription = document.getElementById("shopDescription").value;
            if (await updateShopField("shopDescription", newDescription)) {
                toggleEditSaveGeneral("editDescriptionBtn", "saveDescriptionBtn", "shopDescription", false);
            }
        });
    
        // Event listeners for Shop Phone
        document.getElementById("editPhoneBtn").addEventListener("click", () => {
            toggleEditSaveGeneral("editPhoneBtn", "savePhoneBtn", "shopPhone", true);
        });
        document.getElementById("savePhoneBtn").addEventListener("click", async () => {
            const newPhone = document.getElementById("shopPhone").value;
            if (await updateShopField("phone", newPhone)) {
                toggleEditSaveGeneral("editPhoneBtn", "savePhoneBtn", "shopPhone", false);
            }
        });

        // Event listeners for Shop Address
        document.getElementById("editAddressBtn").addEventListener("click", () => {
            toggleEditSaveGeneral("editAddressBtn", "saveAddressBtn", "shopAddress", true);
        });
        document.getElementById("saveAddressBtn").addEventListener("click", async () => {
            const newAddress = document.getElementById("shopAddress").value;
            if (await updateShopField("address", newAddress)) {
                toggleEditSaveGeneral("editAddressBtn", "saveAddressBtn", "shopAddress", false);
            }
        });

        // Initialize Map with Mapbox
        async function initializeMap(latitude, longitude) {
            mapboxgl.accessToken = 'pk.eyJ1IjoicGFub3UyMSIsImEiOiJjbTlzcW9uYmkwM2k4MmpzYjc5dTF6M2ZtIn0.YBe_KPam5O4bdPh2xCpMdw';

            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [longitude, latitude],
                zoom: 14,
            });

            // Add marker to the map
            marker = new mapboxgl.Marker({ draggable: false })
                .setLngLat([longitude, latitude])
                .addTo(map);

            // Enable dragging and clicking when Edit is clicked
            document.getElementById("editLocationBtn").addEventListener("click", () => {
                marker.setDraggable(true);
                toggleEditSaveGeneral("editLocationBtn", "saveLocationBtn", null, true);

                // Allow clicking on the map to move the marker
                map.on('click', (e) => {
                    const lng = e.lngLat.lng;
                    const lat = e.lngLat.lat;
                    marker.setLngLat([lng, lat]); // Move marker to clicked location
                });
            });

            // Save new location when Save is clicked
            document.getElementById("saveLocationBtn").addEventListener("click", async () => {
                const newCoordinates = marker.getLngLat();
                const newLongitude = newCoordinates.lng;
                const newLatitude = newCoordinates.lat;

                const location = {
                    type: "Point",
                    coordinates: [newLongitude, newLatitude],
                };

                if (await updateShopField("location", location)) {
                    marker.setDraggable(false);
                    toggleEditSaveGeneral("editLocationBtn", "saveLocationBtn", null, false);
                }
            });
        }
    
        // Fetch General Shop Details on page load
        fetchGeneralDetails();
    </script>
</body>
</html>