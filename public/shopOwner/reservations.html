<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #menu {
        height: 100vh;
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        padding-top: 20px;
    }
    #menu h4 {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }
    #menu .nav-link {
        color: #000;
        padding: 10px 15px;
        border-radius: 5px;
        transition: background-color 0.3s, color 0.3s;
    }
    #menu .nav-link:hover {
        background-color: #e9ecef;
        color: #007bff;
    }
    #menu .nav-link.active {
        background-color: #007bff;
        color: #fff;
    }
    #menu .nav-link i {
        font-size: 1.2rem;
    }
        #content {
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Left Menu -->
            <div id="menu-container" class="col-md-3">
                <!-- Include the external menu -->
                <div id="menu"></div>
            </div>
            <!-- Right Content -->
            <div id="content" class="col-md-9">
                <section id="reservations" class="mt-5">
                    <div class="container">
                      <h2>Reservations</h2>
                      <!-- Bar επιλογών για φιλτράρισμα -->
                      <ul class="nav nav-tabs mb-3" id="reservationTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" type="button" onclick="fetchReservations('pending')">Pending</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="accepted-tab" data-bs-toggle="tab" type="button" onclick="fetchReservations('accepted')">Accepted</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="completed-tab" data-bs-toggle="tab" type="button" onclick="fetchReservations('completed')">Completed</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="notShown-tab" data-bs-toggle="tab" type="button" onclick="fetchReservations('notShown')">Not Shown</button>
  </li>
</ul>

                      <!-- Scrollable list of days -->
                      <div id="reservationsDaysList" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;"></div>

                      <!-- Container for reservations for the selected day -->
                      <div id="reservationsList" class="row gy-3"></div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        // Load the external menu dynamically
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const menuContainer = document.getElementById('menu');
                const response = await fetch('./components/menu.html');
                if (response.ok) {
                    menuContainer.innerHTML = await response.text();
                } else {
                    console.error('Failed to load menu:', response.status);
                }
            } catch (error) {
                console.error('Error loading menu:', error);
            }
        });

        // Helper functions
        function groupReservationsByDate(reservationsArray) {
  if (!Array.isArray(reservationsArray)) {
    console.error('Error: reservationsArray is not an array', reservationsArray);
    return {};
  }

  const grouped = {};
  reservationsArray.forEach(reservation => {
    if (reservation.reservationDate) {
      const dateKey = new Date(reservation.reservationDate).toISOString().split('T')[0];
      if (!grouped[dateKey]) {
        grouped[dateKey] = [];
      }
      grouped[dateKey].push(reservation);
    }
  });
  return grouped;
}

        function formatDate_dd_mm_yy(isoDateStr) {
            const dateObj = new Date(isoDateStr);
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const yy = String(dateObj.getFullYear()).slice(-2);
            return `${dd}-${mm}-${yy}`;
        }

        function getDayOfWeek(isoDateStr) {
            const dateObj = new Date(isoDateStr);
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            return days[dateObj.getDay()];
        }

        // Render the scrollable list of reservation days
        function renderDaysList(groupedReservations) {
  const daysListDiv = document.getElementById("reservationsDaysList");
  daysListDiv.innerHTML = "";

  const sortedDates = Object.keys(groupedReservations).sort();

  sortedDates.forEach(dateKey => {
    if (groupedReservations[dateKey].length > 0) {
      const formattedDate = formatDate_dd_mm_yy(dateKey);
      const dayOfWeek = getDayOfWeek(dateKey);
      const btn = document.createElement("button");
      btn.className = "list-group-item list-group-item-action";
      btn.textContent = `${formattedDate} - ${dayOfWeek}`;
      btn.onclick = function () {
        renderReservationsForDay(groupedReservations[dateKey]);
      };
      daysListDiv.appendChild(btn);
    }
  });

  if (daysListDiv.innerHTML === "") {
    daysListDiv.innerHTML = "<p class='text-center'>No reservations available.</p>";
    document.getElementById("reservationsList").innerHTML = "";
  }
}

        // Render reservations for a specific day
        async function renderReservationsForDay(reservationsArray) {
  const reservationsListDiv = document.getElementById("reservationsList");
  reservationsListDiv.innerHTML = "";

  if (reservationsArray.length === 0) {
    reservationsListDiv.innerHTML = "<p class='text-center'>No reservations for this day.</p>";
    return;
  }

  for (const reservation of reservationsArray) {
    let tableNumber = "N/A";
    if (reservation.tableId) {
      try {
        const response = await fetch(`/api/table/${reservation.tableId}`);
        if (response.ok) {
          const table = await response.json();
          tableNumber = table.tableNumber || "N/A";
        }
      } catch (error) {
        console.error("Error fetching table details:", error);
      }
    }

    const hours = Math.floor(reservation.reservationTime);
    const minutes = Math.round((reservation.reservationTime % 1) * 60);
    const formattedTime = `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`;

    reservationsListDiv.innerHTML += `
      <div class="col-md-4" data-reservation-id="${reservation._id}" data-state="${reservation.state}">
        <div class="card mb-3">
          <div class="card-header">Reservation #${reservation._id}</div>
          <div class="card-body">
            <p><strong>Name:</strong> ${reservation.name || "N/A"}</p>
            <p><strong>Surname:</strong> ${reservation.surname || "N/A"}</p>
            <p><strong>Table Number:</strong> 
              <span class="table-number">${reservation.tableId ? tableNumber : `
                <span class="text-danger" title="This reservation does not have a table assigned">
                  N/A <i class="bi bi-exclamation-circle-fill"></i>
                </span>`}
              </span>
            </p>
            <p><strong>Date:</strong> ${reservation.reservationDate ? new Date(reservation.reservationDate).toLocaleDateString() : "N/A"}</p>
            <p><strong>Hour:</strong> ${formattedTime}</p>
            <p><strong>Seats:</strong> ${reservation.seats || "N/A"}</p>
            <p><strong>State:</strong> ${reservation.state}</p>
            <p><strong>Comment:</strong> ${reservation.commentFromUser || "N/A"}</p>
            ${reservation.state === 'pending' ? `
              <button class="btn btn-success btn-sm" onclick="acceptReservation('${reservation._id}')">Accept</button>
              <button class="btn btn-danger btn-sm" onclick="deleteReservation('${reservation._id}')">Delete</button>
              ${!reservation.tableId ? `<button class="btn btn-primary btn-sm find-table-btn" onclick="findAndAssignTable('${reservation._id}', '${reservation.reservationDate}', '${reservation.reservationTime}', ${reservation.seats})">Find Table</button>` : ''}
            ` : reservation.state === 'accepted' ? `
              <button class="btn btn-secondary btn-sm" onclick="markAsCompleted('${reservation._id}')">Completed</button>
              <button class="btn btn-warning btn-sm" onclick="markAsNotShown('${reservation._id}')">Not Shown</button>
              <button class="btn btn-danger btn-sm" onclick="deleteReservation('${reservation._id}')">Delete</button>
              ${!reservation.tableId ? `<button class="btn btn-primary btn-sm find-table-btn" onclick="findAndAssignTable('${reservation._id}', '${reservation.reservationDate}', '${reservation.reservationTime}', ${reservation.seats})">Find Table</button>` : ''}
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }
}

        // Fetch reservations
        async function fetchReservations(stateFilter = 'all') {
  try {
    const allReservationsResponse = await fetch('/api/shop/reservationList');
    if (!allReservationsResponse.ok) throw new Error('Failed to fetch all reservations');
    const allReservationsData = await allReservationsResponse.json();

    let reservationsToDisplay = [];

    if (allReservationsData && typeof allReservationsData === 'object') {
      Object.values(allReservationsData.reservationList).forEach(dateGroup => {
        if (Array.isArray(dateGroup.reservations)) {
          reservationsToDisplay = reservationsToDisplay.concat(dateGroup.reservations);
        }
      });
    } else {
      console.error('Error: reservationList is not in the expected format', allReservationsData);
    }

    // Αν το stateFilter δεν είναι "all", φιλτράρουμε τις κρατήσεις
    if (stateFilter !== 'all') {
      const filterResponse = await fetch(`/api/reservations/filter?state=${stateFilter}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reservationList: reservationsToDisplay }),
      });

      if (!filterResponse.ok) throw new Error('Failed to filter reservations');
      const filteredData = await filterResponse.json();
      reservationsToDisplay = filteredData.filteredReservations;
    }

    // Υπολογισμός κρατήσεων χωρίς tableId
    const unassignedCount = reservationsToDisplay.filter(reservation => !reservation.tableId).length;

    // Ενημέρωση του θαυμαστικού με το count, εκτός από τις καρτέλες `completed` και `notShown`
    if (!['completed', 'notShown'].includes(stateFilter)) {
      const stateTab = document.getElementById(`${stateFilter}-tab`);
      if (stateTab) {
        stateTab.innerHTML = `${stateFilter.charAt(0).toUpperCase() + stateFilter.slice(1)} 
          ${unassignedCount > 0 ? `<span class="text-danger" title="${unassignedCount} κρατήσεις δεν έχουν τραπέζι">
            <i class="bi bi-exclamation-circle-fill"></i> (${unassignedCount})
          </span>` : ''}`;
      }
    }

    displayGroupedReservations(reservationsToDisplay);
  } catch (error) {
    console.error('Error fetching reservations:', error);
  }
}

        // Display grouped reservations
        function displayGroupedReservations(reservationsArray) {
  if (!Array.isArray(reservationsArray) || reservationsArray.length === 0) {
    document.getElementById("reservationsList").innerHTML = "<p class='text-center'>No reservations found.</p>";
    document.getElementById("reservationsDaysList").innerHTML = "<p class='text-center'>No reservations available.</p>";
    return;
  }

  const grouped = groupReservationsByDate(reservationsArray);

  renderDaysList(grouped);

  const sortedDates = Object.keys(grouped).sort();
  if (sortedDates.length > 0) {
    renderReservationsForDay(grouped[sortedDates[0]]);
  } else {
    document.getElementById("reservationsList").innerHTML = "<p class='text-center'>No reservations found.</p>";
  }
}

        // Delete reservation
        async function deleteReservation(reservationId) {
            if (confirm("Are you sure you want to delete this reservation?")) {
                try {
                    const response = await fetch(`/api/reservation/${reservationId}`, {
                        method: 'DELETE',
                        credentials: 'include', // Include cookies for authentication
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        alert(`Error deleting reservation: ${error.message}`);
                        return;
                    }

                    alert("Reservation deleted successfully!");
                    fetchReservations(); // Ανανεώστε τη λίστα κρατήσεων
                } catch (error) {
                    console.error("Error deleting reservation:", error);
                    alert("Failed to delete reservation. Please try again later.");
                }
            }
        }

        // Accept reservation
async function acceptReservation(reservationId) {
  try {
    const response = await fetch(`/api/reservation/${reservationId}/state`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ state: 'accepted' }),
    });

    if (!response.ok) {
      const error = await response.json();
      alert(`Error accepting reservation: ${error.message}`);
      return;
    }

    alert("Reservation accepted successfully!");
    fetchReservations('pending'); // Ανανεώστε τη λίστα των pending κρατήσεων
  } catch (error) {
    console.error("Error accepting reservation:", error);
    alert("Failed to accept reservation. Please try again later.");
  }
}

async function rejectReservation(reservationId) {
  if (confirm("Are you sure you want to reject this reservation?")) {
    try {
      const response = await fetch(`/api/reservation/${reservationId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const error = await response.json();
        alert(`Error rejecting reservation: ${error.message}`);
        return;
      }

      alert("Reservation rejected successfully!");
      fetchReservations('pending'); // Ανανεώστε τη λίστα των pending κρατήσεων
    } catch (error) {
      console.error("Error rejecting reservation:", error);
      alert("Failed to reject reservation. Please try again later.");
    }
  }
}

async function markAsCompleted(reservationId) {
  try {
    const response = await fetch(`/api/reservation/${reservationId}/state`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ state: 'completed' }),
    });

    if (!response.ok) {
      const error = await response.json();
      alert(`Error marking reservation as completed: ${error.message}`);
      return;
    }

    alert("Reservation marked as completed successfully!");
    fetchReservations('accepted'); // Ανανεώστε τη λίστα των accepted κρατήσεων
  } catch (error) {
    console.error("Error marking reservation as completed:", error);
    alert("Failed to mark reservation as completed. Please try again later.");
  }
}

async function markAsNotShown(reservationId) {
  try {
    const response = await fetch(`/api/reservation/${reservationId}/state`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ state: 'notShown' }),
    });

    if (!response.ok) {
      const error = await response.json();
      alert(`Error marking reservation as not shown: ${error.message}`);
      return;
    }

    alert("Reservation marked as not shown successfully!");
    fetchReservations('accepted'); // Ανανεώστε τη λίστα των accepted κρατήσεων
  } catch (error) {
    console.error("Error marking reservation as not shown:", error);
    alert("Failed to mark reservation as not shown. Please try again later.");
  }
}
        // Fetch pending κρατήσεις κατά την αρχική φόρτωση
fetchReservations('pending');

async function findAndAssignTable(reservationId, reservationDate, reservationTime, seats) {
  try {
    console.log("Sending data to find table:", {
      reservationId,
      reservationDate,
      reservationTime,
      seats,
    });

    const response = await fetch(`/api/reservation/${reservationId}/findTable`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reservationDate, reservationTime, seats }),
    });

    if (!response.ok) {
      const error = await response.json();
      console.error("Error response from backend:", error);
      alert(`Error finding table: ${error.message}`);
      return;
    }

    const result = await response.json();
    console.log("Table assigned successfully:", result);
    alert(`Table assigned successfully! Table Number: ${result.tableNumber}`);

    // Ενημέρωση της συγκεκριμένης κράτησης στη λίστα
    const reservationCard = document.querySelector(`[data-reservation-id="${reservationId}"]`);
    if (reservationCard) {
      const tableNumberElement = reservationCard.querySelector(".table-number");
      if (tableNumberElement) {
        tableNumberElement.innerHTML = result.tableNumber;
      }

      // Αφαιρούμε το κουμπί "Find Table" αφού έχει ανατεθεί τραπέζι
      const findTableButton = reservationCard.querySelector(".find-table-btn");
      if (findTableButton) {
        findTableButton.remove();
      }
    }

    // Ενημέρωση των προειδοποιητικών
    updateWarnings();
  } catch (error) {
    console.error("Error finding and assigning table:", error);
    alert("Failed to find and assign table. Please try again later.");
  }
}

function updateWarnings() {
  const tabs = ['pending', 'accepted'];
  tabs.forEach(async (state) => {
    const reservations = Array.from(document.querySelectorAll(`[data-state="${state}"]`));
    const unassignedCount = reservations.filter(reservation => reservation.querySelector(".table-number").textContent === "N/A").length;

    const stateTab = document.getElementById(`${state}-tab`);
    if (stateTab) {
      stateTab.innerHTML = `${state.charAt(0).toUpperCase() + state.slice(1)} 
        ${unassignedCount > 0 ? `<span class="text-danger" title="${unassignedCount} κρατήσεις δεν έχουν τραπέζι">
          <i class="bi bi-exclamation-circle-fill"></i> (${unassignedCount})
        </span>` : ''}`;
    }
  });
}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>