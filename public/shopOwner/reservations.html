<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        body.shopowner-has-menu { margin-top: 64px !important; }
        #content {
            padding: 20px;
        }
        /* Προσθήκη margin-top για να μην καλύπτονται τα sections από το μενού */
        #pendingSection,
        #content {
            margin-top: 70px;
        }
        @media (max-width: 768px) {
            #pendingSection,
            #content {
                margin-top: 80px;
            }
        }
        /* Calendar styles */
        #calendarContainer {
            max-width: 340px;
            margin: 0 auto 2rem auto;
            background: #f8f9fa;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.10);
            padding: 1.2rem 1.2rem 1rem 1.2rem;
        }
        .flatpickr-calendar {
            display: block !important;
            position: static !important;
            box-shadow: none;
            background: transparent;
            margin-bottom: 0;
            width: 100%;
            min-width: 220px;
            font-size: 1rem;
        }
        .flatpickr-months {
            margin-bottom: 0.7rem;
        }
        .flatpickr-day {
            width: 3.5rem;
            height: 3.5rem;
            line-height: 3.5rem;
            font-size: 1.35rem;
            margin: 0.22rem;
            border-radius: 14px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }
        .flatpickr-day.selected, .flatpickr-day.today {
            background: #007bff;
            color: #fff;
            font-size: 1.65rem;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        }
        .flatpickr-day:hover {
            background: #e3f0ff;
            color: #007bff;
        }
        .flatpickr-weekdays {
            font-size: 1.18rem;
            font-weight: 600;
        }
        .flatpickr-current-month input.cur-year {
            font-size: 1.28rem;
            font-weight: 600;
        }
#pendingBar {
  max-height: 420px;
  overflow-y: auto;
  margin-bottom: 1.5rem;
}
#pendingBar .list-group-item {
  cursor: pointer;
}
    </style>
</head>
<body>
    <div id="menu"></div>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const menuContainer = document.getElementById('menu');
        const response = await fetch('./components/menu.html');
        if (response.ok) {
            menuContainer.innerHTML = await response.text();
        }
    });
    </script>
    <div class="container-fluid">
        <div class="row">
            <!-- Pending Bar Left -->
            <div class="col-md-4 mb-4">
                <section id="pendingSection">
                    <h2 id="pendingHeadline" class="mb-2">
                        Pending Reservations (<span id="pendingCount">0</span>)
                    </h2>
                    <div id="pendingBar" class="mb-3" style="max-height: 80vh; overflow-y: auto;"></div>
                </section>
            </div>
            <!-- Reservations Right -->
            <div id="content" class="col-md-8">
                <section id="reservations" class="mt-3">
                    <!-- Headline για τα υπόλοιπα -->
                    <h3 class="mb-3">Reservations</h3>
                    <!-- State bar -->
                    <ul class="nav nav-tabs mb-3" id="reservationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="accepted-tab" data-bs-toggle="tab" type="button" onclick="onTabClick('accepted')">Accepted</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" type="button" onclick="fetchReservations('completed')">Completed</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="notShown-tab" data-bs-toggle="tab" type="button" onclick="fetchReservations('notShown')">Not Shown</button>
                        </li>
                    </ul>
                    <!-- Scrollable list of days -->
                    <div id="reservationsDaysList" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;"></div>
                    <!-- Calendar -->
                    <div id="calendarContainer" class="mb-4"></div>
                    <!-- Reservations list -->
                    <div id="reservationsDayTitle" class="h5 mb-2"></div>
                    <div id="reservationsList" class="row gy-3"></div>
                </section>
            </div>
        </div>
    </div> <!-- Κλείσιμο .container-fluid -->
    <!-- Floor Plan σε όλο το πλάτος -->
    <div id="floorPanelsSection" class="mt-5 container-fluid" style="width:100%;">
      <h4 class="mb-3">Διαθεσιμότητα τραπεζιών ανα ώρα</h4>
      <!-- Datepicker και time slots θα μπουν δυναμικά εδώ -->
      <div id="floorPanelDatePicker"></div>
      <div id="floorPanelSlotsBar"></div>
      <div id="floorPanelsContainer" class="d-flex flex-wrap gap-4"></div>
    </div>

    <script>
        let currentStateFilter = 'accepted';

        // Load the external menu dynamically
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const menuContainer = document.getElementById('menu');
                const response = await fetch('./components/menu.html');
                if (response.ok) {
                    menuContainer.innerHTML = await response.text();
                } else {
                    console.error('Failed to load menu:', response.status);
                }
            } catch (error) {
                console.error('Error loading menu:', error);
            }

            await renderPendingBar();
            await fetchReservations(currentStateFilter); // Χρησιμοποίησε το global state
        });

        // Helper functions
        function groupReservationsByDate(reservationsArray) {
  if (!Array.isArray(reservationsArray)) {
    console.error('Error: reservationsArray is not an array', reservationsArray);
    return {};
  }

  const grouped = {};
  reservationsArray.forEach(reservation => {
    if (reservation.reservationDate) {
      const dateKey = new Date(reservation.reservationDate).toISOString().split('T')[0];
      if (!grouped[dateKey]) {
        grouped[dateKey] = [];
      }
      grouped[dateKey].push(reservation);
    }
  });
  return grouped;
}

        function formatDate_dd_mm_yy(isoDateStr) {
            const dateObj = new Date(isoDateStr);
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const yy = String(dateObj.getFullYear()).slice(-2);
            return `${dd}-${mm}-${yy}`;
        }

        function getDayOfWeek(isoDateStr) {
            const dateObj = new Date(isoDateStr);
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            return days[dateObj.getDay()];
        }

        // Render the scrollable list of reservation days
        function renderDaysList(groupedReservations) {
  const daysListDiv = document.getElementById("reservationsDaysList");
  daysListDiv.innerHTML = "";

  const sortedDates = Object.keys(groupedReservations).sort();

  sortedDates.forEach(dateKey => {
    if (groupedReservations[dateKey].length > 0) {
      const formattedDate = formatDate_dd_mm_yy(dateKey);
      const dayOfWeek = getDayOfWeek(dateKey);
      const btn = document.createElement("button");
      btn.className = "list-group-item list-group-item-action";
      btn.textContent = `${formattedDate} - ${dayOfWeek}`;
      btn.onclick = function () {
        renderReservationsForDay(groupedReservations[dateKey]);
      };
      daysListDiv.appendChild(btn);
    }
  });

  if (daysListDiv.innerHTML === "") {
    daysListDiv.innerHTML = "<p class='text-center'>No reservations available.</p>";
    document.getElementById("reservationsList").innerHTML = "";
  }
}

        // Render reservations for a specific day
        async function renderReservationsForDay(reservationsArray, state = currentStateFilter, dateStr = null) {
  const reservationsListDiv = document.getElementById("reservationsList");
  const titleDiv = document.getElementById("reservationsDayTitle");
  reservationsListDiv.innerHTML = "";

  // Βρες ημερομηνία και ημέρα
  let dayOfWeek = "";
  let formattedDate = "";
  if (reservationsArray.length > 0) {
    const date = reservationsArray[0].reservationDate;
    const dateObj = new Date(date);
    dayOfWeek = getDayOfWeek(dateObj);
    formattedDate = formatDate_dd_mm_yy(dateObj);
  } else if (dateStr) {
    const dateObj = new Date(dateStr);
    dayOfWeek = getDayOfWeek(dateObj);
    formattedDate = formatDate_dd_mm_yy(dateObj);
  }

  // Μετατροπή state σε ελληνικό/αγγλικό label αν θες
  const stateLabels = {
    accepted: "Accepted",
    completed: "Completed",
    notShown: "Not Shown"
  };
  const stateLabel = stateLabels[state] || state;

  titleDiv.textContent = `${stateLabel} Κρατήσεις για ${dayOfWeek}, ${formattedDate}`;

  if (!reservationsArray.length) {
    reservationsListDiv.innerHTML = "<p class='text-center'>No reservations for this day.</p>";
    return;
  }

  // Δημιουργία λίστας Promises για κάθε reservation
  const reservationItems = await Promise.all(reservationsArray.map(async (reservation) => {
    let tableNumber = "N/A";
    if (reservation.tableId) {
      try {
        const response = await fetch(`/api/table/${reservation.tableId}`);
        if (response.ok) {
          const table = await response.json();
          tableNumber = table.tableNumber || "N/A";
        }
      } catch (error) {
        console.error("Error fetching table details:", error);
      }
    }

    const formattedTime = formatHour(reservation.reservationTime);

    return `
      <button class="list-group-item list-group-item-action"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#reservationDetails_${reservation._id}"
        aria-expanded="false"
        aria-controls="reservationDetails_${reservation._id}">
        ${reservation.reservationDate ? new Date(reservation.reservationDate).toLocaleDateString() : ''} 
        ${typeof reservation.reservationTime !== 'undefined' ? formattedTime : ''} - 
        ${reservation.name || ''} ${reservation.surname || ''} - 
        <strong>${reservation._id}</strong>
      </button>
      <div class="collapse" id="reservationDetails_${reservation._id}">
        <div class="card card-body mb-2">
          <p><strong>Name:</strong> ${reservation.name || "N/A"}</p>
          <p><strong>Surname:</strong> ${reservation.surname || "N/A"}</p>
          <p><strong>Table Number:</strong> 
            <span class="table-number">${reservation.tableId ? tableNumber : `
              <span class="text-danger" title="This reservation does not have a table assigned">
                N/A <i class="bi bi-exclamation-circle-fill"></i>
              </span>`}
            </span>
          </p>
          <p><strong>Date:</strong> ${reservation.reservationDate ? new Date(reservation.reservationDate).toLocaleDateString() : "N/A"}</p>
          <p><strong>Hour:</strong> ${formattedTime}</p>
          <p><strong>Seats:</strong> ${reservation.seats || "N/A"}</p>
          <p><strong>State:</strong> ${reservation.state}</p>
          <p><strong>Comment:</strong> ${reservation.commentFromUser || "N/A"}</p>
          ${reservation.state === 'accepted' ? `
            <button class="btn btn-secondary btn-sm" onclick="markAsCompleted('${reservation._id}')">Completed</button>
            <button class="btn btn-warning btn-sm" onclick="markAsNotShown('${reservation._id}')">Not Shown</button>
            <button class="btn btn-danger btn-sm" onclick="deleteReservation('${reservation._id}')">Delete</button>
            ${!reservation.tableId ? `<button class="btn btn-primary btn-sm find-table-btn" onclick="findAndAssignTable('${reservation._id}', '${reservation.reservationDate}', '${reservation.reservationTime}', ${reservation.seats})">Find Table</button>` : ''}
          ` : reservation.state === 'completed' || reservation.state === 'notShown' ? `
            <button class="btn btn-danger btn-sm" onclick="deleteReservation('${reservation._id}')">Delete</button>
          ` : ''}
        </div>
      </div>
    `;
  }));

  reservationsListDiv.innerHTML = `
    <div class="list-group" style="max-height: 420px; overflow-y: auto;">
      ${reservationItems.join("")}
    </div>
  `;
}

        // Fetch reservations
        async function fetchReservations(stateFilter = 'accepted') {
  try {
    const allReservationsResponse = await fetch('/api/shop/reservationList');
    if (!allReservationsResponse.ok) throw new Error('Failed to fetch all reservations');
    const allReservationsData = await allReservationsResponse.json();

    let reservationsToDisplay = [];

    if (allReservationsData && typeof allReservationsData === 'object') {
      Object.values(allReservationsData.reservationList).forEach(dateGroup => {
        if (Array.isArray(dateGroup.reservations)) {
          // Εξαίρεσε τις pending από το κάτω section
          reservationsToDisplay = reservationsToDisplay.concat(
            dateGroup.reservations.filter(r => r.state !== 'pending')
          );
        }
      });
    } else {
      console.error('Error: reservationList is not in the expected format', allReservationsData);
    }

    // Αν το stateFilter δεν είναι "all", φιλτράρουμε τις κρατήσεις
    if (stateFilter !== 'all') {
      const filterResponse = await fetch(`/api/reservations/filter?state=${stateFilter}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reservationList: reservationsToDisplay }),
      });

      if (!filterResponse.ok) throw new Error('Failed to filter reservations');
      const filteredData = await filterResponse.json();
      reservationsToDisplay = filteredData.filteredReservations;
    }

    // Υπολογισμός κρατήσεων χωρίς tableId
    const unassignedCount = reservationsToDisplay.filter(reservation => !reservation.tableId).length;

    // Ενημέρωση του θαυμαστικού με το count, εκτός από τις καρτέλες `completed` και `notShown`
    if (!['completed', 'notShown'].includes(stateFilter)) {
      const stateTab = document.getElementById(`${stateFilter}-tab`);
      if (stateTab) {
        stateTab.innerHTML = `${stateFilter.charAt(0).toUpperCase() + stateFilter.slice(1)} 
          ${unassignedCount > 0 ? `<span class="text-danger" title="${unassignedCount} κρατήσεις δεν έχουν τραπέζι">
            <i class="bi bi-exclamation-circle-fill"></i> (${unassignedCount})
          </span>` : ''}`;
      }
    }

    displayGroupedReservations(reservationsToDisplay);
  } catch (error) {
    console.error('Error fetching reservations:', error);
  }
}

        // Display grouped reservations
        function displayGroupedReservations(reservationsArray) {
  if (!Array.isArray(reservationsArray) || reservationsArray.length === 0) {
    document.getElementById("reservationsList").innerHTML = "<p class='text-center'>No reservations found.</p>";
    document.getElementById("reservationsDayTitle").textContent = "";
    return;
  }

  const grouped = groupReservationsByDate(reservationsArray);

  setupCalendar(grouped);

  const sortedDates = Object.keys(grouped).sort();
  if (sortedDates.length > 0) {
    // Περνάμε πάντα το currentStateFilter!
    renderReservationsForDay(grouped[sortedDates[0]], currentStateFilter, sortedDates[0]);
    if (window.flatpickrInstance) {
      window.flatpickrInstance.setDate(sortedDates[0], true);
    }
  } else {
    document.getElementById("reservationsList").innerHTML = "<p class='text-center'>No reservations found.</p>";
    document.getElementById("reservationsDayTitle").textContent = "";
  }
}

        // Delete reservation
        async function deleteReservation(reservationId, closePending) {
            if (confirm("Are you sure you want to delete this reservation?")) {
                try {
                    const response = await fetch(`/api/reservation/${reservationId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        alert(`Error deleting reservation: ${error.message}`);
                        return;
                    }

                    alert("Reservation deleted successfully!");
                    if (closePending) closePendingReservationDetails(reservationId);
                    await fetchReservations(currentStateFilter); // <-- Εδώ!
                    await renderPendingBar();
                } catch (error) {
                    console.error("Error deleting reservation:", error);
                    alert("Failed to delete reservation. Please try again later.");
                }
            }
        }

        // Accept reservation
async function acceptReservation(reservationId, closePending) {
  try {
    const response = await fetch(`/api/reservation/${reservationId}/state`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ state: 'accepted' }),
    });

    if (!response.ok) {
      const error = await response.json();
      alert(`Error accepting reservation: ${error.message}`);
      return;
    }

    alert("Reservation accepted successfully!");
    if (closePending) closePendingReservationDetails(reservationId);
    fetchReservations('pending');
    await renderPendingBar();
  } catch (error) {
    console.error("Error accepting reservation:", error);
    alert("Failed to accept reservation. Please try again later.");
  }
}

async function rejectReservation(reservationId) {
  if (confirm("Are you sure you want to reject this reservation?")) {
    try {
      const response = await fetch(`/api/reservation/${reservationId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const error = await response.json();
        alert(`Error rejecting reservation: ${error.message}`);
        return;
      }

      alert("Reservation rejected successfully!");
      fetchReservations('pending'); // Ανανεώστε τη λίστα των pending κρατήσεων
    } catch (error) {
      console.error("Error rejecting reservation:", error);
      alert("Failed to reject reservation. Please try again later.");
    }
  }
}

async function markAsCompleted(reservationId) {
  try {
    const response = await fetch(`/api/reservation/${reservationId}/state`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ state: 'completed' }),
    });

    if (!response.ok) {
      const error = await response.json();
      alert(`Error marking reservation as completed: ${error.message}`);
      return;
    }

    alert("Reservation marked as completed successfully!");
    fetchReservations('accepted'); // Ανανεώστε τη λίστα των accepted κρατήσεων
  } catch (error) {
    console.error("Error marking reservation as completed:", error);
    alert("Failed to mark reservation as completed. Please try again later.");
  }
}

async function markAsNotShown(reservationId) {
  try {
    const response = await fetch(`/api/reservation/${reservationId}/state`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ state: 'notShown' }),
    });

    if (!response.ok) {
      const error = await response.json();
      alert(`Error marking reservation as not shown: ${error.message}`);
      return;
    }

    alert("Reservation marked as not shown successfully!");
    fetchReservations('accepted'); // Ανανεώστε τη λίστα των accepted κρατήσεων
  } catch (error) {
    console.error("Error marking reservation as not shown:", error);
    alert("Failed to mark reservation as not shown. Please try again later.");
  }
}
        // Fetch pending κρατήσεις κατά την αρχική φόρτωση
fetchReservations('pending');

async function findAndAssignTable(reservationId, reservationDate, reservationTime, seats, closePending) {
  try {
    console.log("Sending data to find table:", {
      reservationId,
      reservationDate,
      reservationTime,
      seats,
    });

    const response = await fetch(`/api/reservation/${reservationId}/findTable`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reservationDate, reservationTime, seats }),
    });

    if (!response.ok) {
      const error = await response.json();
      console.error("Error response from backend:", error);
      alert(`Error finding table: ${error.message}`);
      return;
    }

    const result = await response.json();
    console.log("Table assigned successfully:", result);
    alert(`Table assigned successfully! Table Number: ${result.tableNumber}`);
    if (closePending) closePendingReservationDetails(reservationId);
    updateWarnings();
    await renderPendingBar();
  } catch (error) {
    console.error("Error finding and assigning table:", error);
    alert("Failed to find and assign table. Please try again later.");
  }
}

function updateWarnings() {
  const tabs = ['accepted', 'completed', 'notShown'];
  tabs.forEach(async (state) => {
    const reservations = Array.from(document.querySelectorAll(`[data-state="${state}"]`));
    const unassignedCount = reservations.filter(reservation => reservation.querySelector(".table-number").textContent === "N/A").length;

    const stateTab = document.getElementById(`${state}-tab`);
    if (stateTab) {
      stateTab.innerHTML = `${state.charAt(0).toUpperCase() + state.slice(1)} 
        ${unassignedCount > 0 ? `<span class="text-danger" title="${unassignedCount} κρατήσεις δεν έχουν τραπέζι">
          <i class="bi bi-exclamation-circle-fill"></i> (${unassignedCount})
        </span>` : ''}`;
    }
  });
}

// Calendar setup
let availableDates = []; // Θα γεμίσει με τα dates που υπάρχουν κρατήσεις

function setupCalendar(groupedReservations) {
  availableDates = Object.keys(groupedReservations);

  document.getElementById("calendarContainer").innerHTML = `<input id="calendarFlatpickr" type="text" style="width:100%;background:transparent;border:none;outline:none;" readonly />`;

  if (window.flatpickrInstance) {
    window.flatpickrInstance.destroy();
  }

  window.flatpickrInstance = flatpickr("#calendarFlatpickr", {
    inline: true,
    enable: availableDates,
    locale: "default",
    highlightToday: false, // <-- δεν υπάρχει στο flatpickr, το κάνουμε με CSS
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      // Αφαιρούμε το today highlight αν δεν είναι selected (για σιγουριά)
      if (dayElem.classList.contains('today') && !dayElem.classList.contains('selected')) {
        dayElem.classList.remove('today');
      }
    },
    onChange: function(selectedDates, dateStr) {
      if (availableDates.includes(dateStr)) {
        renderReservationsForDay(groupedReservations[dateStr], currentStateFilter, dateStr);
      } else {
        document.getElementById("reservationsList").innerHTML = "<p class='text-center'>No reservations for this day.</p>";
        document.getElementById("reservationsDayTitle").textContent = "";
      }
    }
  });
}

async function renderPendingBar() {
  try {
    const response = await fetch('/api/shop/reservationList');
    if (!response.ok) throw new Error('Failed to fetch reservations');
    const data = await response.json();

    let pendingReservations = [];
    if (data && typeof data === 'object') {
      Object.values(data.reservationList).forEach(dateGroup => {
        if (Array.isArray(dateGroup.reservations)) {
          pendingReservations = pendingReservations.concat(
            dateGroup.reservations.filter(r => r.state === 'pending')
          );
        }
      });
    }

    // Sort by date/time (προαιρετικά)
    pendingReservations.sort((a, b) => {
      if (a.reservationDate === b.reservationDate) {
        return a.reservationTime - b.reservationTime;
      }
      return new Date(a.reservationDate) - new Date(b.reservationDate);
    });

    // Ενημέρωσε το πλήθος
    document.getElementById("pendingCount").textContent = pendingReservations.length;

    // Show up to 10, scrollable (τώρα δείχνει όλα, με scroll)
    const toShow = pendingReservations;

    const pendingBarDiv = document.getElementById("pendingBar");
    if (toShow.length === 0) {
      pendingBarDiv.innerHTML = `<div class="alert alert-info mb-0">No pending reservations.</div>`;
      return;
    }

    pendingBarDiv.innerHTML = `
      <div class="list-group">
        ${toShow.map(r => `
          <button type="button" class="list-group-item list-group-item-action"
            onclick="showPendingReservationDetails('${r._id}')">
            ${r.reservationDate ? new Date(r.reservationDate).toLocaleDateString() : ''} 
            ${typeof r.reservationTime !== 'undefined' ? formatHour(r.reservationTime) : ''} - 
            ${r.name || ''} ${r.surname || ''} - 
            <strong>${r._id}</strong>
          </button>
          <div class="collapse" id="pendingDetails_${r._id}"></div>
        `).join("")}
      </div>
    `;
  } catch (error) {
    document.getElementById("pendingBar").innerHTML = `<div class="alert alert-danger mb-0">Error loading pending reservations.</div>`;
    console.error(error);
  }
}

// Εμφάνιση λεπτομερειών κράτησης όταν πατιέται
async function showPendingReservationDetails(reservationId) {
  // Κλείσε όλα τα άλλα
  document.querySelectorAll('#pendingBar .collapse').forEach(div => div.classList.remove('show'));

  // Βρες τα δεδομένα της κράτησης
  const response = await fetch('/api/shop/reservationList');
  const data = await response.json();
  let reservation = null;
  Object.values(data.reservationList).forEach(dateGroup => {
    if (Array.isArray(dateGroup.reservations)) {
      const found = dateGroup.reservations.find(r => r._id === reservationId);
      if (found) reservation = found;
    }
  });
  if (!reservation) return;

  // Φέρε table number αν υπάρχει
  let tableNumber = "N/A";
  if (reservation.tableId) {
    try {
      const tableRes = await fetch(`/api/table/${reservation.tableId}`);
      if (tableRes.ok) {
        const table = await tableRes.json();
        tableNumber = table.tableNumber || "N/A";
      }
    } catch {}
  }

  const formattedTime = typeof reservation.reservationTime !== 'undefined'
    ? formatHour(reservation.reservationTime)
    : '';

  // Γέμισε το collapse div
  const detailsDiv = document.getElementById(`pendingDetails_${reservationId}`);
  if (detailsDiv) {
    detailsDiv.innerHTML = `
      <div class="card card-body mt-2 mb-2">
        <p><strong>Name:</strong> ${reservation.name || "N/A"}</p>
        <p><strong>Surname:</strong> ${reservation.surname || "N/A"}</p>
        <p><strong>Table Number:</strong> 
          <span class="table-number">${reservation.tableId ? tableNumber : `
            <span class="text-danger" title="This reservation does not have a table assigned">
              N/A <i class="bi bi-exclamation-circle-fill"></i>
            </span>`}
          </span>
        </p>
        <p><strong>Date:</strong> ${reservation.reservationDate ? new Date(reservation.reservationDate).toLocaleDateString() : "N/A"}</p>
        <p><strong>Hour:</strong> ${formattedTime}</p>
        <p><strong>Seats:</strong> ${reservation.seats || "N/A"}</p>
        <p><strong>State:</strong> ${reservation.state}</p>
        <p><strong>Comment:</strong> ${reservation.commentFromUser || "N/A"}</p>
        <button class="btn btn-success btn-sm" onclick="acceptReservation('${reservation._id}', true)">Accept</button>
        <button class="btn btn-danger btn-sm" onclick="deleteReservation('${reservation._id}', true)">Delete</button>
        ${!reservation.tableId ? `<button class="btn btn-primary btn-sm find-table-btn" onclick="findAndAssignTable('${reservation._id}', '${reservation.reservationDate}', '${reservation.reservationTime}', ${reservation.seats}, true)">Find Table</button>` : ''}
        <button class="btn btn-secondary btn-sm" onclick="closePendingReservationDetails('${reservation._id}')">Hide</button>
      </div>
    `;
    // Άνοιξε το collapse
    detailsDiv.classList.add('show');
  }
}

function formatHour(hour) {
  if (typeof hour !== "number") hour = parseFloat(hour);
  if (isNaN(hour)) return "-";
  const h = Math.floor(hour);
  const m = Math.round((hour - h) * 60);
  return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}`;
}

function closePendingReservationDetails(reservationId) {
  const detailsDiv = document.getElementById(`pendingDetails_${reservationId}`);
  if (detailsDiv) detailsDiv.classList.remove('show');
}

function onTabClick(state) {
    currentStateFilter = state;
    fetchReservations(currentStateFilter);
}

// Μετά το fetchReservations ή στο τέλος του αρχείου
document.addEventListener('DOMContentLoaded', () => {
  fetchAndRenderFloorPanels();
});

// Κάνε fetch τα floorPanels και εμφάνισέ τα ακριβώς όπως στο floorPanel (χωρίς λειτουργίες)
async function fetchAndRenderFloorPanels() {
  const container = document.getElementById('floorPanelsContainer');
  try {
    // Πάρε το shopId από το backend (όπως στις άλλες shopOwner σελίδες)
    const userRes = await fetch('/api/users/details', { credentials: 'include' });
    if (!userRes.ok) throw new Error('Failed to fetch user details');
    const userData = await userRes.json();
    const shopId = userData?.user?.shopId;
    if (!shopId) {
      container.innerHTML = `<div class="alert alert-warning">No shop selected.</div>`;
      return;
    }

    const response = await fetch(`/api/shop/${shopId}/floorPanels`, { credentials: 'include' });
    if (!response.ok) throw new Error('Failed to fetch floor panels');
    const panels = await response.json();

    if (!Array.isArray(panels) || panels.length === 0) {
      container.innerHTML = `<div class="alert alert-info">No floor panels found.</div>`;
      return;
    }

    container.innerHTML = panels.map(panel => renderFloorPanelLikeEditor(panel)).join('');
  } catch (err) {
    if (container) container.innerHTML = `<div class="alert alert-danger">Error loading floor panels.</div>`;
    console.error(err);
  }
}

// Απόδοση floorPanel όπως στο floorPanel editor (χωρίς λειτουργίες)
function renderFloorPanelLikeEditor(panel) {
  const width = panel.width || 1000;
  const height = panel.height || 700;
  const bg = panel.backgroundPhoto
    ? `<image href="${panel.backgroundPhoto}" width="${width}" height="${height}" />`
    : `<rect width="${width}" height="${height}" fill="${panel.background || '#f8f9fa'}" />`;

  const tablesSvg = Array.isArray(panel.tables)
    ? panel.tables.map(t => {
        let tableNumber = '';
        let tableId = t.tableId && typeof t.tableId === 'object' && t.tableId._id ? t.tableId._id : t.tableId;
        if (t.tableNumber) {
          tableNumber = t.tableNumber;
        } else if (t.tableId && typeof t.tableId === 'object' && t.tableId.tableNumber) {
          tableNumber = t.tableId.tableNumber;
        } else if (typeof t.tableId === 'string') {
          tableNumber = t.tableId;
        }
        // Επιλογή χρώματος περιγράμματος
        let strokeColor = "#333";
        if (selectedSlotMinutes !== null && tableAvailabilityMap && tableId) {
          const status = tableAvailabilityMap[tableId];
          if (status === "available") strokeColor = "#28a745"; // πράσινο
          else if (status === "reserved") strokeColor = "#000"; // μαύρο
          else if (status === "unavailable") strokeColor = "#dc3545"; // κόκκινο
        }
        return `
        <g transform="translate(${t.x || 0},${t.y || 0}) rotate(${t.rotation || 0})">
          <rect x="-30" y="-30" width="60" height="60" rx="10" fill="${panel.color || '#e3e3e3'}" stroke="${strokeColor}" stroke-width="4"/>
          <text x="0" y="8" text-anchor="middle" font-size="22" fill="#333" font-family="Arial">${tableNumber}</text>
        </g>`;
      }).join('')
    : '';

  return `
    <div class="floor-panel-card border rounded p-2 mb-3" style="background:#fff;min-width:420px;max-width:480px;flex:1 1 30%;">
      <div class="fw-bold mb-2">${panel.name || 'Floor Panel'}</div>
      <div style="overflow:auto;">
        <svg width="420" height="300" viewBox="0 0 ${width} ${height}" style="background:#fafbfc;border-radius:8px;">
          ${bg}
          ${tablesSvg}
        </svg>
      </div>
    </div>
  `;
}

let selectedFloorPanelDate = new Date().toISOString().split('T')[0];
let bookingSettings = null;
let shopId = null;
let selectedSlotMinutes = null;
let tableAvailabilityMap = {};

// Βρες το shopId όπως στα άλλα shopOwner αρχεία
async function getShopId() {
  const userRes = await fetch('/api/users/details', { credentials: 'include' });
  if (!userRes.ok) return null;
  const userData = await userRes.json();
  return userData?.user?.shopId || null;
}

// Ρώτα το backend για τα booking settings της μέρας
async function fetchBookingSettingsForDate(shopId, date) {
  const res = await fetch(`/api/shop/${shopId}/bookingSettings?date=${date}`, { credentials: 'include' });
  if (!res.ok) return null;
  return await res.json();
}

// Απόδοση του datepicker και των ωρών πάνω από τα floor panels
async function renderFloorPanelDateAndSlots() {
  const section = document.getElementById('floorPanelsSection');
  if (!section) return;

  // Υπολογισμός ημέρας εβδομάδας για την επιλεγμένη ημερομηνία
  function getDayOfWeekLabel(dateStr) {
    const daysGR = ["Κυριακή", "Δευτέρα", "Τρίτη", "Τετάρτη", "Πέμπτη", "Παρασκευή", "Σάββατο"];
    const d = new Date(dateStr);
    return daysGR[d.getDay()];
  }

  let datePickerDiv = document.getElementById('floorPanelDatePicker');
  if (!datePickerDiv) {
    datePickerDiv = document.createElement('div');
    datePickerDiv.id = 'floorPanelDatePicker';
    datePickerDiv.className = 'mb-2';
    section.insertBefore(datePickerDiv, section.querySelector('h4').nextSibling);
  }
  datePickerDiv.innerHTML = `
    <label for="floorPanelDateInput" class="form-label me-2 mb-0" style="font-weight:500;">Ημερομηνία:</label>
    <input id="floorPanelDateInput" type="date" class="form-control d-inline-block me-2" style="max-width:180px;display:inline-block;" value="${selectedFloorPanelDate}" />
    <span id="floorPanelDayOfWeek" class="align-middle" style="font-weight:500;">${getDayOfWeekLabel(selectedFloorPanelDate)}</span>
  `;

  document.getElementById('floorPanelDateInput').addEventListener('change', async function() {
    selectedFloorPanelDate = this.value;
    // Ενημέρωσε το label ημέρας
    document.getElementById('floorPanelDayOfWeek').textContent = getDayOfWeekLabel(selectedFloorPanelDate);
    await updateBookingSlots();
  });

  // Slots bar
  let slotsDiv = document.getElementById('floorPanelSlotsBar');
  if (!slotsDiv) {
    slotsDiv = document.createElement('div');
    slotsDiv.id = 'floorPanelSlotsBar';
    section.insertBefore(slotsDiv, document.getElementById('floorPanelsContainer'));
  }
  await updateBookingSlots();
}

async function updateBookingSlots() {
  const slotsDiv = document.getElementById('floorPanelSlotsBar');
  if (!shopId || !selectedFloorPanelDate) {
    slotsDiv.innerHTML = "";
    return;
  }
  bookingSettings = await fetchBookingSettingsForDate(shopId, selectedFloorPanelDate);

  if (!bookingSettings || bookingSettings.bookingStart == null || bookingSettings.bookingEnd == null || !bookingSettings.timeSlotSplit) {
    slotsDiv.innerHTML = `<div class="alert alert-warning">Δεν υπάρχουν διαθέσιμες ώρες για αυτή τη μέρα.</div>`;
    return;
  }

  const slots = [];
  let currentMinutes = Math.round(parseFloat(bookingSettings.bookingStart) * 60);
  const endMinutes = Math.round(parseFloat(bookingSettings.bookingEnd) * 60);
  const splitMinutes = parseInt(bookingSettings.timeSlotSplit, 10);

  while (currentMinutes < endMinutes) {
    slots.push(currentMinutes);
    currentMinutes += splitMinutes;
  }

  function formatHour(minutes) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}`;
  }

  slotsDiv.innerHTML = `
    <div class="d-flex flex-row align-items-center gap-2 mb-3" style="overflow-x:auto;">
      <span class="fw-bold text-primary" style="min-width:90px;">Booking Start</span>
      ${slots.map(minutes => `
        <button
          class="border rounded px-3 py-2 bg-light text-center ${selectedSlotMinutes === minutes ? 'border-primary border-3' : ''}"
          style="min-width:70px; cursor:pointer;"
          onclick="onSlotClick(${minutes})"
        >${formatHour(minutes)}</button>
      `).join('')}
      <span class="fw-bold text-primary" style="min-width:90px;">Booking End</span>
    </div>
  `;
}

// Κάνε global τη συνάρτηση για να δουλεύει το onclick
window.onSlotClick = async function(minutes) {
  selectedSlotMinutes = minutes;
  // Fetch availability για το slot
  const hour = Math.floor(minutes / 60).toString().padStart(2, "0");
  const min = (minutes % 60).toString().padStart(2, "0");
  const timeStr = `${hour}:${min}`;
  const res = await fetch(`/api/shop/${shopId}/table-availability?date=${selectedFloorPanelDate}&time=${timeStr}`);
  if (res.ok) {
    const data = await res.json();
    // Δημιούργησε map: tableId -> status
    tableAvailabilityMap = {};
    data.forEach(t => {
      tableAvailabilityMap[t.tableId] = t.status;
    });
  } else {
    tableAvailabilityMap = {};
  }
  // Επαν-απόδωσε τα floor panels για να ενημερωθούν τα χρώματα
  fetchAndRenderFloorPanels();
  // Επαν-απόδωσε τα slots για να δείχνει το επιλεγμένο
  await updateBookingSlots();
};

document.addEventListener('DOMContentLoaded', async () => {
  // Βρες το shopId πριν καλέσεις τα panels/slots
  shopId = await getShopId();
  await renderFloorPanelDateAndSlots();
  fetchAndRenderFloorPanels();
});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</body>
</html>