<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile</title>
  <link rel="stylesheet" href="styles/customer.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(120deg, #181824 0%, #23233a 100%);
      color: #f3f3f3;
      min-height: 100vh;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 0;
      pointer-events: none;
      background: radial-gradient(ellipse at 60% 20%, rgba(255,110,196,0.10) 0, transparent 60%),
                  radial-gradient(ellipse at 20% 80%, rgba(120,115,245,0.10) 0, transparent 70%);
      animation: bgmove 12s linear infinite alternate;
    }
    @keyframes bgmove {
      0% { background-position: 60% 20%, 20% 80%; }
      100% { background-position: 70% 30%, 10% 90%; }
    }
    .hero-profile {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 44vh;
      background: url('index/img.jpg') no-repeat center center/cover;
      position: relative;
      text-align: center;
      border-radius: 0 0 32px 32px;
      box-shadow: 0 8px 32px rgba(120,115,245,0.13);
      overflow: hidden;
    }
    .hero-overlay {
      position: absolute;
      inset: 0;
      background: rgba(27,26,26,0.68);
      z-index: 1;
      backdrop-filter: blur(4px);
    }
    .hero-content {
      position: relative;
      z-index: 2;
      padding: 32px 20px 20px 20px;
      max-width: 800px;
      text-align: center;
      color: #fff;
    }
    .hero-content h1 {
      font-size: 2.7rem;
      font-weight: 800;
      margin-bottom: 15px;
      color: #ff6ec4;
      text-shadow: 0 2px 12px rgba(120,115,245,0.13);
    }
    .hero-content p {
      font-size: 1.1rem;
      margin-bottom: 22px;
      color: #f3f3f3;
      opacity: 0.92;
    }
    .btn-primary,
    .edit-profile-btn,
    .filter-btn {
      background: linear-gradient(135deg, #ff6ec4, #7873f5);
      border: none;
      padding: 12px 28px;
      font-size: 1.08rem;
      font-weight: 700;
      border-radius: 30px;
      transition: 0.3s cubic-bezier(.4,2,.6,1);
      color: #fff;
      box-shadow: 0 4px 18px rgba(255,110,196,0.13);
      letter-spacing: 0.5px;
    }
    .btn-primary:hover,
    .edit-profile-btn:hover,
    .filter-btn:hover {
      background: linear-gradient(135deg, #7873f5, #ff6ec4);
      transform: scale(1.06);
    }
    .profile-container,
    .reservation-history,
    .favourite-shops,
    .user-reviews {
      background: rgba(40,38,60,0.22);
      border-radius: 22px;
      padding: 48px 24px 32px 24px;
      margin-top: 48px;
      box-shadow: 0 4px 24px rgba(255,110,196,0.13);
      text-align: left;
      position: relative;
      z-index: 2;
    }
    .profile-header,
    .reservation-header,
    #favouritesHeader,
    #reviewsHeader {
      font-size: 2rem;
      font-weight: 800;
      text-align: center;
      color: #ff6ec4;
      margin-bottom: 28px;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 12px rgba(120,115,245,0.13);
    }
    .profile-item {
      font-size: 1.08rem;
      margin-bottom: 14px;
      color: #f3f3f3;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .profile-item strong {
      color: #ff6ec4;
      font-weight: 700;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .profile-item strong::before {
      content: '\f007';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-right: 6px;
      color: #7873f5;
    }
    .profile-item strong[for="userSurname"]::before { content: '\f2bb'; }
    .profile-item strong[for="userEmail"]::before { content: '\f0e0'; }
    .reservation-card {
      background: rgba(255,255,255,0.97);
      color: #23233a;
      border-radius: 14px;
      padding: 22px;
      box-shadow: 0 6px 18px rgba(255,110,196,0.13);
      transition: all 0.3s cubic-bezier(.4,2,.6,1);
      height: 100%;
      position: relative;
      z-index: 1;
    }
    .reservation-card:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 10px 28px rgba(255,110,196,0.18);
    }
    .reservation-card h5 {
      font-size: 1.2rem;
      font-weight: bold;
      color: #6a11cb;
      margin-bottom: 15px;
      word-break: break-word;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .reservation-card p {
      font-size: 1.01rem;
      margin-bottom: 8px;
      color: #23233a;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge-status {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 30px;
      font-size: 0.85rem;
      text-transform: capitalize;
      font-weight: 700;
      background: #eee;
      color: #555;
      box-shadow: 0 2px 8px rgba(255,110,196,0.10);
    }
    .badge-status.pending { background: #ffc107; color: #fff; }
    .badge-status.accepted { background: #17a2b8; color: #fff; }
    .badge-status.completed { background: #28a745; color: #fff; }
    .badge-status.notShown { background: #dc3545; color: #fff; }
    .comment {
      margin-top: 15px;
      font-size: 0.95rem;
      color: #666;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 10px;
      border-left: 4px solid #ff6ec4;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .favourite-shops {
      background: rgba(40,38,60,0.22);
      border-radius: 22px;
      padding: 36px 18px 24px 18px;
      margin-top: 48px;
      box-shadow: 0 4px 24px rgba(255,110,196,0.13);
    }
    .scrollable-row {
      display: flex;
      gap: 1.2rem;
      overflow-x: auto;
      padding: 10px 0;
    }
    .scrollable-row::-webkit-scrollbar {
      height: 8px;
    }
    .scrollable-row::-webkit-scrollbar-thumb {
      background: #ff6ec4;
      border-radius: 10px;
    }
    .scrollable-row::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }
    .favourite-card {
      min-width: 220px;
      max-width: 220px;
      background: rgba(40,38,60,0.28);
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(255,110,196,0.13);
      overflow: hidden;
      text-align: center;
      position: relative;
      color: #f3f3f3;
      border: 2px solid #ff6ec4;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .favourite-card:hover {
      box-shadow: 0 6px 24px rgba(255,110,196,0.18);
      transform: translateY(-4px) scale(1.03);
    }
    .favourite-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 14px 14px 0 0;
      border-bottom: 2px solid #ff6ec4;
    }
    .favourite-card .card-body {
      padding: 12px 8px 8px 8px;
    }
    .favourite-card .card-title {
      font-size: 1.08rem;
      font-weight: 700;
      color: #ff6ec4;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .favourite-card .card-title::before {
      content: '\f005';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #ff6ec4;
      margin-right: 4px;
    }
    .favourite-card .card-text {
      font-size: 0.95rem;
      color: #fff;
      margin-bottom: 10px;
      text-shadow: 0 1px 8px rgba(40,38,60,0.18);
    }
    .favourite-card .btn-view-details {
      background: linear-gradient(135deg, #ff6ec4, #7873f5);
      color: #fff;
      font-size: 0.95rem;
      padding: 7px 16px;
      border-radius: 20px;
      text-decoration: none;
      transition: background 0.3s, transform 0.2s;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(255,110,196,0.10);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .favourite-card .btn-view-details::before {
      content: '\f06e';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-right: 4px;
    }
    .favourite-card .btn-view-details:hover {
      background: linear-gradient(135deg, #7873f5, #ff6ec4);
      transform: scale(1.04);
    }
    .favourite-card .btn-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ff3e9e;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(255,110,196,0.10);
    }
    .favourite-card .btn-remove:hover {
      background: #ff1e7e;
    }
    .user-reviews .card {
      background: rgba(255,255,255,0.97);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(255,110,196,0.10);
      padding: 18px;
      color: #23233a;
    }
    .user-reviews .card-title {
      font-size: 1.08rem;
      font-weight: bold;
      color: #6a11cb;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .user-reviews .card-title::before {
      content: '\f005';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #ff6ec4;
      margin-right: 4px;
    }
    .user-reviews .card-text {
      font-size: 0.97rem;
      color: #555;
    }
    .user-reviews .text-muted {
      font-size: 0.85rem;
      color: #888;
    }
    footer {
      background: rgba(30, 30, 40, 0.85);
      color: #fff;
      text-align: center;
      padding: 18px 0 12px 0;
      margin-top: 60px;
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -2px 12px rgba(255,110,196,0.10);
      font-size: 1.01rem;
      letter-spacing: 0.2px;
    }
    .total-reservations-card {
      background: linear-gradient(135deg, #ff6ec4 0%, #7873f5 100%);
      color: #fff;
      border-radius: 22px;
      box-shadow: 0 4px 24px rgba(255,110,196,0.18);
      padding: 32px 18px 22px 18px;
      margin-bottom: 18px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 140px;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .total-reservations-card:hover {
      box-shadow: 0 8px 32px rgba(120,115,245,0.22);
      transform: scale(1.03);
    }
    .total-reservations-card .icon-bg {
      font-size: 2.6rem;
      background: rgba(255,255,255,0.13);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      color: #fff;
      box-shadow: 0 2px 12px rgba(120,115,245,0.13);
    }
    .total-reservations-card .total-label {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      color: #fff;
      opacity: 0.92;
    }
    .total-reservations-card .total-count {
      font-size: 2.3rem;
      font-weight: 900;
      color: #fff;
      text-shadow: 0 2px 12px rgba(120,115,245,0.13);
    }
    .section-divider {
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #ff6ec4 40%, #7873f5 60%, transparent);
      margin: 48px 0 32px 0;
      border-radius: 2px;
      opacity: 0.18;
    }
    .filter-btn.all-btn {
      background: linear-gradient(135deg, #7873f5, #ff6ec4);
      color: #fff;
      font-weight: 700;
      border: 2px solid #fff;
      margin-left: 8px;
    }
    .filter-btn.all-btn:hover {
      background: linear-gradient(135deg, #ff6ec4, #7873f5);
      color: #fff;
      border: 2px solid #fff;
    }
    @media (max-width: 768px) {
      .total-reservations-card {
        padding: 22px 8px 14px 8px;
        min-height: 100px;
      }
      .section-divider {
        margin: 32px 0 18px 0;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-lg" id="navbar" style="background: rgba(30, 30, 40, 0.92); backdrop-filter: blur(10px); box-shadow: 0 4px 18px rgba(255,110,196,0.13); border-radius: 0 0 24px 24px;">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html" style="font-weight:bold;font-size:1.5rem;color:#fff;">
        <i class="bi bi-shop"></i> MyShop
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#profileNavbarNav" aria-controls="profileNavbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="profileNavbarNav">
        <ul class="navbar-nav ms-auto gap-2">
          <li class="nav-item">
            <a class="nav-link active" href="#profileSection" onclick="scrollToSection('profileSection')"><i class="bi bi-person-circle"></i> Profile</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#reservationHistoryWrapper" onclick="scrollToSection('reservationHistoryWrapper')"><i class="bi bi-calendar-check"></i> Reservations</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#favouriteShopsContainer" onclick="scrollToSection('favouriteShopsContainer')"><i class="bi bi-heart-fill"></i> Favourites</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#userReviewsList" onclick="scrollToSection('userReviewsList')"><i class="bi bi-star-fill"></i> Reviews</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="index.html"><i class="bi bi-house-door"></i> Home</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <script>
    function scrollToSection(id) {
      const el = document.getElementById(id);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
  </script>

  <!-- Hero Section -->
  <section class="hero-profile" role="banner">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1>Welcome, <span id="userGreetingName">Loading...</span></h1>
      <p>Your profile and reservation history are displayed below.</p>
      <button id="logoutBtn" class="btn btn-primary">Logout</button>
    </div>
  </section>

  <!-- Profile Section -->
  <section class="container profile-container" aria-labelledby="profileHeader">
    <h2 id="profileHeader" class="text-center mb-4">Your Details</h2>
    <div id="profileSection">
        <p class="profile-item"><strong>Name:</strong> <span id="userName">Loading...</span></p>
        <p class="profile-item"><strong>Surname:</strong> <span id="userSurname">Loading...</span></p>
        <p class="profile-item"><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
    </div>
    <div class="text-center mt-3 mb-4">
        <button id="editProfileBtn" class="btn btn-primary">Edit Profile</button>
    </div>
    <!-- Total Reservations Card -->
    <div class="row justify-content-center mb-2">
      <div class="col-12 col-md-6">
        <div class="total-reservations-card text-center">
          <div class="icon-bg"><i class="bi bi-calendar-check"></i></div>
          <div class="total-label">Total Reservations</div>
          <div id="totalReservationsCount" class="total-count">0</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Divider -->
  <div class="section-divider"></div>

  <!-- Reservation History Section -->
  <section class="container reservation-history" aria-labelledby="historyHeader">
  <h2 id="historyHeader" class="text-center">Reservation History</h2>
  <div class="text-center mb-3">
    <button class="filter-btn" onclick="filterReservations('pending')">Pending</button>
    <button class="filter-btn" onclick="filterReservations('accepted')">Active</button>
    <button class="filter-btn" onclick="filterReservations('completed')">Completed</button>
    <button class="filter-btn" onclick="filterReservations('notShown')">Not Shown</button>
    <button class="filter-btn all-btn" onclick="filterReservations('all')">All</button>
  </div>
  <div id="reservationHistoryWrapper" class="history-wrapper">
    <div id="reservationHistory" class="row g-3">
      <!-- reservations injected here -->
    </div>
  </div>
  
</section>

  <!-- Section Divider -->
  <div class="section-divider"></div>

  <section class="container favourite-shops" aria-labelledby="favouritesHeader">
    <h2 id="favouritesHeader" class="text-center">Favourite Shops</h2>
    <div id="favouriteShopsContainer" class="scrollable-row d-flex overflow-auto">
        <!-- Favourite shop cards will be dynamically inserted here -->
    </div>
</section>

  <!-- Section Divider -->
  <div class="section-divider"></div>

  <!-- Reviews Section -->
<section class="container user-reviews" aria-labelledby="reviewsHeader">
  <h2 id="reviewsHeader" class="text-center">My Reviews</h2>
  <div class="text-center">
    <button id="fetchReviewsBtn" class="btn btn-primary">Δες τις αξιολογήσεις σου</button>
  </div>
  <div id="userReviewsList" class="mt-4">
    <!-- Reviews will be dynamically injected here -->
  </div>
</section>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 MyShop. All rights reserved.</p>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script -->
  <script type="module">
    import { handleLogout, updateNavbarOnLogin, applyNavbarStateFromSession } from './authUtils.js';

    let allReservations = [];

    async function initializeUser() {
        try {
            // Κλήση στο endpoint `/api/user/details` απευθείας με fetch
            const response = await fetch('/api/users/details', {
                method: 'GET',
                credentials: 'include', // Περιλαμβάνει cookies για αυθεντικοποίηση
            });

            if (!response.ok) {
                throw new Error('Failed to fetch user details');
            }

            const userDetails = await response.json();
            console.log('User Details:', userDetails); // Debugging

            if (!userDetails || !userDetails.isAuthenticated) {
                alert('You are not logged in. Redirecting to login page.');
                window.location.href = 'registerLogin.html';
                return;
            }

            // Ενημέρωση των στοιχείων του χρήστη στη σελίδα
            const user = userDetails.user; // Πρόσβαση στο αντικείμενο `user`
            document.getElementById('userGreetingName').textContent = `${user.name || 'N/A'} ${user.surname || 'N/A'}`;
            document.getElementById('userName').textContent = user.name || 'N/A';
            document.getElementById('userSurname').textContent = user.surname || 'N/A';
            document.getElementById('userEmail').textContent = user.email || 'N/A';

            // Κλήση για το ιστορικό κρατήσεων
            await fetchReservationHistory();
        } catch (error) {
            console.error('Error initializing user:', error);
            alert('An error occurred. Redirecting to login page.');
            window.location.href = 'registerLogin.html';
        }
    }

    async function fetchReservationHistory(stateFilter = 'pending') {
  try {
    // Λήψη όλων των κρατήσεων του χρήστη
    const response = await fetch('/api/user/reservationHistory', {
      method: 'GET',
      credentials: 'include', // Περιλαμβάνει cookies για αυθεντικοποίηση
    });

    if (!response.ok) {
      throw new Error('Failed to fetch reservation history');
    }

    const { reservationHistory } = await response.json();

    // Store all reservations for total count
    allReservations = reservationHistory || [];
    document.getElementById('totalReservationsCount').textContent = allReservations.length;

    if (!reservationHistory || reservationHistory.length === 0) {
      document.getElementById('reservationHistory').innerHTML = '<p class="text-warning">No reservations found.</p>';
      return;
    }

    // Φιλτράρισμα κρατήσεων με βάση το state
    const filteredReservations = reservationHistory.filter(reservation => 
      stateFilter === 'all' || reservation.state === stateFilter
    );

    // Εμφάνιση των φιλτραρισμένων κρατήσεων
    displayReservations(filteredReservations);
  } catch (error) {
    console.error('Error fetching reservation history:', error);
    document.getElementById('reservationHistory').innerHTML = '<p class="text-danger">Failed to load reservation history.</p>';
  }
}

function displayReservations(reservations) {
  const historyContainer = document.getElementById('reservationHistory');
  historyContainer.innerHTML = '';

  const fragment = document.createDocumentFragment(); // better for performance

  reservations.forEach(reservation => {
    const hours = Math.floor(reservation.reservationTime);
    const minutes = Math.round((reservation.reservationTime % 1) * 60);
    const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

    const col = document.createElement('div');
    col.className = 'col-12 col-md-6 col-lg-4';

    col.innerHTML = `
  <div class="reservation-card h-100 d-flex flex-column justify-content-between">
    <div>
      <h5><i class="bi bi-receipt-cutoff me-2"></i> Reservation #${reservation._id.slice(-6)}</h5>
      <p><i class="bi bi-shop me-2"></i><strong>Shop:</strong> ${reservation.shopName || 'N/A'}</p>
      <p><i class="bi bi-calendar-event me-2"></i><strong>Date:</strong> ${new Date(reservation.reservationDate).toLocaleDateString()}</p>
      <p><i class="bi bi-clock me-2"></i><strong>Time:</strong> ${formattedTime}</p>
      <p><i class="bi bi-people-fill me-2"></i><strong>Seats:</strong> ${reservation.seats || 'N/A'}</p>
      <p><i class="bi bi-info-circle me-2"></i><strong>Status:</strong> <span class="badge-status ${reservation.state.toLowerCase()}">${reservation.state}</span></p>
    </div>
    ${reservation.commentFromUser ? `<div class="comment"><i class="bi bi-chat-left-text me-2"></i> ${reservation.commentFromUser}</div>` : ''}
  </div>
`;


    fragment.appendChild(col);
  });

  historyContainer.appendChild(fragment);
}


    async function removeFromFavourites(shopId) {
        try {
            const response = await fetch('/api/users/favourites', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ shopId }),
                credentials: 'include', // Περιλαμβάνει cookies για αυθεντικοποίηση
            });

            if (!response.ok) {
                const error = await response.json();
                alert(`Σφάλμα: ${error.message}`);
                return;
            }

            alert('Το κατάστημα αφαιρέθηκε από τα αγαπημένα σας!');
            await fetchFavouriteShops(); // Επαναφόρτωση της λίστας αγαπημένων
        } catch (error) {
            console.error('Error removing from favourites:', error);
            alert('Σφάλμα κατά την αφαίρεση από τα αγαπημένα. Παρακαλώ δοκιμάστε ξανά.');
        }
    }

    async function fetchFavouriteShops() {
        try {
            const response = await fetch('/api/users/favourites', {
                method: 'GET',
                credentials: 'include', // Περιλαμβάνει cookies για αυθεντικοποίηση
            });

            if (!response.ok) {
                throw new Error('Failed to fetch favourite shops');
            }

            const { favouriteShops } = await response.json();
            console.log('Favourite Shops:', favouriteShops);

            const container = document.getElementById('favouriteShopsContainer');
            container.innerHTML = '';

            if (!favouriteShops || favouriteShops.length === 0) {
                container.innerHTML = '<p class="text-warning">Δεν έχετε προσθέσει αγαπημένα καταστήματα.</p>';
                return;
            }

            favouriteShops.forEach(shop => {
                const card = document.createElement('div');
                card.className = 'favourite-card';

                const imageUrl = shop.image || (shop.images && shop.images.length > 0 ? shop.images[0] : '/images/default-placeholder.jpg');

                card.innerHTML = `
                    <img src="${imageUrl}" alt="${shop.shopName}">
                    <div class="card-body">
                        <h5 class="card-title">${shop.shopName}</h5>
                        <p class="card-text">${shop.address || 'No description available.'}</p>
                        <a href="shop.html?id=${shop._id}" class="btn-view-details">View Details</a>
                    </div>
                    <button class="btn-remove" onclick="removeFromFavourites('${shop._id}')">-</button>
                `;

                container.appendChild(card);
            });
        } catch (error) {
            console.error('Error fetching favourite shops:', error);
            const container = document.getElementById('favouriteShopsContainer');
            container.innerHTML = '<p class="text-danger">Αποτυχία φόρτωσης αγαπημένων καταστημάτων.</p>';
        }
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            await handleLogout();
            alert('You have been logged out.');
            window.location.href = 'registerLogin.html';
        } catch (error) {
            console.error('Error during logout:', error);
            alert('An error occurred while logging out. Please try again.');
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
  try {
    // Ενημέρωση του navbar
    const navbarState = sessionStorage.getItem('navbarState');
    if (navbarState) {
      applyNavbarStateFromSession();
    } else {
      await updateNavbarOnLogin();
    }

    // Αρχικοποίηση του χρήστη
    await initializeUser();

    // Φόρτωση των `pending` κρατήσεων κατά την αρχική φόρτωση
    await fetchReservationHistory('pending');

    // Φόρτωση αγαπημένων καταστημάτων
    await fetchFavouriteShops();
  } catch (error) {
    console.error('Error during page initialization:', error);
  }
});

    function filterReservations(state) {
  fetchReservationHistory(state);
}

// Κάνε τη συνάρτηση διαθέσιμη στο global scope
window.filterReservations = filterReservations;

    window.removeFromFavourites = removeFromFavourites;

async function fetchUserReviews() {
  try {
    const response = await fetch('/api/user/reviews', { credentials: 'include' });

    if (!response.ok) {
      throw new Error('Failed to fetch user reviews');
    }

    const data = await response.json();
    const reviewsList = document.getElementById('userReviewsList');

    if (!data.reviews || data.reviews.length === 0) {
      reviewsList.innerHTML = '<p class="text-warning">Δεν έχετε υποβάλει ακόμα αξιολογήσεις.</p>';
      return;
    }

    reviewsList.innerHTML = data.reviews
      .map(
        (review) => `
          <div class="card mb-3">
            <div class="card-body">
              <h6 class="card-title">Αξιολόγηση: ${review.rating} / 5</h6>
              <p class="card-text">${review.text}</p>
              <p class="text-muted small">Για το μαγαζί: ${review.shopId?.name || 'Άγνωστο'}</p>
            </div>
          </div>
        `
      )
      .join('');
  } catch (error) {
    console.error('Error fetching user reviews:', error);
    const reviewsList = document.getElementById('userReviewsList');
    reviewsList.innerHTML = '<p class="text-danger">Αποτυχία φόρτωσης αξιολογήσεων. Παρακαλώ δοκιμάστε ξανά αργότερα.</p>';
  }
}

document.getElementById('fetchReviewsBtn').addEventListener('click', fetchUserReviews);
  </script>
</body>
</html>